C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ZNFAT
OBJECT MODULE PLACED IN znFAT.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE znFAT\znFAT.c LARGE OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\
                    -znFAT.lst) OBJECT(znFAT.obj)

line level    source

   1          #include "znfat.h"
   2          #include "template.h"
   3          #include "gb2uni.h"
   4          #include "deviceio.h"
   5          
   6          //===================================================================================/
   7          /*----------------------------------------------------------------------------/
   8          /  Here is znFAT -- a complete FAT32 FileSystem Solution  ver 11.21   
   9          /-----------------------------------------------------------------------------/
  10          / znFAT is a complete FAT FileSystem Code Module for embeded system platform.
  11          / znFAT is Developped and Coded By ZN China who own the full copyright on it.
  12          / You are allowed to use it for study,research,and commerce purpose,to modify
  13          / the code and publish it freely.
  14          / znFAT is pleasure to be recommended to more E-amateur and Engineer.Thanks!!
  15          /  
  16          /              Copyright (C) 2010, ZN, all right reserved.
  17          /
  18          /               Technology Support http://www.znfat.com
  19          /                  Welcome to ZN's FAT32 FS World!!
  20          /-----------------------------------------------------------------------------/
  21          
  22          /-----------------------------------------------------------------------------/
  23          Function Table(¹¦ÄÜº¯Êı±í): 
  24           znFAT_Device_Init  : Storage device initialize (´æ´¢Éè±¸³õÊ¼»¯)
  25           znFAT_Init         : File system initialize (ÎÄ¼şÏµÍ³³õÊ¼»¯)
  26           znFAT_Select_Device: Select storage device (Ñ¡Ôñ´æ´¢Éè±¸)
  27           znFAT_Open_File    : Open a file (´ò¿ªÎÄ¼ş)
  28           znFAT_ReadData     : Read data in a file (¶ÁÈ¡ÎÄ¼şÊı¾İ)
  29           znFAT_ReadDataX    : Read data and redirect it (¶ÁÈ¡ÎÄ¼şÊı¾İ+Êı¾İÖØ¶¨Ïò)
  30           znFAT_Enter_Dir    : Enter a dir (½øÈëÄ¿Â¼)
  31           znFAT_WriteData    : Write data to a file,append it to the end (ÏòÎÄ¼şĞ´ÈëÊı¾İ)
  32           znFAT_Modify_Data  : Modify data in a file (ĞŞ¸ÄÎÄ¼şÊı¾İ)
  33           znFAT_Dump_Data    : Dump data of a file (¶ªÆú£¬½Ø¶ÏÎÄ¼şÊı¾İ)
  34           znFAT_Create_File  : Create file (´´½¨ÎÄ¼ş)
  35           znFAT_Create_Dir   : Create dir (´´½¨Ä¿Â¼)
  36           znFAT_Delete_File  : Delete file (É¾³ıÎÄ¼ş)
  37           znFAT_Delete_Dir   : Delete dir (É¾³ıÄ¿Â¼)
  38           znFAT_Make_FS      : Make a FAT32 FS on a storage device,even Format (¸ñÊ½»¯)
  39           znFAT_Close_File   : Close file (¹Ø±ÕÎÄ¼ş)
  40           znFAT_Flush_FS     : Flush FS,Update FS information from RAM to Disk (Ë¢ĞÂFS)
  41          /----------------------------------------------------------------------------/
  42          Configuration for znFAT's Functions,is necessary before the usage of them.
  43                  (¶ÔznFATÖĞ¹¦ÄÜº¯ÊıµÄÅäÖÃ£¬ÔÚÊ¹ÓÃËüÃÇÖ®Ç°ÇëÎñ±Ø¶ÔÆä½øĞĞÅäÖÃ)
  44          
  45          When you use a function in znFAT(but znFAT_Device_Init znFAT_Init and znFAT_\
  46          Select_Device,because them must be used in every project),you must firstly
  47          OPEN the MACROS as "#define ZNFAT_XXXX",So the relevant code of the function
  48          is added to the compiling.Or,You will get a warning like "XXXX is undefined .."
  49          For example:You now wanna use znFAT_Open_File,You must open the header file
  50          config.h,OPEN the MACRO ZNFAT_OPEN_FILE,even delete the "//" before it.
  51          
  52          (µ±ÄãÒªÊ¹ÓÃznFATÖĞÒ»¸öº¯ÊıÊ±(znFAT_Device_Init znFAT_Init and znFAT_Select_\
  53          DeviceÕâÈı¸öº¯Êı³ıÍâ£¬ÒòÎªËüÃÇÔÚÈÎºÎÊ±ºò¶¼ÊÇ±ØÈ»±»Ê¹ÓÃµÄ)£¬±ØĞëÊ×ÏÈ°ÑÏàÓ¦µÄºê
  54          ´ò¿ª£¬±ÈÈç"#define ZNFAT_XXXX"£¬ÕâÑùÓëÕâ¸öº¯ÊıÏà¹ØµÄ´úÂë²Å»á±»¼ÓÈëµ½±àÒëÖ®ÖĞ£¬
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 2   

  55          ·ñÔò£¬Äã¿ÉÄÜ»áµÃµ½ÏñÕâÑùµÄ¾¯¸æ"XXXX is undefined.."¡£¾ÙÀıËµÃ÷£ºÒªÊ¹ÓÃznFAT_\
  56          Open_Fileº¯Êı£¬Äã±ØĞëÒª´ò¿ªconfig.h£¬´ò¿ªÀïÃæ¶ÔÓ¦µÄºêZNFAT_OPEN_FILE£¬¼´È¥µô
  57          Ç°ÃæµÄ"//"¡£)
  58          
  59          Option for znFAT (znFATÖĞµÄ¹¤×÷·½Ê½Ñ¡Ôñ)
  60          
  61           USE_LFN : Use the Long File Name (Ê¹ÓÃ³¤ÎÄ¼şÃû)
  62            MAX_LFN_LEN : Define the max Long File Name length (¶¨Òå³¤ÎÄ¼şÃû×î´ó³¤¶È)
  63            USE_OEM_CHAR: Use OEM charactor in LFN,as CHN (ÔÚ³¤ÎÄ¼şÃûÖĞÊ¹ÓÃOEM×Ö·û£¬ÈçÖĞÎÄ)
  64           USE_MULTISEC_R : Use hardware continuous Sector Read (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇø¶Á)
  65           USE_MULTISEC_W : Use hardware continuous Sector Write (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇøĞ´)
  66           USE_MULTISEC_CLEAR : Use hardware continuous Sector Clear (Ê¹ÓÃÓ²¼ş¼¶Á¬ĞøÉÈÇøÇå0)
  67           RT_UPDATE_FSINFO : Realtime update the information of FS (ÊµÊ±Ë¢ĞÂÎÄ¼şÏµÍ³ĞÅÏ¢)
  68           RT_UPDATE_FILESIZE : Realtime update the file size (ÊµÊ±¸üĞÂÎÄ¼ş´óĞ¡)
  69           RT_UPDATE_CLUSTER_CHAIN : Realtime update the cluster chain (ÊµÊ±¸üĞÂ´ØÁ´)
  70                                     if not define it ,znFAT will use CCCB algorithm
  71                                                             to store the cluster chain in CCCB buffer 
  72                                                             (Èç¹ûÃ»ÓĞ¶¨ÒåÕâ¸öºê£¬ÔòznFATÔÚÊı¾İ¶ÁĞ´¹ı³ÌÖĞ£¬Ê¹ÓÃ
  73                                                              CCCBËã·¨À´½«´ØÁ´ÁÙÊ±ĞÔµÄ´æ´¢ÔÚRAMµÄ»º³åÇøÖĞ£¬ÕâÑù
  74                                                                  ÊÇÎªÁËÌá¸ßÊı¾İ¶ÁĞ´ËÙÂÊ£¬±×¶ËÔÚÓÚ»º³åÖĞµÄ´ØÁ´²»»Ø
  75                                                                  Ğ´µ½ÎïÀíÉÈÇøÖĞ£¬»áÔì³ÉÊı¾İ¶ªÊ§£¬Òò´ËÒª¼°Ê±»ØĞ´¡£)
  76            CCCB_LEN (XXX) : Define the size of CCCB buffer (¶¨ÒåCCCB »º³åÇø´óĞ¡)
  77            USE_ALONE_CCCB : Use the alone CCCB buffer (Ê¹ÓÃ¶ÀÁ¢CCCB »º³åÇø£¬¼´Ã¿Ò»¸öÎÄ¼ş
  78                                                        ¶¼»á·ÖÅäÒ»¸ö¶ÀÁ¢µÄCCCB»º³åÇø£¬Êı¾İ
  79                                                                                                    ¶ÁĞ´Ê±£¬¸÷ÎÄ¼ş¸÷ÓÃ¸÷×ÔµÄCCCB»º³å£¬
  80                                                                                                    »¥²»¸ÉÉæ¡£)
  81                                     if not define it,use the Shared CCCB buffer
  82                                                                       (Èç¹û´ËºêÃ»ÓĞ¶¨Òå£¬ÔòznFAT»áÊ¹ÓÃ¹²
  83                                                                                                    CCCB »º³åÇø£¬Ö÷ÒªÊÇÎªÁË½ÚÊ¡RAM×Ê
  84                                                                                                    Ô´£¬µ«ÕâÑù±ØÈ»ÕĞÖÂ¶à¸öÎÄ¼ş¶Ô¹²Ïí
  85                                                                                                    CCCB»º³åµÄÇÀ¶á£¬ÔÚÍ¬Ê±²Ù×÷ÎÄ¼ş
  86                                                                                                    ½Ï¶àµÄÊ±ºò£¬Êı¾İ¶ÁĞ´Ğ§ÂÊ²¢²»¸ß¡£)
  87           USE_EXCHANGE_BUFFER : Use the exchange buffer and relevant algorithm (EXB)
  88                                                       (Ê¹ÓÃEXBÉÈÇø½»»»»º³å¼°ÆäËã·¨£¬EXB
  89                                                                                                    »º³åÊÇÎªÁË¼õÉÙÉÈÇøÊı¾İµÄ¶Á-¸Ä-Ğ´
  90                                                                                                    ²Ù×÷´ÎÊı)
  91            USE_ALONE_EXB : Use alone exchange buffer (Ê¹ÓÃ¶ÀÁ¢µÄEXBÉÈÇø½»»»»º³å£¬¼´Ã¿¸ö
  92                                                       ÎÄ¼ş¾ùÓĞ¸÷×Ô¶ÀÁ¢µÄEXB»º³å£¬ÕâÑù×÷
  93                                                                                                   »á¼«´óµÄÔö´óRAM¿ªÏú)
  94                                if no define it,use the Shared exchange buffer
  95                                                                      (Èç¹û´ËºêÃ»ÓĞ¶¨Òå£¬ÔòÊ¹ÓÃ¹²ÏíEXB
  96                                                                                                   »º³å£¬¶à¸öÎÄ¼ş·ÖÊ±·ÖÏíÒ»¸öÉÈÇø½»»»
  97                                                                                                   »º³å£¬»áÔì³ÉÕùÇÀÎÊÌâ)
  98           Data_Redirect : Redirect function name macro defination for read_dataX
  99                                                      (ÎªznFAT_ReadDataXº¯ÊıËù¶¨ÒåµÄÊı¾İ
 100                                                                                                   ÖØ¶¨Ïòµ¥Î»×Ö½Ú´¦Àíº¯Êı)
 101          
 102          /---------------------------------------------------------------------------*/
 103          
 104          
 105          //#pragma udata directive
 106          //#pragma udata BUFFER
 107          UINT8 tmpBuf[ZNFAT_BUF_SIZE];
 108          //#pragma udata
 109          
 110          UINT8 *znFAT_Buffer=tmpBuf; //znFATµÄÄÚ²¿»º³åÇø£¬Ê¹ÓÃÕß²»¿ÉË½×ÔÊ¹ÓÃ
 111                                      //ÏÈ¶¨ÒåtmpBuf£¬ÔÙÓÃznFAT_BufferÖ¸ÏòËü£¬ÊÇÒòÎªÔÚÒ»Ğ©¼Ü¹¹µÄCPUÖĞ
 112                                      //ÊÜÏŞÓÚRAMµÄÌØÊâ½á¹¹£¬Ö»ÄÜÓÃÖ¸ÕëÀ´·ÃÎÊ´óÊı×é£¬±ÈÈçPIC
 113          
 114          //--------------------------------------------------------------------------------------------------
 115          struct znFAT_Init_Args *pInit_Args; //³õÊ¼»¯²ÎÊı½á¹¹ÌåÖ¸Õë£¬ÓÃÒÔÖ¸ÏòÄ³Ò»´æ´¢Éè±¸µÄ³õÊ¼»¯²ÎÊı¼¯ºÏ
 116                                              //Ê¹ÓÃÖ®Ç°*±ØĞë*ÏÈÖ¸Ïò½á¹¹»¯±äÁ¿
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 3   

 117          extern struct znFAT_IO_Ctl ioctl; 
 118          
 119          UINT8 Dev_No=0; //Éè±¸ºÅ£¬ÓÃÓÚÊµÏÖ¶àÉè±¸
 120          
 121          //--------------------------------------------------------------------------------------------------
 122          
 123          struct FileInfo *just_file=(struct FileInfo *)0; //ÓÃÓÚ¼ÇÂ¼×î½ü²Ù×÷µÄÎÄ¼ş
 124          
 125          //-------------------SCCCBÏà¹Ø±äÁ¿¶¨Òå----------------------
 126          #ifndef RT_UPDATE_CLUSTER_CHAIN //ÓÃÓÚ¶¨Òå¹²ÏíCCCBµÄ±äÁ¿¼°»º³åÊµÌå
              #ifndef USE_ALONE_CCCB
              UINT32 scccb_buf[CCCB_LEN]; //CCCBµÄ»º³åÇø£¬ÒÔÁ¬Ğø´Ø¶ÎµÄ·½Ê½À´¼ÇÂ¼´ØÁ´
              UINT8  scccb_counter=0; 
              UINT32 scccb_curval=0;
              
              UINT8  scccb_curdev=(UINT8)(-1);
              #endif
              #endif
 135          
 136          #ifndef RT_UPDATE_CLUSTER_CHAIN
              
              #ifndef USE_ALONE_CCCB //²»Ê¹ÓÃ¶ÀÁ¢´ØÁ´»º³å£¬¶øÊÇÊ¹ÓÃ¹²Ïí´ØÁ´»º³å£¬ÒÔÏÂ±äÁ¿ÓÃÓÚÍê³É¹²ÏíCCCBÊ¹ÓÃ¹ı³ÌÖĞµÄÕùÇ
             -À
              UINT32 *pcccb_buf=scccb_buf;
              UINT32 *pcccb_curval=&scccb_curval;
              UINT8  *pcccb_counter=&scccb_counter;
              
              UINT8  *pcccb_curdev=&scccb_curdev;
              struct FileInfo *pcccb_cur_oc=(struct FileInfo *)0;
              struct znFAT_Init_Args *pcccb_cur_initargs=(struct znFAT_Init_Args *)0;
              #else
              UINT32 *pcccb_buf=(UINT32 *)0;
              UINT32 *pcccb_curval=(UINT32 *)0;
              UINT8  *pcccb_counter=(UINT8 *)0;
              #endif
               
              UINT8 get_next_cluster_in_cccb=0; //ÓÃÒÔ±êÖ¾ÊÇ·ñÔÚCCCBÖĞ²éÕÒÏÂÒ»´Ø
              #endif
 154          //----------------------------------------------------------
 155          
 156          //------------------EXBÏà¹Ø±äÁ¿¶¨Òå-------------------------
 157          #ifdef USE_EXCHANGE_BUFFER
              #ifndef USE_ALONE_EXB
              //#pragma udata directive
              //#pragma udata SEXB_BUF
              UINT8  sexb_buf[ZNFAT_BUF_SIZE];
              //#pragma udata
              
              UINT8  sexb_cur_dev=(UINT8)(-1);
              UINT32 sexb_cur_sec=0;
              struct FileInfo *psexb_cur_oc=(struct FileInfo *)0; //Ö¸Ê¾µ±Ç°EXB±»ÄÄ¸öÎÄ¼şÕ¼ÓÃ
              #endif
              #endif
 169          
 170          #ifdef USE_EXCHANGE_BUFFER
              
              #ifndef USE_ALONE_EXB
              UINT8 *pexb_buf=sexb_buf;
              #else
              UINT8 *pexb_buf=(UINT8 *)0;
              #endif
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 4   

              #endif
 179          //----------------------------------------------------------
 180          //====================Ò»Ğ©³£ÓÃº¯Êı================================================================
 181          
 182          //znFATÖĞÊ¹ÓÃµ½µÄ¹«¹²º¯Êı£¬ÆäÖĞ°üº¬ÁË¶ÔROMÀàĞÍ ×Ö½Ú¡¢×Ö¡¢Ë«×ÖµÄ¶ÁÈ¡ÒÔ¼°ROMµ½RAMÖ®¼ä¿½±´²Ù×÷
 183          //Èç¹ûÒªÊ¹³¤ÎÄ¼şÃû»ò¸ñÊ½»¯¹¦ÄÜ£¬ÔòÕâĞ©ROMÏà¹ØµÄº¯ÊıÊÇ±ØĞëÕıÈ·ÓèÒÔÊµÏÖµÄ
 184          
 185          UINT8 Memory_Set(UINT8 *pmem,UINT32 len,UINT8 value)
 186          {
 187   1       UINT32 i=0;
 188   1       for(i=0;i<len;i++)
 189   1       { 
 190   2        pmem[i]=value;
 191   2       }
 192   1      
 193   1       return 0;
 194   1      }
 195          
 196          UINT8 Memory_Compare(UINT8 *psmem,UINT8 *pdmem,UINT32 len)
 197          {
 198   1       UINT32 i=0;
 199   1      
 200   1       for(i=0;i<len;i++)
 201   1       {
 202   2        if(psmem[i]!=pdmem[i])
 203   2        {
 204   3         return 0;
 205   3        }
 206   2       }
 207   1       return 1;
 208   1      }
 209          
 210          UINT8 * Memory_Copy(UINT8 *pdmem,UINT8 *psmem,UINT32 len)
 211          {
 212   1       UINT32 i=0;
 213   1      
 214   1       for(i=0;i<len;i++)
 215   1       {
 216   2        pdmem[i]=psmem[i];
 217   2       }
 218   1      
 219   1       return pdmem;
 220   1      }
 221          
 222          INT8 * StringCopy(INT8 *dest_str,INT8 *src_str)
 223          {
 224   1       UINT8 i=0;
 225   1      
 226   1       while('\0'!=src_str[i])
 227   1       {
 228   2        dest_str[i]=src_str[i];
 229   2        i++;
 230   2       }
 231   1      
 232   1       dest_str[i]='\0';
 233   1      
 234   1       return dest_str;
 235   1      }
 236          
 237          UINT32 StringLen(INT8 *pstr)
 238          {
 239   1       UINT32 len=0;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 5   

 240   1       while('\0'!=pstr[len]) 
 241   1       {
 242   2        len++;
 243   2       }
 244   1       return len;
 245   1      }
 246          
 247          UINT32 WStringLen(UINT16 *str)
 248          {
 249   1       UINT32 i=0;
 250   1       while(0!=str[i])
 251   1       {
 252   2        i++;
 253   2       }
 254   1      
 255   1       return i;
 256   1      }
 257          
 258          //=============================FLASHROM ²Ù×÷Ïà¹Øº¯Êı=====================
 259          
 260          UINT8 PGM_BYTE_FUN(ROM_TYPE_UINT8 *ptr)
 261          {
 262   1       return *(ptr); 
 263   1      }
 264          
 265          UINT16 PGM_WORD_FUN(ROM_TYPE_UINT16 *ptr)
 266          {
 267   1       return *(ptr);
 268   1      }
 269          
 270          UINT32 PGM_DWORD_FUN(ROM_TYPE_UINT32 *ptr)
 271          {
 272   1       return *(ptr);
 273   1      }
 274          
 275          UINT8 * PGM2RAM(UINT8 *pdmem,ROM_TYPE_UINT8 *psmem,UINT32 len)
 276          {
 277   1       UINT32 i=0;
 278   1      
 279   1       for(i=0;i<len;i++)
 280   1       {
 281   2        pdmem[i]=PGM_BYTE_FUN((psmem+i));
 282   2       }
 283   1      
 284   1       return pdmem;
 285   1      }
 286          
 287          //================================================================================================
 288          
 289          /*****************************************************************************
 290           ¹¦ÄÜ£ºÑ¡¶¨Ò»¸ö´æ´¢Éè±¸
 291           ĞÎ²Î£ºdevno:Éè±¸ºÅ pinitargs:Ö¸Ïò´æ´¢Éè±¸Ëù¶ÔÓ¦µÄÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏµÄÖ¸Õë
 292           ·µ»Ø£º0
 293           Ïê½â£ºznFATÊÇÖ§³Ö¶àÉè±¸µÄ£¬Òò´ËÔÚ¶ÔÉè±¸½øĞĞÎÄ¼şÏµÍ³Ïà¹Ø²Ù×÷Ö®Ç°£¬±ØĞëÒªÏÈÑ¡¶¨
 294                 Ò»¸ö´æ´¢Éè±¸¡£´Ëº¯Êı¶ÔDev_NoÕâ¸öÈ«¾ÖµÄÓÃÓÚÇø·Ö´æ´¢Éè±¸Çı¶¯µÄ±äÁ¿½øĞĞÉè
 295                 ¶¨£¬Í¬Ê±½«pInit_ArgsÖ¸Ïò´æ´¢Éè±¸ÏàÓ¦µÄÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏ
 296          *****************************************************************************/
 297          UINT8 znFAT_Select_Device(UINT8 devno,struct znFAT_Init_Args *pinitargs) //Ñ¡ÔñÉè±¸
 298          {
 299   1       pInit_Args=pinitargs; //½«znFATµÄ³õÊ¼»¯²ÎÊı¼¯ºÏÖ¸ÕëÖ¸ÏòÉè±¸µÄ³õÊ¼»¯²ÎÊı¼¯ºÏ
 300   1      
 301   1       Dev_No=devno; //ÉèÖÃÉè±¸ºÅ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 6   

 302   1      
 303   1       return 0;
 304   1      }
 305          
 306          /***********************************************************************************
 307           ¹¦ÄÜ£ºÓÉÒ»¸öĞ¡¶ËÅÅÁĞµÄ×Ö½ÚĞòÁĞ£¬¼ÆËãµÃµ½ÆäÔÚÄ³Ò»×Ö·û³¤¶ÈÏÂËù±í´ïµÄÕûĞÍÖµ
 308           ĞÎ²Î£ºdat:Ö¸Ïò×Ö½ÚĞòÁĞµÄÖ¸Õë len:½«×Ö½ÚĞòÁĞµÄÇ°len¸ö×Ö½Ú¼ÆËãÕûĞÍÖµ
 309           ·µ»Ø£º¼ÆËãµÃµ½µÄÕûĞÍÖµ
 310           Ïê½â£ºÕâÒ»º¯ÊıÊÇÆÁ±Î²»Í¬CPUÔÚ´óĞ¡¶ËÉÏµÄ²îÒìµÄÖ÷ÒªÊÖ¶Î¡£±ÈÈç¶ÔÓÚÒ»¸öĞ¡¶ËµÄ4×Ö½ÚĞòÁĞ
 311                 unsigned char *p={0X12,0X34,0X56,0X78} Èç¹ûÎÒÃÇÏë°ÑËüºÏ³ÉÎªÒ»¸ö4×Ö½ÚÕûĞÍ£¬Èç
 312                 unsigned long£¬ÄÇÃ´¿ÉÒÔÕâÑùÀ´×÷ *((unsigned long *)p)£¬µ«¶ÔÓÚ²»Í¬µÄCPU£¬Òò±ä
 313                 Á¿ÔÚRAMÖĞµÄ×Ö½ÚÅÅÁĞË³Ğò²»Í¬£¬¼´´óĞ¡¶ËÎÊÌâ£¬ÔòÆäËù±í´ïµÄÕûĞÍÖµ¿ÉÄÜÎª0X12345678
 314                 »ò 0X78563412£¬Õâ½«»á³öÏÖ´íÎó¡£ÎªÁËÆÁ±ÎÕâÖÖ²îÒì£¬ÒıÈëÁË´Ëº¯Êı£¬Í¨¹ı¶Ô×Ö½ÚĞòÁĞ
 315                 ½øĞĞ¼ÆËã£¬×îºó½«¿ÉÒÔµÃµ½ÕıÈ·µÄÖµ£¬¶ÔÓÚÉÏÀıÖĞµÄ×Ö½ÚĞòÁĞ£¬Í¨¹ı´Ëº¯ÊıµÄ¼ÆËãBytes
 316                 2Value(p,4)ÖµÒ»¶¨Îª0X12345678¡£
 317          ***********************************************************************************/
 318          UINT32 Bytes2Value(UINT8 *dat,UINT8 len)
 319          {
 320   1       UINT32 temp=0;
 321   1      
 322   1       if(len>=1) temp|=((UINT32)(dat[0]))    ;
 323   1       if(len>=2) temp|=((UINT32)(dat[1]))<<8 ;
 324   1       if(len>=3) temp|=((UINT32)(dat[2]))<<16;
 325   1       if(len>=4) temp|=((UINT32)(dat[3]))<<24;
 326   1      
 327   1       return temp;
 328   1      }
 329          
 330          /***********************************************************************************
 331           ¹¦ÄÜ£º²éÕÒFSINFOÉÈÇøµÄÎïÀíµØÖ·
 332           ĞÎ²Î£ºfsinfosec:Ò»¸öÖ¸ÏòÓÃÓÚ¼ÇÂ¼FSINFOÉÈÇøÎïÀíµØÖ·µÄ±äÁ¿µÄÖ¸Õë
 333           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
 334           Ïê½â£ºÒ»°ãÀ´ËµFSINFOÉÈÇøÔÚDBRÉÈÇøµÄºóÒ»¸öÉÈÇø£¬µ«²»·¦ÓĞÌØÊâÇé¿ö£¬Òò´ËÕâÀï¶ÔDBR+1µ½
 335                 FAT1µÄÇ°Ò»¸öÉÈÇø½øĞĞ±éÀú£¬ÒÔFSINFOÉÈÇøµÄ±êÖ¾×Ö×÷ÎªÈÏ¶¨ÊÇFSINFOÉÈÇøµÄÌõ¼ş¡£
 336          ***********************************************************************************/
 337          UINT8 Find_FSINFO_Sec(UINT32 *fsinfosec) //Ñ°ÕÒFSINFOÉÈÇø£¬ÀïÃæÓĞÊ£Óà´ØÊıÓë¿ÉÓÃµÄ¿Õ´Ø
 338          {
 339   1       UINT32 iSec=0;
 340   1       struct FSInfo *pfsinfo;
 341   1      
 342   1       UINT8 head[4]={'R','R','a','A'};
 343   1       UINT8 sign[4]={'r','r','A','a'}; //FSINFOÉÈÇøµÄ±êÖ¾
 344   1      
 345   1       for(iSec=(pInit_Args->BPB_Sector_No+1);iSec<(pInit_Args->FirstFATSector);iSec++)
 346   1       {
 347   2        znFAT_Device_Read_Sector(iSec,znFAT_Buffer);
 348   2        pfsinfo=((struct FSInfo *)znFAT_Buffer);
 349   2        if(Memory_Compare(pfsinfo->Head,head,4) //ÅĞ¶ÏÉÈÇøÊÇ·ñÊÇFSINFOÉÈÇø
 350   2               && Memory_Compare(pfsinfo->Sign,sign,4))
 351   2        {
 352   3         *fsinfosec=iSec;
 353   3         return ERR_SUCC;
 354   3        }
 355   2       }
 356   1      
 357   1       return ERR_FAIL;
 358   1      }
 359          
 360          /***********************************************************************************
 361           ¹¦ÄÜ£º´ÓFAT±íµÄ×îÍ·ÉÏ¿ªÊ¼²éÕÒ¿ÉÓÃµÄ¿Õ´Ø£¬¼´ÕÒµ½µÚÒ»¸ö¿ÉÓÃ¿Õ´Ø
 362           ĞÎ²Î£ºnFreeCluster:Ö¸ÏòÓÃÓÚ¼ÇÂ¼ÓĞÓÃµÄ¿Õ´ØµÄ±äÁ¿µÄÖ¸Õë
 363           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 7   

 364           Ïê½â£º´ÓFAT±íµÄ×î¿ªÊ¼Î»ÖÃ¿ªÊ¼Ë³´Î²éÕÒ£¬Ö±µ½µÚÒ»¸ö¿ÉÓÃµÄ¿Õ´Ø³öÏÖ£¬´Ë¿Õ´ØÖµ½«»á±»¼ÇÂ¼
 365                 ÔÚÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏÖĞµÄpInit_Args->Next_Free_Cluster£¬ÎªÎÄ¼ş²Ù×÷¹ı³ÌÖĞĞè
 366                 Ê¹ÓÃ¿Õ´ØÊ±Ìá¹©¿ÉÓÃ¿Õ´ØµÄ²Î¿¼Öµ¡£
 367          ***********************************************************************************/
 368          UINT8 Search_Free_Cluster_From_Start(UINT32 *nFreeCluster)
 369          {
 370   1       UINT32 iSec=0;
 371   1       UINT8  iItem=0;
 372   1      
 373   1       struct FAT_Sec *pFAT_Sec;
 374   1      
 375   1       for(iSec=0;iSec<pInit_Args->FATsectors;iSec++)
 376   1       {
 377   2        znFAT_Device_Read_Sector(pInit_Args->FirstFATSector+iSec,znFAT_Buffer); //¶ÁÈ¡FATÉÈÇø
 378   2        pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
 379   2      
 380   2        for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //±éÀúËùÓĞ´ØÏî£¬Ñ°ÕÒ¿ÕÏĞ´Ø
 381   2        {
 382   3         if((0==(((pFAT_Sec->items[iItem]).Item)[0])) && (0==(((pFAT_Sec->items[iItem]).Item)[1])) &&
 383   3                (0==(((pFAT_Sec->items[iItem]).Item)[2])) && (0==(((pFAT_Sec->items[iItem]).Item)[3])))
 384   3         {
 385   4          *nFreeCluster=((iSec*NITEMSINFATSEC)+(UINT32)iItem);
 386   4              return ERR_SUCC;
 387   4         }
 388   3        }
 389   2       }
 390   1       
 391   1       return ERR_FAIL;
 392   1      }
 393          
 394          /***********************************************************************************
 395           ¹¦ÄÜ£º¸üĞÂFSINFOÉÈÇø²ÎÊı
 396           ĞÎ²Î£ºÎŞ
 397           ·µ»Ø£º0
 398           Ïê½â£º¸üĞÂFSINFOÉÈÇø£¬ÆäÊµÖ÷ÒªÊÇÎªÁËÎ¬»¤Ê£Óà¿Õ´ØÊıÓëÏÂÒ»¸ö¿ÉÓÃ¿Õ´Ø²Î¿¼ÖµÕâÁ½¸ö²ÎÊı¡£
 399          ***********************************************************************************/
 400          #ifdef UPDATE_FSINFO
 401          UINT8 Update_FSINFO(void) //¸üĞÂFSINFOÉÈÇø
 402          {
 403   1       struct FSInfo *pfsinfo;
 404   1       znFAT_Device_Read_Sector(pInit_Args->FSINFO_Sec,znFAT_Buffer);
 405   1       
 406   1       pfsinfo=((struct FSInfo *)znFAT_Buffer);
 407   1       
 408   1       //Ğ´ÈëÊ£Óà¿Õ´ØÊı
 409   1       pfsinfo->Free_Cluster[0]=(UINT8)( pInit_Args->Free_nCluster&0X000000FF)    ;
 410   1       pfsinfo->Free_Cluster[1]=(UINT8)((pInit_Args->Free_nCluster&0X0000FF00)>>8);
 411   1       pfsinfo->Free_Cluster[2]=(UINT8)((pInit_Args->Free_nCluster&0X00FF0000)>>16);
 412   1       pfsinfo->Free_Cluster[3]=(UINT8)((pInit_Args->Free_nCluster&0XFF000000)>>24);
 413   1      
 414   1       //Ğ´ÈëÏÂÒ»¿ÕÏĞ´Ø²Î¿¼Öµ£¬²¢ÎŞ¶à´óÒâÒå
 415   1       pfsinfo->Next_Free_Cluster[0]=(UINT8)( pInit_Args->Next_Free_Cluster&0X000000FF)    ;
 416   1       pfsinfo->Next_Free_Cluster[1]=(UINT8)((pInit_Args->Next_Free_Cluster&0X0000FF00)>>8);
 417   1       pfsinfo->Next_Free_Cluster[2]=(UINT8)((pInit_Args->Next_Free_Cluster&0X00FF0000)>>16);
 418   1       pfsinfo->Next_Free_Cluster[3]=(UINT8)((pInit_Args->Next_Free_Cluster&0XFF000000)>>24);
 419   1      
 420   1       znFAT_Device_Write_Sector(pInit_Args->FSINFO_Sec,znFAT_Buffer);
 421   1      
 422   1       return 0;
 423   1      }
 424          #endif
 425          
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 8   

 426          /***********************************************************************************
 427           ¹¦ÄÜ£ºznFATÖĞµÄÎÄ¼şÏµÍ³³õÊ¼»¯º¯Êı
 428           ĞÎ²Î£ºÎŞ
 429           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü£¬Èç¹ûËü·µ»Ø2£¬ÔòËµÃ÷·¢ÉúFAT32ÎÄ¼şÏµÍ³ÀàĞÍĞ£Ñé´íÎó£¬¼´´æ
 430                 ´æ´¢ÉÏµÄÎÄ¼şÏµÍ³·ÇFAT32¡£
 431           Ïê½â£ºÎÄ¼şÏµÍ³³õÊ¼»¯º¯Êı£¬½«Íê³ÉÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏµÄ×°Èë£¬ÎªÒÔºóµÄÎÄ¼ş²Ù×÷×÷ºÃ
 432                 ×¼±¸¡£
 433          ***********************************************************************************/
 434          UINT8 znFAT_Init(void)
 435          {
 436   1       struct DBR *pdbr;
 437   1      
 438   1       UINT8 dm[3]=DBR_MARK;
 439   1      
 440   1       znFAT_Device_Read_Sector(MBR_SECTOR,znFAT_Buffer); 
 441   1         
 442   1       if(!(znFAT_Buffer[0]==dm[0] && znFAT_Buffer[1]==dm[1] && znFAT_Buffer[2]==dm[2])) //¼ì²â0ÉÈÇøÊÇ·ñÎªDBRÉÈÇ
             -ø
 443   1       {
 444   2        pInit_Args->BPB_Sector_No=Bytes2Value(((((struct MBR *)(znFAT_Buffer))->Part[0]).StartLBA),4);
 445   2       }
 446   1       else
 447   1       {
 448   2        pInit_Args->BPB_Sector_No=0;
 449   2       }
 450   1       
 451   1       znFAT_Device_Read_Sector((pInit_Args->BPB_Sector_No),znFAT_Buffer); //¶ÁÈ¡DBRÉÈÇø
 452   1       pdbr=(struct DBR *)znFAT_Buffer;
 453   1      
 454   1       if(!IS_FAT32_TYPE((pdbr->BS_FilSysType1))) return FSTYPE_NOT_FAT32; //FAT32ÎÄ¼şÏµÍ³ÀàĞÍ¼ìÑé
 455   1      
 456   1       pInit_Args->BytesPerSector  =Bytes2Value((pdbr->BPB_BytesPerSec),2);//×°ÈëÃ¿ÉÈÇø×Ö½ÚÊıµ½BytesPerSectorÖĞ
 457   1      
 458   1       pInit_Args->FATsectors      =Bytes2Value((pdbr->BPB_FATSz32)    ,4);//×°ÈëFAT±íÕ¼ÓÃµÄÉÈÇøÊıµ½FATsectorsÖĞ
 459   1      
 460   1       pInit_Args->SectorsPerClust =pdbr->BPB_SecPerClus;//×°ÈëÃ¿´ØÉÈÇøÊıµ½SectorsPerClust ÖĞ
 461   1       pInit_Args->FirstFATSector  =Bytes2Value((pdbr->BPB_RsvdSecCnt) ,2)+pInit_Args->BPB_Sector_No;//×°ÈëµÚÒ»¸
             -öFAT±íÉÈÇøºÅµ½FirstFATSector ÖĞ
 462   1       pInit_Args->FirstDirSector  =(pInit_Args->FirstFATSector)+(pdbr->BPB_NumFATs)*(pInit_Args->FATsectors); /
             -/×°ÈëµÚÒ»¸öÄ¿Â¼ÉÈÇøµ½FirstDirSectorÖĞ
 463   1       pInit_Args->Total_SizeKB    =Bytes2Value((pdbr->BPB_TotSec32),4)/2;  //´ÅÅÌµÄ×ÜÈİÁ¿£¬µ¥Î»ÊÇKB
 464   1      
 465   1       if(Find_FSINFO_Sec(&(pInit_Args->FSINFO_Sec))) //²éÕÒFSINFOĞÅÏ¢ÉÈÇø
 466   1       {
 467   2        return ERR_FAIL;
 468   2       }
 469   1      
 470   1       znFAT_Device_Read_Sector((pInit_Args->FSINFO_Sec),znFAT_Buffer);
 471   1       pInit_Args->Free_nCluster=Bytes2Value(((struct FSInfo *)znFAT_Buffer)->Free_Cluster,4); //»ñÈ¡Ê£Óà´ØÊı
 472   1      
 473   1       if(0XFFFFFFFF==pInit_Args->Free_nCluster) //Èç¹ûÒ»¸ö´ÅÅÌ¸ñÊ½»¯ºóÃ»ÓĞ¾í±ê£¬ÔòÆä´æ´¢¿Õ¼ä¾ÍÃ»ÓĞÒ»µãÕ¼ÓÃ£¬´ËÊ
             -±FSINFO¼ÇÂ¼µÄÊ£Óà¿Õ´ØÊıÎª0XFFFFFFFF
 474   1       {
 475   2        pInit_Args->Free_nCluster=(((pInit_Args->Total_SizeKB*2)-(pInit_Args->FirstDirSector))/(pInit_Args->Sect
             -orsPerClust))-1;
 476   2       }
 477   1      
 478   1       if(Search_Free_Cluster_From_Start(&(pInit_Args->Next_Free_Cluster)))//±éÀúÕû¸öFAT±í£¬ËÑË÷¿ÉÓÃµÄ¿ÕÏĞ´Ø
 479   1       {                                                                   //´Ë²Ù×÷¿ÉÄÜ»áºÄ·Ñ½Ï¶àÊ±¼ä£¬µ«Ã»ÓĞ°ì·
             -¨
 480   2        return ERR_FAIL;                                                   //FSINFOÖĞµÄ¿ÕÏĞ´Ø²Î¿¼Öµ²¢²»±£Ö¤ÕıÈ·
 481   2       }                                                                   //ĞŞÕıºÍÎ¬»¤Ëü·´¶ø»á¸ü¼ÓÂé·³
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 9   

 482   1       
 483   1       #ifdef RT_UPDATE_FSINFO //¼°Ê±½«FSINFOÉÈÇø½øĞĞ¸üĞÂ
 484   1       Update_FSINFO();
 485   1       #endif
 486   1      
 487   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
               #endif
 492   1      
 493   1       #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               Memory_Set(pexb_buf,512,0);
               #endif
               #endif
 498   1      
 499   1       return ERR_SUCC;
 500   1      }
 501          
 502          #ifndef RT_UPDATE_CLUSTER_CHAIN
              
              #ifdef USE_ALONE_CCCB
              UINT8 CCCB_To_Alone(void) //¶¨Ïòµ½µ±Ç°ÎÄ¼şµÄCCCB         
              {
               pcccb_buf=(just_file->acccb_buf);
               pcccb_curval=&(just_file->acccb_curval);
               pcccb_counter=&(just_file->acccb_counter);
              
               return 0;
              }
              #endif
              
              UINT32 CCCB_Get_Next_Cluster(UINT32 cluster)
              {
               UINT32 pos=CCCB_LEN-1;
               UINT32 i=0,temp=0;
              
               if(pcccb_buf==(UINT32 *)0) return 0;
               
               if(0==pcccb_buf[0]) return 0; //Èç¹ûCCCBÎ´±»Õ¼ÓÃ£¬ÔòÖ±½Ó·µ»Ø0
              
               #ifndef USE_ALONE_CCCB
               if(Dev_No!=(*pcccb_curdev)) return 0; //Èç¹ûµ±Ç°Õ¼ÓÃSCCCBµÄÉè±¸²»ÊÇÏÖÔÚÑ¡¶¨µÄÉè±¸£¬ÔòÖ±½Ó·µ»Ø0
               if(just_file!=pcccb_cur_oc) return 0; //Èç¹ûµ±Ç°Õ¼ÓÃSCCCBµÄÎÄ¼ş²»ÊÇÏÖÔÚÕıÔÚ²Ù×÷µÄÎÄ¼ş£¬ÔòÖ±½Ó·µ»Ø0
               #endif
              
               while(0==pcccb_buf[pos]) pos--;
              
               if(cluster>=pcccb_buf[pos] && cluster<=(*pcccb_curval))
               {
                if(cluster==(*pcccb_curval)) return 0X0FFFFFFF;
                if(cluster==pcccb_buf[pos])
                {
                 if(pcccb_buf[pos]==(*pcccb_curval)) return 0X0FFFFFFF;
                }
                return (cluster+1);
               }
              
               temp=pos/2;
               for(i=0;i<temp;i++)
               {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 10  

                if(cluster>=pcccb_buf[2*i] && cluster<=pcccb_buf[2*i+1])
                {
                 if(cluster==pcccb_buf[2*i+1]) return pcccb_buf[2*i+2];
                 if(cluster==pcccb_buf[2*i])
                 {
                  if(pcccb_buf[2*i]==pcccb_buf[2*i+1]) return pcccb_buf[2*i+2];
                 }
                 return (cluster+1);
                }  
               }
              
               return 0;
              }
              
              UINT8 CCCB_Update_FAT(void)
              {
               UINT32 i=0,j=0,temp=0,temp1=0;
               UINT32 old_clu=0,cur_clu=0,clu_sec=0;
              
               #ifndef USE_ALONE_CCCB
               UINT8 old_devno=Dev_No;
               struct znFAT_Init_Args *old_pinit_args=pInit_Args;
               #endif
              
               struct FAT_Sec *pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞ
             -Í
              
               if(pcccb_buf==(UINT32 *)0) return 0;
              
               if(0==pcccb_buf[0]) return 0; //CCCBÉĞÎ´±»Õ¼ÓÃ£¬ÎŞ´ØÁ´¿É¸üĞÂ
              
               #ifndef USE_ALONE_CCCB
               Dev_No=(*pcccb_curdev); pInit_Args=pcccb_cur_initargs;
               #endif
              
               old_clu=cur_clu=pcccb_buf[0];
               clu_sec=(old_clu/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
               znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               
               pcccb_buf[(*pcccb_counter)]=(*pcccb_curval); //½«×îºóÒ»¸öÇø¼ä²¹Æë
              
               temp1=((*pcccb_counter)+1)/2;
               for(i=0;i<temp1;)
               {
                for(j=pcccb_buf[2*i]+1;j<=pcccb_buf[2*i+1];j++)
                {
                 cur_clu++;
              
                 if(clu_sec!=(old_clu/NITEMSINFATSEC))
                 {
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                   
                      clu_sec=(old_clu/NITEMSINFATSEC);
                  znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 }
              
                 temp=(UINT8)(old_clu%NITEMSINFATSEC);
                 (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cur_clu&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                 (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cur_clu&0X0000FF00)>>8) ;
                 (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cur_clu&0X00FF0000)>>16);
                 (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cur_clu&0XFF000000)>>24);
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 11  

                      
                 old_clu=cur_clu;
                }
              
                cur_clu=((i==(temp1-1))?(0X0FFFFFFF):(pcccb_buf[2*i+2])); //Ä¿±ê´ØÈ¡ÏÂÒ»´Ø¶ÎµÄ¿ªÊ¼´Ø;
              
                if(clu_sec!=(old_clu/NITEMSINFATSEC))
                {
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                   
                 clu_sec=(old_clu/NITEMSINFATSEC);
                 znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                }
              
                temp=(UINT8)(old_clu%NITEMSINFATSEC);
                (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cur_clu&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cur_clu&0X0000FF00)>>8) ;
                (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cur_clu&0X00FF0000)>>16);
                (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cur_clu&0XFF000000)>>24);
              
                old_clu=cur_clu;
                i++;
               }
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
               //============================================================================================
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0); //Çå¿ÕCCCB
               (*pcccb_counter)=0;
              
               #ifndef USE_ALONE_CCCB
               pcccb_cur_oc=(struct FileInfo *)0;
               *pcccb_curdev=(UINT8)(-1);
               pcccb_cur_initargs=(struct znFAT_Init_Args *)0;
              
               Dev_No=old_devno; pInit_Args=old_pinit_args; //»Ö¸´Éè±¸ºÅÓë ÓëÉè±¸Ïà¹ØµÄÎÄ¼şÏµÍ³²ÎÊı¼¯ºÏ
               #endif
              
               return 0;
              }
              #endif
 647          
 648          /***********************************************************************************
 649           ¹¦ÄÜ£º»ñÈ¡ÏÂÒ»´Ø
 650           ĞÎ²Î£ºµ±Ç°´Ø
 651           ·µ»Ø£ºÏÂÒ»´ØµÄ´ØºÅ
 652           Ïê½â£º´Ëº¯ÊıÔÚznFAT±»Æµ·±µ÷ÓÃ
 653          ***********************************************************************************/
 654          #ifdef GET_NEXT_CLUSTER 
 655          UINT32 Get_Next_Cluster(UINT32 cluster)
 656          {
 657   1       UINT32 clu_sec=0;
 658   1       struct FAT_Sec *pFAT_Sec;
 659   1       struct FAT_Item *pFAT_Item;
 660   1      
 661   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               UINT32 next_clu=0;
               #endif
 664   1      
 665   1       #ifndef RT_UPDATE_CLUSTER_CHAIN //Èç¹ûÊ¹ÓÃÁËCCCB£¬Ôò»ñÈ¡ÏÂÒ»´ØÊ±£¬ÏÈµ½CCCBÖĞÑ°ÕÒ£¬È»ºóÔÙµ½FATÖĞÈ¥ÕÒ
               if(0!=get_next_cluster_in_cccb)
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 12  

               {
                next_clu=CCCB_Get_Next_Cluster(cluster);
                if(0!=next_clu) return next_clu;
               }
               #endif
 672   1      
 673   1       clu_sec=(cluster/NITEMSINFATSEC)+(pInit_Args->FirstFATSector); //Ö¸¶¨´ØµÄ´ØÏîËùÔÚµÄÉÈÇøÎªÆäFATÇøÄÚµÄÆ«ÒÆÁ
             -¿¼ÓÉÏ
 674   1                                                                
 675   1       znFAT_Device_Read_Sector(clu_sec,znFAT_Buffer); //½«´ØÏîËùÔÚµÄÉÈÇøÊı¾İ¶ÁÈë»º³åÇø
 676   1      
 677   1       pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞÍ
 678   1      
 679   1       pFAT_Item=&((pFAT_Sec->items)[cluster%NITEMSINFATSEC]); //»ñÈ¡Ö¸¶¨´ØµÄ´ØÏîÔÚËùÔÚÉÈÇøÖĞµÄµØÖ·
 680   1      
 681   1       return Bytes2Value((UINT8 *)pFAT_Item,NFATITEMBYTES); //·µ»Ø´ØÏîµÄÖµ£¬¼´Ö¸¶¨´ØÏÂÒ»´ØµÄ´ØºÅ
 682   1      }
 683          #endif
 684          
 685          /***********************************************************************************
 686           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶¨Î»
 687           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Ä¿±êÆ«ÒÆÁ¿
 688           ·µ»Ø£º0
 689           Ïê½â£ºÈç¹ûoffset´óÓÚÎÄ¼ş´óĞ¡£¬Ôò¶¨Î»µ½ÎÄ¼şÄ©Î²¡£´Ëº¯ÊıÒÑ¾­±»Êı¾İ¶ÁĞ´º¯Êı¼¯³É£¬Ê¹ÓÃ
 690                 ÕßÒ»°ã²»ĞèÒªµ÷ÓÃ´Ëº¯Êı¡£
 691          ***********************************************************************************/
 692          #ifdef ZNFAT_SEEK
 693          UINT8 znFAT_Seek(struct FileInfo *pfi,UINT32 offset)
 694          {
 695   1       UINT32 Cluster_Size=((pInit_Args->SectorsPerClust)*(pInit_Args->BytesPerSector)); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬Ò
             -ÔÃâºóÃæÖØ¸´¼ÆËã
 696   1       UINT32 temp=0,temp1=0,temp2=0,len=0,k=0,ncluster=0,have_read=0;
 697   1      
 698   1       just_file=pfi;
 699   1      
 700   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
 706   1      
 707   1       if(offset<(pfi->File_Size)) //Èç¹ûÒª¶¨Î»µ½µÄÆ«ÒÆÁ¿Ğ¡ÓÚÎÄ¼ş´óĞ¡£¬Ôò±Ø¶¨²»ÔÚÎÄ¼şÄ©Î²
 708   1       {
 709   2        pfi->File_IsEOF=BOOL_FALSE;
 710   2       }
 711   1      
 712   1       if(offset==(pfi->File_CurOffset)) return 0; //Èç¹ûÒª¶¨Î»µÄÎ»ÖÃÕıºÃÊÇµ±Ç°Æ«ÒÆÁ¿£¬ÔòÖ±½Ó·µ»Ø
 713   1      
 714   1       if(offset<(pfi->File_CurOffset)) //Èç¹ûÒª¶¨Î»µÄÎ»ÖÃÔÚµ±Ç°Æ«ÒÆÁ¿Ö®Ç°£¬ÔòÏÈ»Øµ½ÎÄ¼şÆğµã£¬ÒòÎª´ØÁ´ÊÇµ¥ÏòµÄ
 715   1       {
 716   2        pfi->File_CurClust=pfi->File_StartClust;
 717   2        pfi->File_CurSec=SOC(pfi->File_CurClust);
 718   2        pfi->File_CurPos=0;
 719   2        pfi->File_CurOffset=0; 
 720   2        pfi->File_IsEOF=BOOL_FALSE;
 721   2       }
 722   1       
 723   1       len=offset-(pfi->File_CurOffset); //¼ÆËãÄ¿±êÆ«ÒÆÁ¿µ½µ±Ç°Æ«ÒÆÁ¿Ö®¼äµÄÊı¾İ³¤¶È
 724   1       
 725   1       if(offset>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
 726   1       {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 13  

 727   2        len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
 728   2        pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
 729   2       }
 730   1       
 731   1       //=================================================================== 
 732   1       if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
 733   1       {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
 734   2        if(len<=(pInit_Args->BytesPerSector-pfi->File_CurPos))
 735   2        {
 736   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 737   3         if((pInit_Args->BytesPerSector-pfi->File_CurPos)==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
 738   3         {
 739   4          if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
 740   4          {
 741   5           if(!pfi->File_IsEOF) 
 742   5               {
 743   6                pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); 
 744   6               }
 745   5           pfi->File_CurSec=SOC(pfi->File_CurClust);
 746   5          }
 747   4          else
 748   4          {
 749   5           pfi->File_CurSec++;        
 750   5          }
 751   4          pfi->File_CurPos=0; 
 752   4         }
 753   3         else
 754   3         {
 755   4          pfi->File_CurPos+=((UINT16)len); 
 756   4         }    
 757   3         pfi->File_CurOffset+=len;
 758   3      
 759   3         return NUL_RET;
 760   3        }
 761   2        //===================================================================
 762   2        else
 763   2        {
 764   3         temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
 765   3         have_read+=temp;
 766   3              
 767   3         if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
 768   3         {
 769   4          pfi->File_CurSec++;
 770   4          pfi->File_CurPos=0; 
 771   4      
 772   4          temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
 773   4          temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
 774   4          if(temp2<=temp1) //Èç¹ûÊ£ÓàÊı¾İÁ¿xxx
 775   4          {
 776   5               //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø      
 777   5           temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãµ±Ç°´ØÄÚÕûÉÈÇø¶ÁÈ¡µÄ½áÊøÉÈÇø
 778   5               have_read+=((pInit_Args->BytesPerSector)*temp);
 779   5      
 780   5           if(temp2==temp1)
 781   5           {
 782   6            if(!pfi->File_IsEOF) 
 783   6                {
 784   7                 pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); 
 785   7                }
 786   6            pfi->File_CurSec=SOC(pfi->File_CurClust); 
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 14  

 787   6            pfi->File_CurPos=0;
 788   6           }
 789   5           else
 790   5           {
 791   6            pfi->File_CurSec+=temp; 
 792   6            //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 793   6            pfi->File_CurPos=(UINT16)(len-have_read);
 794   6           }
 795   5           pfi->File_CurOffset+=len; 
 796   5          
 797   5           return NUL_RET;
 798   5          }
 799   4          else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
 800   4          {
 801   5               temp=LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´ØµÄÊ£ÓàÕûÉÈÇøÊı
 802   5               have_read+=((pInit_Args->BytesPerSector)*temp);
 803   5          }
 804   4         }
 805   3        
 806   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
 807   3         pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust);
 808   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
 809   3         pfi->File_CurPos=0;    
 810   3        }
 811   2       }
 812   1       //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
 813   1       if(len-have_read>0) 
 814   1       {
 815   2        ncluster=(len-have_read)/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
 816   2      
 817   2        //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêËùÓĞµÄÕû´ØÊı¾İ
 818   2      
 819   2        for(k=0;k<ncluster;k++) //¶ÁÈ¡Õû´ØÊı¾İ
 820   2        {
 821   3         have_read+=(Cluster_Size);
 822   3         if(!((len-have_read)==0 && pfi->File_IsEOF))  
 823   3         {
 824   4              pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust);
 825   4         }
 826   3        }
 827   2      
 828   2        pfi->File_CurSec=SOC(pfi->File_CurClust);
 829   2       
 830   2        //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
 831   2        if(len-have_read>0)
 832   2        {
 833   3         temp=(len-have_read)/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
 834   3         have_read+=((pInit_Args->BytesPerSector)*temp);   
 835   3      
 836   3         pfi->File_CurSec+=temp;
 837   3         //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
 838   3         if(len-have_read>0)
 839   3         {  
 840   4          //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
 841   4          pfi->File_CurPos=(UINT16)(len-have_read);    
 842   4         }
 843   3         //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
 844   3        }
 845   2       }
 846   1      
 847   1       pfi->File_CurOffset+=len;
 848   1      
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 15  

 849   1       return 0;
 850   1      }
 851          #endif
 852          
 853          /******************************************************************************************
 854           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶ÁÈ¡
 855           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Êı¾İ¶ÁÈ¡µÄ¿ªÊ¼Æ«ÒÆÁ¿ len:Òª¶ÁÈ¡µÄ×Ö½ÚÊı
 856                 app_Buffer:Ó¦ÓÃÊı¾İ»º³åÇøÖ¸Õë
 857           ·µ»Ø£ºÊµ¼Ê¶ÁÈ¡µ½µÄÊı¾İ³¤¶È 
 858           Ïê½â£ºÈç¹û´ÓoffsetÎ»ÖÃ¶ÁÈ¡µÄÊı¾İ³¤¶ÈÒÑ¾­³¬Ô½ÁËÎÄ¼ş´óĞ¡£¬Ôò½ö¶ÁÈ¡offsetÎ»ÖÃµ½ÎÄ¼şÄ©Î²µÄÊı¾İ
 859                 Òò´Ë£¬Èç¹ûÎÄ¼şµÄÆ«ÒÆÎ»ÖÃÒÑ¾­ÔÚÎÄ¼şÄ©Î²£¬ÔÙ¶ÔÆä½øĞĞ¶ÁÈ¡£¬Ôò±ØÈ»¶Á²»µ½Êı¾İ£¬¶ø·µ»Ø0£¬
 860                 Õâ¿ÉÒÔ×÷ÎªÎÄ¼şÊı¾İÒÑÈ«²¿¶ÁÍêµÄ±êÖ¾£»µ±È»Ò²¿ÉÒÔ¿´File_IsEOFÕâ¸ö±êÖ¾£¬Èç¹ûÎª1ÔòËµÃ÷ÎÄ¼ş
 861                 ÒÑ¾­ÔÚÄ©Î²ÁË£»ÔÙ»òÕß¿ÉÒÔ±È½ÏÎÄ¼şµ±Ç°Æ«ÒÆÁ¿File_CurOffsetÓëÎÄ¼ş´óĞ¡µÄ²îÖµ£¬Èç¹ûÎª0£¬Ôò
 862                 ÎÄ¼şÒÑµ½Ä©Î²¡£¶Áµ½µÄÊı¾İ½«±»·ÅÔÚapp_BufferÖ¸ÏòµÄÓ¦ÓÃÊı¾İ»º³åÇøÖĞ£¬Òª×¢Òâ»º³åÇø´óĞ¡£¬
 863                 ·ÀÖ¹ÄÚ´æÒç³ö¡£
 864          ******************************************************************************************/
 865          #ifdef ZNFAT_READDATA 
 866          UINT32 znFAT_ReadData(struct FileInfo *pfi,UINT32 offset,UINT32 len,UINT8 *app_Buffer)
 867          {
 868   1       UINT32 Cluster_Size=0,iClu=0,next_clu=0,start_clu=0,end_clu=0;
 869   1       UINT32 temp=0,temp1=0,temp2=0,ncluster=0,have_read=0;
 870   1      
 871   1       just_file=pfi;
 872   1      
 873   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
 879   1      
 880   1       znFAT_Seek(pfi,offset); //ÎÄ¼ş¶¨Î»
 881   1      
 882   1       if(0==len) return 0; //Èç¹ûÒª¶ÁÈ¡µÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø
 883   1       
 884   1       Cluster_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬ÒÔÃâºóÃæÖØ¸´
             -¼ÆËã
 885   1       
 886   1       if((pfi->File_CurOffset+len)>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
 887   1       {
 888   2        len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
 889   2        pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
 890   2       }
 891   1       
 892   1       //=======================================================================================================
             -===== 
 893   1       if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
 894   1       {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
 895   2        znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«µ±Ç°ÉÈÇø¶ÁÈëÄÚ²¿»º³åÇø
 896   2      
 897   2        temp=pInit_Args->BytesPerSector-pfi->File_CurPos; //¼ÆËãµ±Ç°ÉÈÇøÖĞµÄÊ£ÓàÊı¾İÁ¿
 898   2      
 899   2        if(len<=temp)
 900   2        {
 901   3         Memory_Copy(app_Buffer,znFAT_Buffer+(pfi->File_CurPos),len);//½«ÄÚ²¿»º³åÇøÖĞÒª¶ÁµÄÊı¾İ¿½ÈëÓ¦ÓÃ»º³åÇø
 902   3         
 903   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 904   3         if(temp==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
 905   3         {
 906   4          if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
 907   4          {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 16  

 908   5           if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
 909   5               {
 910   6                pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
 911   6               }
 912   5           pfi->File_CurSec=SOC(pfi->File_CurClust);
 913   5          }
 914   4          else
 915   4          {
 916   5           pfi->File_CurSec++;        
 917   5          }
 918   4          pfi->File_CurPos=0; 
 919   4         }
 920   3         else
 921   3         {
 922   4          pfi->File_CurPos+=(UINT16)len; 
 923   4         }    
 924   3         pfi->File_CurOffset+=len;
 925   3      
 926   3         return len;
 927   3        }
 928   2        //======================================================================================================
             -=====
 929   2        else
 930   2        {
 931   3         temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
 932   3      
 933   3         Memory_Copy(app_Buffer,znFAT_Buffer+(pfi->File_CurPos),temp); //½«µ±Ç°ÉÈÇøÊ£ÓàÊı¾İÌÜµ½Ó¦ÓÃ»º³åÇø
 934   3         have_read+=temp;
 935   3              
 936   3         if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
 937   3         {
 938   4          pfi->File_CurSec++;
 939   4          pfi->File_CurPos=0; 
 940   4      
 941   4          temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
 942   4          temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
 943   4          if(temp2<=temp1) //Èç¹ûÒª¶ÁµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÊ£ÓàÊı¾İÁ¿ 
 944   4          {
 945   5               //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø
 946   5                 
 947   5           temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãÒª¶ÁÈ¡µÄÊ£ÓàÊı¾İ×ã¹»¼¸¸öÕûÉÈÇø 
 948   5           
 949   5               znFAT_Device_Read_nSector(temp,pfi->File_CurSec,app_Buffer+have_read);
 950   5               have_read+=((pInit_Args->BytesPerSector)*temp);
 951   5      
 952   5           if(temp2==temp1)
 953   5           {
 954   6            if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
 955   6                {
 956   7                 pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
 957   7                }
 958   6            pfi->File_CurSec=SOC(pfi->File_CurClust); 
 959   6            pfi->File_CurPos=0;
 960   6           }
 961   5           else
 962   5           {
 963   6            pfi->File_CurSec+=temp; 
 964   6                temp=len-have_read;
 965   6      
 966   6            znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //µ±Ç°ÉÈÇøÖĞ¿ÉÄÜ»¹ÓĞ²¿·ÖÊ£ÓàÊı¾İÒª¶Á
 967   6            Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp); //½«×îºó²»×ãÉÈÇøµÄÊı¾İÌÜÈëÓ¦ÓÃ»º³åÇø
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 17  

 968   6            //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
 969   6            pfi->File_CurPos=(UINT16)temp;
 970   6            
 971   6           }
 972   5           pfi->File_CurOffset+=len; 
 973   5          
 974   5           return len;
 975   5          }
 976   4          else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
 977   4          {
 978   5               temp=(LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´Ø»¹ÓĞ¼¸¸öÕûÉÈÇø 
 979   5      
 980   5           znFAT_Device_Read_nSector(temp,(pfi->File_CurSec),app_Buffer+have_read);
 981   5           have_read+=((pInit_Args->BytesPerSector)*temp);
 982   5          }
 983   4         }
 984   3        
 985   3         //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
 986   3         pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //ÕâÀï²»»á²úÉú¡°¾½´Ø¡± 
 987   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
 988   3         pfi->File_CurPos=0;    
 989   3        }
 990   2       }
 991   1       //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
 992   1      
 993   1       temp1=len-have_read;
 994   1       ncluster=temp1/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
 995   1       if(ncluster>0) //Ê£ÓàÊı¾İÆğÂë×ã¹»Ò»¸ö´Ø
 996   1       {
 997   2        //ÒÔÏÂ¼ÆËãÁ¬Ğø´Ø¶Î£¬ÒÔ¾¡Á¿Ê¹ÓÃ¶àÉÈÇø¶ÁÈ¡Çı¶¯
 998   2        start_clu=end_clu=pfi->File_CurClust;
 999   2      
1000   2        for(iClu=1;iClu<ncluster;iClu++)
1001   2        {
1002   3         next_clu=Get_Next_Cluster(end_clu);
1003   3         if((next_clu-1)==end_clu)
1004   3         {
1005   4          end_clu=next_clu;
1006   4         }
1007   3         else
1008   3         {
1009   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer+have_read);
1010   4              have_read+=((end_clu-start_clu+1)*Cluster_Size);
1011   4              start_clu=end_clu=next_clu;
1012   4         }
1013   3        }
1014   2      
1015   2        //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
1016   2        temp=temp1%Cluster_Size; //¼ÆËãÕû´Ø¶ÁÍêÖ®ºó£¬ÊÇ·ñ»¹ÓĞÊı¾İÒª¶Á
1017   2        if(temp>0) //Õû´ØÊı¾İºóÃæ»¹ÓĞÊı¾İÒª¶Á
1018   2        {
1019   3         temp=temp/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕ²»×ãÕû´ØµÄÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
1020   3      
1021   3         
1022   3      
1023   3         next_clu=Get_Next_Cluster(end_clu);
1024   3         if((next_clu-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÈÔÈ»ÓëÇ°ÃæµÄÁ¬Ğø´Ø¶ÎÁ¬Ğø
1025   3         {
1026   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp),SOC(start_clu),ap
             -p_Buffer+have_read);
1027   4              have_read+=((pInit_Args->BytesPerSector)*((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp));
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 18  

1028   4         }
1029   3         else //Èç¹û×îºóÒ»¸ö´ØÓëÇ°ÃæµÄÁ¬Ğø´Ø¶Î²¢²»Á¬Ğø
1030   3         {
1031   4          znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer+have_read);
1032   4              have_read+=(Cluster_Size*(end_clu-start_clu+1));
1033   4          znFAT_Device_Read_nSector(temp,SOC(next_clu),app_Buffer+have_read);
1034   4              have_read+=(temp*(pInit_Args->BytesPerSector));
1035   4         }
1036   3      
1037   3         pfi->File_CurClust=next_clu;
1038   3         pfi->File_CurSec=(SOC(next_clu)+temp); 
1039   3      
1040   3         //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
1041   3         temp=len-have_read;
1042   3         if(temp>0)
1043   3         {
1044   4          znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«×îºóµÄ¿ÉÄÜ°üº¬Ò»²¿·ÖÒª¶ÁµÄÊı¾İµÄÉÈÇø¶Áµ½Ä
             -Ú²¿»º³åÇø
1045   4          Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp); //½«×îºó²»×ãÉÈÇøµÄÊı¾İÓàÁ¿ÌÜÈëÓ¦ÓÃ»º³åÇø
1046   4        
1047   4          //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
1048   4          pfi->File_CurPos=(UINT16)temp;    
1049   4         }
1050   3         //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
1051   3        }
1052   2        else //Õû´ØÊı¾İ¶ÁÍêÖ®ºóÔÙÎŞÊı¾İÒª¶Á
1053   2        {
1054   3         znFAT_Device_Read_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buff
             -er+have_read);
1055   3      
1056   3         pfi->File_CurClust=end_clu;
1057   3         if(!pfi->File_IsEOF) 
1058   3         {
1059   4          pfi->File_CurClust=Get_Next_Cluster(end_clu);
1060   4         }
1061   3         pfi->File_CurSec=SOC(pfi->File_CurClust); 
1062   3        }
1063   2       }
1064   1       else //Ê£ÓàµÄÊı¾İ²»×ãÒ»¸ö´Ø
1065   1       {
1066   2        temp=temp1/(pInit_Args->BytesPerSector); //¼ÆËãÊ£ÓàµÄÊı¾İ×ã¹»¼¸¸öÉÈÇø
1067   2        znFAT_Device_Read_nSector(temp,SOC(pfi->File_CurClust),app_Buffer+have_read);
1068   2        have_read+=temp*(pInit_Args->BytesPerSector);
1069   2      
1070   2        pfi->File_CurSec+=temp;
1071   2        
1072   2        temp=temp1%(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕµÄ²»×ãÒ»ÉÈÇøµÄÊı¾İÁ¿
1073   2        if(temp>0) //Èç¹û×îºó»¹ÓĞÊı¾İ
1074   2        {
1075   3         znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer);
1076   3         Memory_Copy(app_Buffer+have_read,znFAT_Buffer,temp);
1077   3      
1078   3         pfi->File_CurPos=(UINT16)temp;
1079   3        }
1080   2       }
1081   1      
1082   1       //----------------------------------------------------------------------------------------
1083   1       pfi->File_CurOffset+=len;
1084   1      
1085   1       return len;
1086   1      }
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 19  

1087          #endif
1088          
1089          /******************************************************************************************
1090           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ¶ÁÈ¡+Êı¾İÖØ¶¨Ïò
1091           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Êı¾İ¶ÁÈ¡µÄ¿ªÊ¼Æ«ÒÆÁ¿ len:Òª¶ÁÈ¡µÄ×Ö½ÚÊı
1092                 app_Buffer:Ó¦ÓÃÊı¾İ»º³åÇøÖ¸Õë
1093           ·µ»Ø£ºÊµ¼Ê¶ÁÈ¡µ½µÄÊı¾İ³¤¶È 
1094           Ïê½â£º´Ëº¯ÊıµÄÊµÏÖ¹ı³ÌÓëÉÏÃæµÄÊı¾İ¶ÁÈ¡º¯ÊıÏàËÆ£¬²»Í¬ÔÚÓÚ¿ÉÒÔ¶Ô¶Áµ½µÄÊı¾İ½øĞĞÖØĞÂ¶¨Ïò¡£
1095                 ÉÏÃæµÄÊı¾İ¶ÁÈ¡º¯ÊıÊÇ½«Êı¾İÖ±½Ó·Åµ½ÁËÓ¦ÓÃÊı¾İ»º³åÇøÖĞ£¬µ«ÊÇÔÚÄ³Ğ©Ó²¼şÆ½Ì¨ÉÏRAM×ÊÔ´
1096                 ±È½Ï½ôÕÅ£¬¿ª±Ù³ö½Ï´óµÄÓ¦ÓÃÊı¾İ»º³åÇø²»Ì«ÏÖÊµ£¬Òò´ËÔÚÕâÀïÒıÈëÖØ¶¨ÏòµÄ¸ÅÄî£¬¿ÉÒÔ½«
1097                 ¶Áµ½µÄÃ¿Ò»¸ö×Ö½ÚÊ¹ÓÃÄ³¸öº¯ÊıÖ±½Ó½øĞĞ´¦Àí£¬¶ø²»·ÅÔÚ»º³åÇøÖĞ¡£Õâ¸öÓÃÓÚ´¦Àí×Ö½ÚÊı¾İµÄ
1098                 º¯ÊıÓÉÊ¹ÓÃÕßÌá¹©£¬Õâ¸öº¯ÊıµÄº¯ÊıÃûÔÚznfat.hÖĞ±»ºê¶¨ÒåÎªData_Redirect¡£±ÈÈçÈç¹ûÏë°Ñ
1099                 ¶Áµ½µÄÊı¾İÍ¨¹ı´®¿Ú·¢³ö£¬ÔòÔÚznfat.hÖĞ½«ºê¶¨Òå¸ÄÎª #define Data_Redirect Send_Byte
1100                 Send_Byte¾ÍÊÇ´®¿Ú·¢ËÍ×Ö½ÚµÄº¯ÊıµÄº¯ÊıÃû¡£
1101          ******************************************************************************************/
1102          #ifdef ZNFAT_READDATAX 
              UINT32 znFAT_ReadDataX(struct FileInfo *pfi,UINT32 offset,UINT32 len) //Êı¾İÖØ¶¨Ïò¶ÁÈ¡Ì×ÓÃÁËÊı¾İ¶ÁÈ¡º¯Êı£¬
             -µ«²¢²»Ê¹ÓÃ¶àÉÈÇøÇı¶¯
              {                                                                     //¼ÓÖ®Ã»ÓĞ×ã¹»µÄRAM×ÊÔ´£¬ÇÒÃ¿´Î´¦ÀíÒ
             -»¸ö×Ö½Ú£¬Òò´ËĞ§ÂÊ²»¸ß
               UINT32 Cluster_Size=0,iClu=0,iSec=0,next_clu=0,start_clu=0,end_clu=0;
               UINT32 temp=0,temp1=0,temp2=0,k=0,ncluster=0,have_read=0;
               UINT32 i=0;
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               znFAT_Seek(pfi,offset); //ÎÄ¼ş¶¨Î»
               
               Cluster_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //¼ÆËã´ØµÄ×Ü×Ö½ÚÊı¾İ£¬ÒÔÃâºóÃæÖØ¸´
             -¼ÆËã
               
               if((pfi->File_CurOffset+len)>=(pfi->File_Size)) //Èç¹û´Óµ±Ç°Î»ÖÃ¿ªÊ¼Òª¶ÁÈ¡µÄÊı¾İ³¤¶Èlen²»Ğ¡ÓÚÎÄ¼ş´óĞ¡
               {
                len=(pfi->File_Size-pfi->File_CurOffset);    //¶Ôlen½øĞĞĞŞÕı£¬ÖÃÎªÎÄ¼şÊ£Óà¿É¶ÁÊı¾İÁ¿¡£
                pfi->File_IsEOF=BOOL_TRUE;    //ÕâÖÖÇé¿öÏÂ£¬ÎÄ¼ş±ØÈ»»á¶Áµ½Ä©Î²¡£                    
               }
               
               //=================================================================== 
               if((pfi->File_CurOffset%Cluster_Size)!=0) //Èç¹ûµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡ÕûÊı±¶£¬ËµÃ÷´ËÎ»ÖÃ¼´ÎªÕû´Ø¿ªÊ¼
               {                                         //²»ÒªÔÙ½øĞĞµ±Ç°´ØÄÚÊı¾İ´¦Àí£¬Ö±½Ó½øÈë´Ø-ÉÈÇø-×Ö½Ú½×¶Î
                znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«µ±Ç°ÉÈÇø¶ÁÈëÄÚ²¿»º³åÇø
              
                temp=pInit_Args->BytesPerSector-pfi->File_CurPos; //¼ÆËãµ±Ç°ÉÈÇøÖĞµÄÊ£ÓàÊı¾İÁ¿
                if(len<=temp)
                {
                 for(i=0;i<len;i++)
                 {
                      Data_Redirect(znFAT_Buffer[i+(pfi->File_CurPos)]);
                 }
                 
                 //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
                 if(temp==len) //Èç¹ûÕıºÃ¶Áµ½µ±Ç°ÉÈÇøµÄÄ©Î²
                 {
                  if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))//Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø        
             -             
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 20  

                  {
                   if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
                       {
                        pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
                       }
                   pfi->File_CurSec=SOC(pfi->File_CurClust);
                  }
                  else
                  {
                   pfi->File_CurSec++;        
                  }
                  pfi->File_CurPos=0; 
                 }
                 else
                 {
                  pfi->File_CurPos+=(UINT16)len; 
                 }    
                 pfi->File_CurOffset+=len;
              
                 return len;
                }
                //===================================================================
                else
                {
                 temp=(pInit_Args->BytesPerSector-pfi->File_CurPos); //½«µ±Ç°ÉÈÇøµÄÊ£ÓàÊı¾İÁ¿¸³¸øÖĞ¼ä±äÁ¿temp
              
                 for(i=0;i<temp;i++)
                 {
                      Data_Redirect(znFAT_Buffer[i+(pfi->File_CurPos)]);
                 }
                 
                 have_read+=temp;
                      
                 if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                 {
                  pfi->File_CurSec++;
                  pfi->File_CurPos=0; 
              
                  temp2=(len-have_read); //¼ÆËãÊ£ÓàÊı¾İÁ¿
                  temp1=((LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec-1))*(pInit_Args->BytesPerSector)); //Ê£Ó
             -àËùÓĞÉÈÇøÊı¾İÁ¿
                  if(temp2<=temp1) //Èç¹ûÒª¶ÁµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÊ£ÓàÊı¾İÁ¿ 
                  {
                       //ÕâËµÃ÷Òª¶ÁµÄÊı¾İÔÚµ±Ç°´ØÄÚ£¬Ã»ÓĞ¿çµ½ÏÂÒ»´Ø
                         
                   temp=temp2/(pInit_Args->BytesPerSector); //¼ÆËãÒª¶ÁÈ¡µÄÊ£ÓàÊı¾İ×ã¹»¼¸¸öÕûÉÈÇø 
              
                       for(iSec=0;iSec<temp;iSec++)
                       {
                        znFAT_Device_Read_Sector(pfi->File_CurSec+iSec,znFAT_Buffer);
                        for(i=0;i<(pInit_Args->BytesPerSector);i++)
                        {
                         Data_Redirect(znFAT_Buffer[i]);
                        }
                       }
                       
                       have_read+=temp*(pInit_Args->BytesPerSector);
              
                   if(temp2==temp1)
                   {
                    if(!pfi->File_IsEOF) //Èç¹û²»ÊÇÎÄ¼şÄ©Î²
                        {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 21  

                         pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //¿ÉÄÜÓĞ¡°¾½´Ø¡± 
                        }
                    pfi->File_CurSec=SOC(pfi->File_CurClust); 
                    pfi->File_CurPos=0;
                   }
                   else
                   {
                    pfi->File_CurSec+=temp; 
                        temp=len-have_read;
              
                    znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //µ±Ç°ÉÈÇøÖĞ¿ÉÄÜ»¹ÓĞ²¿·ÖÊ£ÓàÊı¾İÒª¶Á
                    for(i=0;i<temp;i++)
                        {
                         Data_Redirect(znFAT_Buffer[i]);
                        }
                    //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı
                    pfi->File_CurPos=(UINT16)temp;
                    
                   }
                   pfi->File_CurOffset+=len; 
                  
                   return len;
                  }
                  else //Èç¹ûÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı²»Ğ¡ÓÚµ±Ç°´ØµÄÊ£ÓàÉÈÇøÊı£¬¼´Òª¶ÁµÄÊı¾İ²»¹âÔÚµ±Ç°´ØÄÚ£¬ÒÑ¾­¿ç´ØÁË
                  {
                       temp=(LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File_CurSec)+1; //¼ÆËãµ±Ç°´Ø»¹ÓĞ¼¸¸öÕûÉÈÇø 
              
                       for(iSec=0;iSec<temp;iSec++)
                       {
                        znFAT_Device_Read_Sector(pfi->File_CurSec+iSec,znFAT_Buffer);
                        for(i=0;i<(pInit_Args->BytesPerSector);i++)
                        {
                         Data_Redirect(znFAT_Buffer[i]);
                        }
                       }
                       have_read+=temp*(pInit_Args->BytesPerSector);
                  }
                 }
                
                 //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±ÒÑ¾­¶ÁÍêµ±Ç°´ØµÄËùÓĞÊ£ÓàÊı¾İ£¬¿çµ½ÏÂÒ»´Ø
                 pfi->File_CurClust=Get_Next_Cluster(pfi->File_CurClust); //ÕâÀï²»»á²úÉú¡°¾½´Ø¡± 
                 pfi->File_CurSec=SOC(pfi->File_CurClust); 
                 pfi->File_CurPos=0;    
                }
               }
               //----------------------------ÒÔÉÏÊÇ´¦Àíµ±Ç°´ØÄÚµÄÊı¾İ-------------------------------------
               temp1=len-have_read;
               ncluster=temp1/Cluster_Size; //¼ÆËãÊ£ÓàÊı¾İµÄÕû´ØÊı
              
               if(ncluster>0) //Ê£ÓàÊı¾İÆğÂë×ã¹»Ò»¸ö´Ø
               {
                //ÒÔÏÂ¼ÆËãÁ¬Ğø´Ø¶Î£¬ÒÔ¾¡Á¿Ê¹ÓÃ¶àÉÈÇø¶ÁÈ¡Çı¶¯
                start_clu=end_clu=pfi->File_CurClust;
              
                for(iClu=1;iClu<ncluster;iClu++)
                {
                 next_clu=Get_Next_Cluster(end_clu);
                 if((next_clu-1)==end_clu)
                 {
                  end_clu=next_clu;
                 }
                 else
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 22  

                 {
                  temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                  for(iSec=0;iSec<temp;iSec++)
                      {
                       znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
                       for(i=0;i<(pInit_Args->BytesPerSector);i++)
                       {
                        Data_Redirect(znFAT_Buffer[i]);
                       }
                      }
                  have_read+=temp*(pInit_Args->BytesPerSector);
                      start_clu=end_clu=next_clu;
                 }
                }
              
                //----------------------------ÒÔÉÏÊÇ´¦ÀíÕû´ØÊı¾İ------------------------------------------  
                temp=temp1%Cluster_Size; //¼ÆËãÕû´Ø¶ÁÍêÖ®ºó£¬ÊÇ·ñ»¹ÓĞÊı¾İÒª¶Á
                if(temp>0) //Õû´ØÊı¾İºóÃæ»¹ÓĞÊı¾İÒª¶Á
                { 
                 temp=temp/(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕ²»×ãÕû´ØµÄÊ£ÓàÊı¾İµÄÕûÉÈÇøÊı
                 next_clu=Get_Next_Cluster(end_clu);
                 if((next_clu-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÈÔÈ»ÓëÇ°ÃæµÄÁ¬Ğø´Ø¶ÎÁ¬Ğø
                 {
                  temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp);
                  for(iSec=0;iSec<temp2;iSec++)
                      {
                       znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
              
                       for(i=0;i<(pInit_Args->BytesPerSector);i++)
                       {
                        Data_Redirect(znFAT_Buffer[i]);
                       }
                      }
                 }
                 else //Èç¹û×îºóÒ»¸ö´ØÓëÇ°ÃæµÄÁ¬Ğø´Ø¶Î²¢²»Á¬Ğø
                 {
                      temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                  for(iSec=0;iSec<temp2;iSec++)
                      {
                       znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
              
                       for(i=0;i<(pInit_Args->BytesPerSector);i++)
                       {
                        Data_Redirect(znFAT_Buffer[i]);
                       }
                      }
              
                  for(iSec=0;iSec<temp;iSec++)
                      {
                       znFAT_Device_Read_Sector(SOC(next_clu)+iSec,znFAT_Buffer);
              
                       for(i=0;i<(pInit_Args->BytesPerSector);i++)
                       {
                        Data_Redirect(znFAT_Buffer[i]);
                       }
                      }
                 }
                 
                 have_read+=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+temp)*(pInit_Args->BytesPerSector);
              
                 pfi->File_CurClust=next_clu;
                 pfi->File_CurSec=(SOC(next_clu)+temp); 
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 23  

              
                 //----------------------------ÒÔÉÏÊÇ´¦ÀíÕûÉÈÇøÊı¾İ----------------------------------------
                 temp=len-have_read;
                 if(temp>0)
                 {
                  znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //½«×îºóµÄ¿ÉÄÜ°üº¬Ò»²¿·ÖÒª¶ÁµÄÊı¾İµÄÉÈÇø¶Áµ½Ä
             -Ú²¿»º³åÇø
                
                      for(i=0;i<temp;i++)
                      {
                       Data_Redirect(znFAT_Buffer[i]);
                      }
              
                  //¸üĞÂµ±Ç°Î»ÖÃ²ÎÊı£¬´ËÊ±Êı¾İ¶ÁÈ¡²Ù×÷ÒÑ¾­½áÊø
                  pfi->File_CurPos=(UINT16)temp;    
                 }
                 //----------------------------ÒÔÉÏÊÇ´¦Àí×îºóÉÈÇøÄÚµÄÊ£Óà×Ö½Ú----------------------------------------
                }
                else //Õû´ØÊı¾İ¶ÁÍêÖ®ºóÔÙÎŞÊı¾İÒª¶Á
                {
                 temp2=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
                 for(iSec=0;iSec<temp2;iSec++)
                 {
                      znFAT_Device_Read_Sector(SOC(start_clu)+iSec,znFAT_Buffer);
                      for(i=0;i<(pInit_Args->BytesPerSector);i++)
                      {
                       Data_Redirect(znFAT_Buffer[i]);
                      }
                 }
              
                 pfi->File_CurClust=end_clu;
                 if(!pfi->File_IsEOF) 
                 {
                  pfi->File_CurClust=Get_Next_Cluster(end_clu);
                 }
                 pfi->File_CurSec=SOC(pfi->File_CurClust); 
                }
               }
               else //Ê£ÓàµÄÊı¾İ²»×ãÒ»¸ö´Ø
               {
                temp=temp1/(pInit_Args->BytesPerSector); //¼ÆËãÊ£ÓàµÄÊı¾İ×ã¹»¼¸¸öÉÈÇø
                for(iSec=0;iSec<temp;iSec++)
                {
                 znFAT_Device_Read_Sector(SOC(pfi->File_CurClust)+iSec,znFAT_Buffer);
                 for(i=0;i<(pInit_Args->BytesPerSector);i++)
                 {
                      Data_Redirect(znFAT_Buffer[i]);
                 }
                }
              
                pfi->File_CurSec+=temp;
                
                temp=temp1%(pInit_Args->BytesPerSector); //¼ÆËã×îÖÕµÄ²»×ãÒ»ÉÈÇøµÄÊı¾İÁ¿
                if(temp>0) //Èç¹û×îºó»¹ÓĞÊı¾İ
                {
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer);
                 for(i=0;i<temp;i++)
                 {
                      Data_Redirect(znFAT_Buffer[i]);
                 }
              
                 pfi->File_CurPos=temp;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 24  

                }
               }
              
               //----------------------------------------------------------------------------------------
               pfi->File_CurOffset+=len;
              
               return len;
              }
              #endif
1400          
1401          //----------------------------ÒÔÏÂº¯ÊıÓÃÓÚ¼ìÑéÎÄ¼şÃûµÄºÏ·¨ĞÔ----------------------------------
1402          
1403          /******************************************************************************************
1404           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞÊÇ·ñº¬ÓĞ·Ç·¨×Ö·û£¬·Ç·¨×Ö·ûÓĞ \/:"<>| 
1405           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1406           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü  ³É¹¦£ºÎÄ¼şÃûÖĞÎŞ·Ç·¨×Ö·û£¬·´Ö®ÔòÓĞ 
1407           Ïê½â£º¶ÔÓÚÎÄ¼şÃûÖĞ·Ç·¨×Ö·ûµÄ¼ì²é£¬ÆäÊµ»¹ÓĞÁ½¸ö×Ö·û*?£¬µ«ÊÇznFATÊÇÖ§³ÖÎÄ¼şÃûµÄÍ¨ÅäµÄ£¬Òò´Ë
1408                 ÕâÀï²»ÏŞÖÆ*Óë?£¬ÔÚ´ò¿ªÎÄ¼şºÍÄ¿Â¼µÄÊ±ºòËùÊ¹ÓÃµÄÎÄ¼şÃûÖĞÊÇ´øÓĞ*Óë?£¬µ«´´½¨ÎÄ¼şºÍÄ¿Â¼Ê±
1409                 ÎÄ¼şÃûÖĞÔò²»¿ÉÓĞ*Óë?£¬ÇëÊ¹ÓÃÕß×¢Òâ£¡
1410          ******************************************************************************************/
1411          #ifdef CHECK_ILLEGAL_CHAR
1412          UINT8 Check_Illegal_Char(INT8 *pfn) 
1413          {
1414   1       UINT32 i=0;
1415   1       while(pfn[i])
1416   1       {
1417   2        if(('\\'==pfn[i]) || ('/'==pfn[i]) || (':'==pfn[i])  
1418   2         || /*('*'==pfn[i]) || ('?'==pfn[i]) ||*/ ('"'==pfn[i])  
1419   2         || ('<'==pfn[i]) || ('>'==pfn[i]) || ('|'==pfn[i]))
1420   2        return ERR_FAIL;
1421   2        i++;
1422   2       }
1423   1       return ERR_SUCC;
1424   1      }
1425          #endif
1426          
1427          /******************************************************************************************
1428           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞÊÇ·ñº¬ÓĞÌØÊâ×Ö·û£¬+[],;=space
1429           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1430           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü  ³É¹¦£ºÎÄ¼şÃûÖĞÎŞÌØÊâ×Ö·û£¬·´Ö®ÔòÓĞ 
1431           Ïê½â£º¶ÔÓÚ8.3¸ñÊ½µÄÎÄ¼şÃû£¬Èç¹ûÆäÖĞ°üº¬ÁËÌØÊâ×Ö·û£¬ÔòÆä±»ÊÓÎª³¤ÎÄ¼şÃû£¬¶ø·Ç¶ÌÃû¡£ÒòÎª¶ÌÃû
1432                 Óë³¤ÃûÔÚ´¦Àí·½·¨ÊÇ²»Í¬µÄ£¬Òò´Ë¶ÔËüÃÇÇø·Ö¿ªÀ´¡£SFNÊÇShort FileNameµÄËõĞ´£¬´øÓĞSFNµÄº¯
1433                 ÊÇÕë¶Ô¶ÌÃûµÄ¼ì²é
1434          ******************************************************************************************/
1435          #ifdef CHECK_SFN_SPECIAL_CHAR
1436          UINT8 Check_SFN_Special_Char(INT8 *pfn) 
1437          {
1438   1       UINT32 i=0;
1439   1       UINT32 pos=(StringLen(pfn)-1);
1440   1      
1441   1       while(' '==pfn[pos]) pos--;
1442   1       
1443   1       while(i<=pos)
1444   1       {
1445   2        if( ('+'==pfn[i]) || ('['==pfn[i]) 
1446   2         || (']'==pfn[i]) || (','==pfn[i])
1447   2         || (' '==pfn[i]) || (';'==pfn[i])
1448   2         || ('='==pfn[i]))
1449   2        return ERR_FAIL;
1450   2        i++;
1451   2       }
1452   1      
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 25  

1453   1       return ERR_SUCC;
1454   1      }
1455          #endif
1456          
1457          /******************************************************************************************
1458           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÖĞµÄ.ÊÇ·ñ·ûºÏSFNÒªÇó
1459           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1460           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1461           Ïê½â£ºSFNÖĞµÄ.²»µÃ¶àÓÚ1¸ö£¬ÈçA..A.TXT¡¢A.A.A¡¢AA.A..AµÈ¾ù·ÇSFN£¬ÎÄ¼şÃû²»µÃÒÔ.¿ªÊ¼
1462                 Èô¸É¸ö.Èç¹ûÔÚÄ©Î²Ôò¾ù±»ºöÂÔ
1463          ******************************************************************************************/
1464          #ifdef CHECK_SFN_DOT
1465          UINT8 Check_SFN_Dot(INT8 *pfn) 
1466          {
1467   1       UINT32 pos=(StringLen(pfn)-1);
1468   1       UINT32 dot_counter=0;
1469   1      
1470   1       if('.'==pfn[0]) return ERR_FAIL;
1471   1      
1472   1       while(pos>0) 
1473   1       {
1474   2        if('.'==pfn[pos])
1475   2        {
1476   3         dot_counter++;
1477   3        }
1478   2        pos--;
1479   2       }
1480   1      
1481   1       if(dot_counter>1) return ERR_FAIL;
1482   1       else return ERR_SUCC;
1483   1      }
1484          #endif
1485          
1486          /******************************************************************************************
1487           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûµÄ´óĞ¡Ğ´ÊÇ·ñ·ûºÏSFNÒªÇó
1488           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1489           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1490           Ïê½â£ºSFNÖĞÊÇ²»¿ÉÄÜÓĞ´óĞ¡Ğ´»ìÅÅµÄ£¬±ÈÈçAabcC.txt ABC.Txt AbCdef.TXT¶¼²»ÊÇSFN£¬¶øÊÇ³¤Ãû
1491                 ¼òÑÔÖ®£¬SFNµÄÖ÷ÎÄ¼şÃûºÍÀ©Õ¹Ãû±ØĞë¾ùÊÇ´óĞ´»òĞ¡Ğ´£¬±ÈÈçaaa.TXT AAA.txt aaa.txt AA.TXT
1492                 ¾ùÊÇSFN
1493          ******************************************************************************************/
1494          #ifdef CHECK_SFN_ILLEGAL_LOWER
1495          UINT8 Check_SFN_Illegal_Lower(INT8 *pfn)
1496          {
1497   1       UINT32 i=(StringLen(pfn)-1);
1498   1       UINT8 flag1=2,flag2=2; 
1499   1      
1500   1       while('.'!=pfn[i] && i>0)
1501   1       {
1502   2        if(pfn[i]>='a' && pfn[i]<='z') 
1503   2        {
1504   3         if(0==flag1)
1505   3         {
1506   4              return (UINT8)-1;
1507   4         }
1508   3         flag1=1;
1509   3        }
1510   2      
1511   2        if(pfn[i]>='A' && pfn[i]<='Z') 
1512   2        {
1513   3         if(1==flag1)
1514   3         {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 26  

1515   4              return (UINT8)-1;
1516   4         }
1517   3         flag1=0;
1518   3        }
1519   2      
1520   2        i--;
1521   2       }
1522   1      
1523   1       if(0==i) //Èç¹ûÃ»ÓĞ.ËµÃ÷Ã»ÓĞÀ©Õ¹Ãû
1524   1       { 
1525   2        if(pfn[0]>='a' && pfn[0]<='z') 
1526   2        {
1527   3         if(0==flag1)
1528   3         {
1529   4              return (UINT8)-1;
1530   4         }
1531   3         flag1=1;
1532   3        }
1533   2      
1534   2        flag2=flag1; 
1535   2        flag1=0;
1536   2       }
1537   1      
1538   1       if('.'==pfn[i])
1539   1       {
1540   2        i--;
1541   2       }
1542   1      
1543   1       while(i>0)
1544   1       {
1545   2        if(pfn[i]>='a' && pfn[i]<='z') 
1546   2        {
1547   3         if(0==flag2)
1548   3         {
1549   4              return (UINT8)-1;
1550   4         }
1551   3         flag2=1;
1552   3        }
1553   2      
1554   2        if(pfn[i]>='A' && pfn[i]<='Z') 
1555   2        {
1556   3         if(1==flag2)
1557   3         {
1558   4              return (UINT8)-1;
1559   4         }
1560   3         flag2=0;
1561   3        }
1562   2      
1563   2        i--;  
1564   2       }
1565   1      
1566   1       if(2==flag2)
1567   1       {
1568   2        if(pfn[0]>='a' && pfn[0]<='z') 
1569   2        {
1570   3         flag2=1;
1571   3        }
1572   2        if(pfn[0]>='A' && pfn[0]<='Z')
1573   2        {
1574   3         flag2=0;
1575   3        }
1576   2       }
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 27  

1577   1       
1578   1       return (UINT8)((flag1<<4)|(flag2));
1579   1      }
1580          #endif
1581          
1582          /******************************************************************************************
1583           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûµÄ³¤¶ÈÊÇ·ñ·ûºÏSFNÒªÇó
1584           ĞÎ²Î£ºpfn:Ö¸ÕëÎÄ¼şÃûµÄÖ¸Õë
1585           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1586           Ïê½â£º8.3¸ñÊ½µÄSFN£¬ÒªÇóÖ÷ÎÄ¼şÃûµÄ³¤¶È0<len<=8 À©Õ¹Ãû³¤¶È0<=len<=3£¬²»·ûºÏÕâÒ»ÒªÇóµÄ¾ùÎª³¤
1587                 Ãû
1588          ******************************************************************************************/
1589          #ifdef CHECK_SFN_ILLEGAL_LENGTH
1590          UINT8 Check_SFN_Illegal_Length(INT8 *pfn)
1591          {
1592   1       UINT8 dot_pos=0,have_dot=0,i=0;
1593   1       UINT8 mainfn_len=0,extfn_len=0;
1594   1       UINT32 fn_len=StringLen(pfn);
1595   1      
1596   1       while(' '==pfn[fn_len-1]) fn_len--;
1597   1      
1598   1       if(fn_len>12) return ERR_FAIL; //fn is longer than 8.3
1599   1      
1600   1       for(i=(UINT8)(fn_len-1);i>0;i--) //·´ÏòÑ°ÕÒ. µÚÒ»¸ö.ÊÇÖ÷ÎÄ¼şÓëÀ©Õ¹ÃûµÄ·Ö½ç
1601   1       {
1602   2        if('.'==pfn[i]) 
1603   2        {
1604   3         dot_pos=i;
1605   3         have_dot=1;
1606   3         break;
1607   3        }
1608   2       }
1609   1       
1610   1       if(0==have_dot) //Ã»ÓĞµã
1611   1       {
1612   2        mainfn_len=(UINT8)fn_len;
1613   2        extfn_len=0;
1614   2      
1615   2        if((mainfn_len>0 && mainfn_len<=8))
1616   2        {
1617   3         return ERR_SUCC;
1618   3        }
1619   2        else
1620   2        {
1621   3         return ERR_FAIL;
1622   3        }
1623   2       }
1624   1       else //ÓĞµã
1625   1       {
1626   2        mainfn_len=dot_pos;
1627   2        extfn_len=(UINT8)(((UINT8)fn_len)-(UINT8)(dot_pos+1));
1628   2      
1629   2        if(( mainfn_len>0  && mainfn_len<=8) 
1630   2         && (/*extfn_len>=0  && */extfn_len <=3))
1631   2        {
1632   3         return ERR_SUCC;
1633   3        }
1634   2        else
1635   2        {
1636   3         return ERR_FAIL;
1637   3        }
1638   2       }      
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 28  

1639   1      }
1640          #endif
1641          //--------------------------------ÒÔÉÏº¯ÊıÓÃÓÚ¼ìÑéSFNµÄºÏ·¨ĞÔ----------------------------------
1642          
1643          /******************************************************************************************
1644           ¹¦ÄÜ£º½«Ò»¸öÎÄ¼şÄ¿Â¼ÏîÖĞµÄÇ°11¸ö×Ö½Ú£¨ÓÃÓÚ¼ÇÂ¼8.3¶ÌÎÄ¼şÃû£©×ªÎªÎÄ¼şÃû
1645           ĞÎ²Î£ºname_in_fdi:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÖĞÓÃÓÚ¼ÇÂ¼ÎÄ¼şÃûµÄ×Ö½ÚĞòÁĞµÄÖ¸Õë pfilename:ÓÃÓÚ¼ÇÂ¼×ª»»ºóµÄ
1646                 ÎÄ¼şÃûµÄÊı×éµÄÖ¸Õë
1647           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»òÊ§°Ü
1648           Ïê½â£ºÔÚ´ò¿ªÎÄ¼şºÍÄ¿Â¼µÈº¯ÊıÖĞ£¬°ÑÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼şÃû×Ö¶Î×ªÎªÎÄ¼şÃû£¬ÒÔ·½±ãÓëÄ¿±êÎÄ¼ş½øĞĞ
1649                 Æ¥ÅäºÍ±È¶Ô¡£±ÈÈçÒª´ò¿ªABC.TXT ËüËù¶ÔÓ¦µÄÎÄ¼şÄ¿Â¼Ïî¼ÇÂ¼µÄĞÎÊ½ÎªABC     TXT£¬¶şÕßÊÇ²»ÄÜ
1650                 Ö±½Ó½øĞĞ±È½ÏµÄ£¬ÒªÏÈ½«ABC     TXT×ªÎªABC.TXT£¬È»ºóÔÙ±È½Ï¡£
1651          ******************************************************************************************/
1652          #ifdef TO_FILE_NAME
1653          UINT8 To_File_Name(INT8 *name_in_fdi,INT8 *pfileName)
1654          {
1655   1       UINT8 i=0,n=7,m=10;
1656   1      
1657   1       while(' '==name_in_fdi[n])
1658   1       {
1659   2        n--;
1660   2       }
1661   1       n++;
1662   1      
1663   1       while(' '==name_in_fdi[m] && m>=8)
1664   1       {
1665   2        m--;
1666   2       }
1667   1       m-=7;
1668   1      
1669   1       for(i=0;i<n;i++)
1670   1       {
1671   2        pfileName[i]=name_in_fdi[i];
1672   2       }
1673   1       pfileName[i]='.';
1674   1      
1675   1       for(i=0;i<m;i++)
1676   1       {
1677   2        pfileName[n+i+1]=name_in_fdi[8+i];
1678   2       }
1679   1      
1680   1       if('.'==pfileName[n+m]) pfileName[n+m]=0;
1681   1       else pfileName[n+m+1]=0;
1682   1      
1683   1       return 0;
1684   1      }
1685          #endif
1686          
1687          /******************************************************************************************
1688           ¹¦ÄÜ£º½âÎöÒ»¸öÎÄ¼şÄ¿Â¼Ïî£¬½«½âÎöµÃµ½µÄ²ÎÊı×°Èëµ½ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞ
1689           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë pFDI:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
1690           ·µ»Ø£º0
1691           Ïê½â£º´Ëº¯Êı±»´ò¿ªÎÄ¼şµÄº¯Êıµ÷ÓÃ£¬¶Ô·ûºÏÆ¥ÅäÌõ¼şµÄÎÄ¼şÄ¿Â¼Ïî½øĞĞ½âÎö£¬²¢½«²ÎÊı×°Èëµ½ÎÄ¼şĞÅ
1692                 Ï¢¼¯ºÏÖĞ£¬ÒÔ±ã¶ÔÎÄ¼ş½øĞĞ½øÒ»²½µÄ²Ù×÷Ê±Ê¹ÓÃ¡£
1693          ******************************************************************************************/
1694          #ifdef ANALYSE_FDI
1695          UINT8 Analyse_FDI(struct FileInfo *pfi,struct FDI *pFDI)
1696          {
1697   1       UINT32 temp=0,i=0;
1698   1      
1699   1       //==========================================================
1700   1      
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 29  

1701   1       just_file=pfi;
1702   1      
1703   1       To_File_Name((INT8 *)pFDI,pfi->File_Name);
1704   1       
1705   1       temp=(StringLen(pfi->File_Name)-1);
1706   1       while('.'!=(pfi->File_Name)[temp] && temp>0)
1707   1       {
1708   2        if(((pFDI->LowerCase)&0x10)!=0) 
1709   2        {
1710   3         (pfi->File_Name)[temp]=(INT8)Upper2Low((pfi->File_Name)[temp]);
1711   3        }
1712   2        temp--;
1713   2       }
1714   1       if(((pFDI->LowerCase)&0x08)!=0) 
1715   1       {
1716   2        for(i=0;i<temp;i++)
1717   2        {
1718   3         (pfi->File_Name)[i]=(INT8)Upper2Low((pfi->File_Name)[i]);   
1719   3        }
1720   2       }
1721   1      
1722   1       temp=(StringLen(pfi->File_Name)-1); 
1723   1       if(CHK_ATTR_DIR(pFDI->Attributes)) //Èç¹ûÊÇÄ¿Â¼Ôò½«×îºóµÄ.È¥µô
1724   1       {
1725   2        (pfi->File_Name)[temp+1]='\0';
1726   2       }
1727   1       //==ÒÔÉÏÊÇ°´ÕÕLowerCase×Ö½Ú¶ÔÖ÷ÎÄ¼şÃûÓëÀ©Õ¹ÎÄ¼şÃû½øĞĞĞ¡Ğ´»¯
1728   1      
1729   1       pfi->File_Attr=pFDI->Attributes; //ÎÄ¼şÊôĞÔ
1730   1       pfi->File_StartClust=Bytes2Value(pFDI->LowClust,2)+Bytes2Value(pFDI->HighClust,2)*65536;
1731   1       pfi->File_Size=Bytes2Value(pFDI->FileSize,4);
1732   1        
1733   1       //½âÎöÎÄ¼ş´´½¨Ê±¼äÓëÈÕÆÚ
1734   1       temp=Bytes2Value(pFDI->CTime,2);
1735   1       pfi->File_CTime.sec=(UINT8)((temp&TIME_SEC_MARK)*2); temp>>=TIME_SEC_NBITS;  //´´½¨Ê±¼äµÄ2ÃëÎ»
1736   1       pfi->File_CTime.min=(UINT8)(temp&TIME_MIN_MARK);   temp>>=TIME_MIN_NBITS; //´´½¨Ê±¼äµÄ·ÖÎ»
1737   1       pfi->File_CTime.hour=(UINT8)(temp&TIME_HOUR_MARK); //´´½¨Ê±¼äµÄÊ±Î»
1738   1       pfi->File_CTime.sec+=(UINT8)((UINT16)(pFDI->CTime10ms)/100); //ÔÚÃëÉÏ¼ÓÉÏ10ºÁÃëÎ»
1739   1      
1740   1       temp=Bytes2Value(pFDI->CDate,2);
1741   1       pfi->File_CDate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1742   1       pfi->File_CDate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1743   1       pfi->File_CDate.year=(UINT16)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»£¨¼ÓÉÏÄê·İ»ùÊı£©
1744   1      
1745   1       //½âÎöÎÄ¼şĞŞ¸ÄÊ±¼äÓëÈÕÆÚ
1746   1       //temp=Bytes2Value(pFDI->MTime,2);
1747   1       //pfi->File_MTime.sec=(UINT8)((temp&TIME_SEC_MARK)*2); temp>>=TIME_SEC_NBITS;  //´´½¨Ê±¼äµÄ2ÃëÎ»
1748   1       //pfi->File_MTime.min=(UINT8)(temp&TIME_MIN_MARK);   temp>>=TIME_MIN_NBITS; //´´½¨Ê±¼äµÄ·ÖÎ»
1749   1       //pfi->File_MTime.hour=(UINT8)(temp&TIME_HOUR_MARK); //´´½¨Ê±¼äµÄÊ±Î»
1750   1       //ÎÄ¼şµÄĞŞ¸ÄÊ±¼äÃ»ÓĞ10ºÁÃëÎ»£¬ËùÒÔËüÖ»ÄÜ±í´ïÅ¼ÊıÃë
1751   1      
1752   1       //temp=Bytes2Value(pFDI->MDate,2);
1753   1       //pfi->File_MDate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1754   1       //pfi->File_MDate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1755   1       //pfi->File_MDate.year=(UINT8)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»
1756   1      
1757   1       //½âÎöÎÄ¼ş·ÃÎÊÈÕÆÚ
1758   1       //temp=Bytes2Value(pFDI->ADate,2);
1759   1       //pfi->File_ADate.day=(UINT8)(temp&DATE_DAY_MARK);     temp>>=DATE_DAY_NBITS;   //´´½¨ÈÕÆÚµÄÈÕÎ»
1760   1       //pfi->File_ADate.month=(UINT8)(temp&DATE_MONTH_MARK); temp>>=DATE_MONTH_NBITS; //´´½¨ÈÕÆÚµÄÔÂÎ»
1761   1       //pfi->File_ADate.year=(UINT8)((temp&DATE_YEAR_MARK)+DATE_YEAR_BASE); //´´½¨ÈÕÆÚµÄÄêÎ»
1762   1      
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 30  

1763   1       pfi->File_CurClust=pfi->File_StartClust;
1764   1       pfi->File_CurSec=(pfi->File_CurClust)?SOC(pfi->File_CurClust):0;
1765   1       pfi->File_CurPos=0;
1766   1       pfi->File_CurOffset=0;
1767   1       pfi->File_IsEOF=(UINT8)((pfi->File_StartClust)?BOOL_FALSE:BOOL_TRUE);
1768   1      
1769   1       return 0;
1770   1      }
1771          #endif
1772          
1773          /******************************************************************************************
1774           ¹¦ÄÜ£º¼ì²éÎÄ¼şÃûÊÇ·ñÊÇÍ¨ÅäÃû£¬Í¨ÅäÃûÖĞº¬ÓĞ*Óë?
1775           ĞÎ²Î£ºpfn:Ö¸ÏòÎÄ¼şÃûµÄÖ¸Õë
1776           ·µ»Ø£ºÔËĞĞ½á¹û ÊÇ»ò·ñ
1777           Ïê½â£ºznFATÊÇÖ§³ÖÍ¨ÅäÃûµÄ£¬¶ÔÓÚÍ¨ÅäÃûznFATÖĞÊÇ²»¶ÔÆä½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²éµÄ¡£ÇëÊ¹ÓÃÕß×ÔĞĞ
1778                 ×¢Òâ¡£
1779          ******************************************************************************************/
1780          #ifdef IS_WILDFILENAME
1781          UINT8 Is_WildFileName(INT8 *pfn)
1782          { 
1783   1       UINT8 i=0;
1784   1       while('\0'!=pfn[i])
1785   1       {
1786   2        if('*'==pfn[i] || '?'==pfn[i])
1787   2        {
1788   3         return 1;
1789   3        }
1790   2        i++;
1791   2       }
1792   1       return 0;
1793   1      }
1794          #endif
1795          
1796          /******************************************************************************************
1797           ¹¦ÄÜ£ºÔÚÒ»¸ö×Ö·û´®ÖĞ²éÕÒÒ»¸ö×Ó´®
1798           ĞÎ²Î£ºstr:×Ö·û´® substr:×Ó´® pos:´Ó×Ö·û´®µÄposÎ»ÖÃ¿ªÊ¼²éÕÒ×Ó´®
1799           ·µ»Ø£º×Ó´®ÔÚ×Ö·û´®ÖĞµÄ¿ªÊ¼Î»ÖÃ
1800           Ïê½â£º
1801          ******************************************************************************************/
1802          #ifdef FINDSUBSTR
1803          UINT8 FindSubStr(INT8 *str,INT8 *substr,UINT8 pos)
1804          {
1805   1       UINT8 i=pos,j=0,lens=(UINT8)StringLen(str),lent=(UINT8)StringLen(substr);
1806   1      
1807   1       while(i<lens && j<lent)
1808   1       {
1809   2        if(str[i]==substr[j] || '?'==substr[j])
1810   2        {
1811   3         i++;
1812   3         j++;
1813   3        }
1814   2        else
1815   2        {
1816   3         i=(UINT8)(i-j+1);
1817   3         j=0;
1818   3        }
1819   2       }
1820   1       if(j==lent) return (UINT8)(i-lent); 
1821   1       else return (UINT8)0XFF;
1822   1      }
1823          #endif
1824          
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 31  

1825          /*********************************************************************************************
1826           ¹¦ÄÜ£ºÎÄ¼şÃûÆ¥Åä£¬Ö§³Ö*Óë?Í¨Åä
1827           ĞÎ²Î£ºt:Ä£°åÎÄ¼şÃû£¬¼´Ê¹ÓÃÕßÊäÈëµÄÎÄ¼şÃû s:Ä¿±êÎÄ¼şÃû  ÀıÈçtÎªa*b.txt sÎªaxxb.txt£¬ËüÃÇÊÇÆ¥ÅäµÄ
1828                 ÔÙÈçtÎªa???x.t* sÎªaxyzx.txt£¬ËüÃÇÊÇÆ¥ÅäµÄ¡£
1829           ·µ»Ø£ºÔËĞĞ½á¹û ÊÇ»ò·ñ
1830           Ïê½â£ºÕâÒ»Æ¥ÅäËã·¨»ùÓÚ×Ó´®Æ¥Åä£¬²¢²»±£Ö¤Âú×ãÒ»ÇĞÇé¿ö¡£ÆäËã·¨Ç¿¶È²»¿ÉÓëDOSÉÏµÄÍ¨ÅäÏàÌá²¢ÂÛ¡£
1831          **********************************************************************************************/
1832          #ifdef SFN_MATCH
1833          UINT8 SFN_Match(INT8 *t,INT8 *s)
1834          {
1835   1       UINT8 i=0,j=0,lens=(UINT8)StringLen(s);
1836   1       UINT8 lent=(UINT8)StringLen(t);
1837   1       INT8 buf[20];
1838   1       UINT8 bufp=0;
1839   1      
1840   1       //======================================================
1841   1       
1842   1       while(j<lent && '*'!=t[j])
1843   1       {
1844   2        buf[bufp]=(INT8)Lower2Up(t[j]);
1845   2        bufp++;
1846   2        j++;
1847   2       }
1848   1      
1849   1       if('\0'==t[j] && (lent!=lens)) return ERR_FAIL;
1850   1      
1851   1       buf[bufp]='\0';
1852   1       
1853   1       if(FindSubStr(s,buf,0)!=0) return ERR_FAIL;
1854   1       i=bufp;
1855   1       
1856   1       while(1)
1857   1       {
1858   2        while(j<lent && '*'==t[j]) j++;
1859   2        if(j==lent) return ERR_SUCC;
1860   2        bufp=0;
1861   2      
1862   2        while(j<lent && '*'!=t[j])
1863   2        {
1864   3         buf[bufp]=(INT8)Lower2Up(t[j]);
1865   3         bufp++;
1866   3         j++;
1867   3        }
1868   2        buf[bufp]='\0';
1869   2        
1870   2        if(j==lent)
1871   2        {
1872   3         if(FindSubStr(s,buf,i)!=(lens-bufp)) return ERR_FAIL;
1873   3         return ERR_SUCC;
1874   3        }
1875   2      
1876   2        i=FindSubStr(s,buf,i);
1877   2        if(0XFF==i) return ERR_FAIL;
1878   2        i+=bufp;
1879   2       }
1880   1      }
1881          #endif
1882          
1883          /*********************************************************************************************
1884           ¹¦ÄÜ£ºĞŞ¸ÄFAT±íµÄÄ³¸ö±íÏî
1885           ĞÎ²Î£ºcluster:ÒªĞŞ¸ÄµÄ´ØÏîºÅ next_cluster:ÒªÏò´ØÏîÖĞĞ´ÈëµÄÖµ 
1886           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 32  

1887           Ïê½â£º´Ëº¯ÊıÊ¹clusterÁ´Ïònext_cluster Èç¹ûclusterÎª0»ò1Ôò·ÅÆú²Ù×÷£¬ÒòÎªÓĞĞ§µÄ´ØºÅÊÇ´Ó2¿ªÊ¼µÄ
1888          **********************************************************************************************/
1889          #ifdef MODIFY_FAT
              UINT8 Modify_FAT(UINT32 cluster,UINT32 next_cluster) //¹¹ÔìFAT´ØÁ´
              {
               UINT32 temp1=0,temp2=0;
              
               if(0==cluster || 1==cluster) return ERR_FAIL; //´ØÏî0Óë1ÊÇ²»ÄÜ¸ü¸ÄµÄ
              
               temp1=pInit_Args->FirstFATSector+(cluster*4/pInit_Args->BytesPerSector);
               temp2=((cluster*4)%pInit_Args->BytesPerSector);
              
               znFAT_Device_Read_Sector(temp1,znFAT_Buffer);
               znFAT_Buffer[temp2+0]=(UINT8)( next_cluster&0x000000ff)     ;
               znFAT_Buffer[temp2+1]=(UINT8)((next_cluster&0x0000ff00)>>8 );
               znFAT_Buffer[temp2+2]=(UINT8)((next_cluster&0x00ff0000)>>16);
               znFAT_Buffer[temp2+3]=(UINT8)((next_cluster&0xff000000)>>24);
               znFAT_Device_Write_Sector(temp1,znFAT_Buffer);
               
               znFAT_Device_Read_Sector(temp1+pInit_Args->FATsectors,znFAT_Buffer);
               znFAT_Buffer[temp2+0]=(UINT8)( next_cluster&0x000000ff)     ;
               znFAT_Buffer[temp2+1]=(UINT8)((next_cluster&0x0000ff00)>>8 );
               znFAT_Buffer[temp2+2]=(UINT8)((next_cluster&0x00ff0000)>>16);
               znFAT_Buffer[temp2+3]=(UINT8)((next_cluster&0xff000000)>>24);
               znFAT_Device_Write_Sector(temp1+pInit_Args->FATsectors,znFAT_Buffer);
              
               return ERR_SUCC;
              }
              #endif
1916          
1917          /********************************************************************************************
1918           ¹¦ÄÜ£º¶Ôcluster´Ø½øĞĞÇå0
1919           ĞÎ²Î£ºcluster:Òª½øĞĞÇå0²Ù×÷µÄ´Ø
1920           ·µ»Ø£º0
1921           Ïê½â£ºÔÚÄ³¸öÄ¿Â¼ÏÂ´´½¨ÎÄ¼ş»òÄ¿Â¼Ê±£¬´ËÄ¿Â¼µÄÏÖÓĞ´ØÒÑÎŞ¿ÕÏĞ¿Õ¼äÀ´Ğ´ÈëÎÄ¼şÄ¿Â¼ÏîÊ±£¬ĞèÒªÀ©Õ¹¿Õ
1922                 ´Ø£¬¼´½«¿Õ´ØÁ´µ½Ä¿Â¼µÄ´ØÁ´ÉÏ£¬½ø¶ø¼ÌĞøĞ´ÈëÎÄ¼şÄ¿Â¼Ïî£¬À´Íê³ÉÎÄ¼ş»òÄ¿Â¼µÄ´´½¨¡£ÔÚÏò¿Õ´Ø
1923                 Ğ´ÈëÎÄ¼şÄ¿Â¼ÏîÒÔÇ°±ØĞë°ÑÕâ¸ö¿Õ´ØÇå¿ÕÎª0¡£ÒòÎªÏòÄ¿Â¼µÄ´ØÖĞĞ´ÈëÎÄ¼şÄ¿Â¼Ïî£¬ÊÇÒÔ0À´ÅĞ¶ÏÊÇ
1924                 ·ñÓĞ¿ÕÏĞµÄÎ»ÖÃ¡£
1925          ********************************************************************************************/
1926          #ifdef CLEAR_CLUSTER
              UINT8 Clear_Cluster(UINT32 cluster)
              {
               znFAT_Device_Clear_nSector((pInit_Args->SectorsPerClust),SOC(cluster));
              
               return 0;
              }
              #endif
1934          
1935          /********************************************************************************************
1936           ¹¦ÄÜ£º¸üĞÂÏÂÒ»¿Õ´Ø²Î¿¼Öµ ¼´znFATÖĞÎÄ¼şÏµÍ³³õÊ¼»¯²ÎÊı¼¯ºÏÖĞµÄNext_Free_Cluster
1937           ĞÎ²Î£ºÎŞ
1938           ·µ»Ø£ºÔËĞĞ½á¹û 
1939           Ïê½â£ºÔÚÃ¿´ÎĞèÒªÊ¹ÓÃ¿Õ´ØµÄÊ±ºò£¬ÎÒÃÇ¶¼¿ÉÒÔÖ±½ÓÈ¥È¡pInit_Args->Next_Free_Cluster£¬µ«ÊÇÓÃÍêÖ®
1940                 Òª¼°Ê±¸üĞÂÆäÖµ£¬ÒÔÎªÏÂÒ»´ÎÊ¹ÓÃ¿Õ´Ø×÷ºÃ×¼±¸¡£
1941          ********************************************************************************************/
1942          #ifdef UPDATE_NEXT_FREE_CLUSTER
              UINT8 Update_Next_Free_Cluster(void)
              {
               UINT32 clu_sec,iItem,iSec;
               struct FAT_Sec *pFAT_Sec;
              
               if(0!=pInit_Args->Free_nCluster) //´ÅÅÌÈÔÓĞ¿Õ¼ä
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 33  

               {
                pInit_Args->Free_nCluster--; //¿ÕÏĞ´ØÊı¼õ1
              
                clu_sec=(pInit_Args->Next_Free_Cluster/NITEMSINFATSEC); //Ö¸¶¨´ØµÄ´ØÏîËùÔÚµÄÉÈÇøÎªÆäFATÇøÄÚµÄÆ«ÒÆÁ¿     
             -                                                                            //FATµÄÊ×ÉÈÇø                               
             -                          
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer); //½«´ØÏîËùÔÚµÄÉÈÇøÊı¾İ¶ÁÈë»
             -º³åÇø
                pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞÍ
              
                for(iItem=((pInit_Args->Next_Free_Cluster)%NITEMSINFATSEC)+1;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°F
             -ATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                {
                 if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                 {
                  pInit_Args->Next_Free_Cluster=(clu_sec*NITEMSINFATSEC)+iItem;
                  #ifdef RT_UPDATE_FSINFO
                  Update_FSINFO();
                  #endif
                      return ERR_SUCC;
                 }
                }
              
                for(iSec=(clu_sec+1);iSec<(pInit_Args->FATsectors);iSec++) //ÔÚºóÃæµÄFATÉÈÇøÖĞ¼ÌĞø²éÕÒ
                {
                 znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
                 for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                 {
                  if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
                  && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                  && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                  && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                  {
                   pInit_Args->Next_Free_Cluster=(iSec*NITEMSINFATSEC)+iItem;
                   #ifdef RT_UPDATE_FSINFO
                   Update_FSINFO();
                   #endif
                       return ERR_SUCC;
                  }
                 }
                }
               }
               pInit_Args->Next_Free_Cluster=2; //Èç¹ûÒÑÎŞ¿Õ¼ä£¬¼´nFreeClusterÎª0£¬Ôò½«ÏÂÒ»¿Õ´ØÉèÎª2
                                                //WINDOWS¾ÍÊÇÕâÑù×÷µÄ
               return ERR_NO_SPACE;
              }
              #endif
1996          
1997          //=================for LFN=====ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖ³¤ÎÄ¼şÃû===ÒªÊ¹ÓÃ³¤Ãû¹¦ÄÜ ĞèÒª¶ÔUSE_LFNÕâ¸öºê½øĞĞ¶¨Òå===
1998          
1999          /********************************************************************************************
2000           ¹¦ÄÜ£ºÅĞ¶ÏÒ»¸öÎÄ¼şÃûÊÇ·ñÊÇ³¤ÎÄ¼şÃû
2001           ĞÎ²Î£ºfilename:Ö¸ÏòÎÄ¼şÃûµÄÖ¸Õë
2002           ·µ»Ø£ºÔËĞĞ½á¹û£¬ÊÇ»ò·ñ
2003           Ïê½â£ºÅĞ¶ÏÒ»¸öÎÄ¼şÃûÊÇ·ñ³¤ÎÄ¼şÃû£¬·Ç³£ÖØÒª¡£FAT32ÖĞ¶Ô³¤ÃûµÄ¶¨Òå±È½ÏÁãËé¶ø¸´ÔÓ£¬Ò»Ğ©¿´ËÆ¶ÌÃû
2004                 µÄÎÄ¼şÃûÊµÎª³¤Ãû¡£ÕâÀïÖ»Ê¹ÓÃ³¤ÃûÅĞ¶ÏµÄÖ÷ÒªÌõ¼ş£¬½¨ÒéÔÚÊ¹ÓÃ³¤ÃûÊ±£¬Ê¹ÓÃÕßÒÔÃ÷È·µÄĞÎÊ½
2005                 ¸ø³ö³¤Ãû¡£
2006          ********************************************************************************************/
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 34  

2007          #ifdef IS_LFN
              UINT8 Is_LFN(INT8 *filename)
              {
               UINT8 is_lfn=BOOL_FALSE;
              
               if(Check_SFN_Illegal_Length(filename)) is_lfn=BOOL_TRUE;
               if(Check_SFN_Dot(filename))            is_lfn=BOOL_TRUE;
               if(Check_SFN_Special_Char(filename))   is_lfn=BOOL_TRUE;
               if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) is_lfn=BOOL_TRUE;
              
               return is_lfn;
              }
              #endif
2020          
2021          /***********************************************************************************************
2022           ¹¦ÄÜ£º´Ó³¤ÃûÏîÖĞÌáÈ¡ÆäÖĞËùº¬µÄ²¿·Ö³¤ÃûµÄUNIÂë£¬´Ëº¯ÊıÍ¨¹ı¶à´Îµ÷ÓÃ£¬ÊµÏÖÁË¶ÔÕû¸ö³¤ÃûUNIÂëµÄÆ´½Ó
2023           ĞÎ²Î£ºlfn_buf:Ö¸ÏòÓÃÓÚ×°ÔØ³¤ÃûUNIÂëµÄ»º³åÇø plfndi:Ö¸Ïò³¤ÃûÏîµÄÖ¸Õë n:ËµÃ÷ÕâÊÇ³¤ÃûµÄµÚn²¿·Ö
2024           ·µ»Ø£ºÔËĞĞ½á¹û
2025           Ïê½â£ºFAT32ÖĞµÄ³¤ÃûÊÇÓÉ¶à¸ö³¤ÃûÏî¹²Í¬±í´ïµÄ£¬Ã¿¸ö³¤ÃûÏî¼ÇÂ¼×Å³¤ÃûµÄÄ³Ò»¶Î£¬´Ëº¯Êı¾ÍÊÇ½«³¤ÃûÏîÖĞ
2026                 µÄ³¤ÃûUNIÂëÌáÈ¡³öÀ´£¬·Åµ½»º³åÇøµÄÏàÓ¦Î»ÖÃÉÏ¡£¾­¹ı¶à´Îµ÷ÓÃ´Ëº¯Êı£¬×îÖÕ¿ÉÒÔÆ´½ÓµÃµ½³¤Ãû¡£
2027          ************************************************************************************************/
2028          #ifdef GET_PART_NAME
              UINT8 Get_Part_Name(UINT16 *lfn_buf,struct LFN_FDI *plfndi,UINT8 n)
              {
               UINT8 i=0;
               UINT16 temp=0;
              
               if((plfndi->AttrByte[0])&0X40) Memory_Set(((UINT8 *)lfn_buf),2*(MAX_LFN_LEN+1),0); //Èç¹ûÊÇ×îºóÒ»¸ö³¤ÃûÏî
             -£¬ÔòÇå¿Õlfn_buf
              
               for(i=0;i<5;i++) //µÚÒ»²¿·Ö³¤Ãû
               {
                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;
                temp=(((UINT16)(((plfndi->Name1)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name1)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
               for(i=0;i<6;i++) //µÚ¶ş²¿·Ö³¤Ãû
               {
                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;  
                temp=(((UINT16)(((plfndi->Name2)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name2)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
               for(i=0;i<2;i++) //µÚÈı²¿·Ö³¤Ãû
               {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 35  

                if(n>=MAX_LFN_LEN) return ERR_LFN_BUF_OUT;  
                temp=(((UINT16)(((plfndi->Name3)+i*2)[0]))&0X00FF)|((((UINT16)(((plfndi->Name3)+i*2)[1]))&0X00FF)<<8);
                if(0==temp)
                {
                 lfn_buf[n]=0;
                 return 0;
                }
                else
                {
                 lfn_buf[n]=temp;n++;
                }
               }
              
               n--;
               if((plfndi->AttrByte[0])&0X40)
               {
                while(((UINT16)(0XFFFF))==lfn_buf[n]) n--;
                lfn_buf[n+1]=0;
               }
              
               return 0;
              }
              #endif
2091          
2092          /***********************************************************************************************
2093           ¹¦ÄÜ£º½«OEMÂë£¨¶ÔÓÚºº×ÖÀ´Ëµ£¬OEMÂë¾ÍÊÇGB2312£©×ªÎªUNICODEÂë
2094           ĞÎ²Î£ºoem_code:OEMÂë uni_code:Ö¸ÏòÓÃÓÚ¼ÇÂ¼oem_codeËù¶ÔÓ¦µÄUNICODE±àÂëµÄ±äÁ¿µÄÖ¸Õë
2095           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦»òÊ§°Ü
2096           Ïê½â£ºOEMÂëÊÇ¸÷µØÇøµÄ¼ÆËã»úÉú²úÉÌÔÚ¼ÆËã»ú¹Ì»¯µÄ±¾µØÎÄ×Ö±àÂë£¬±ÈÈçÔÚÖĞ¹úOEMÂë¾ÍÊÇGB2312Âë£¬¼´Çø
2097                 Î»Âë£¬µ«ÊÇFAT32µÄ³¤ÎÄ¼şÃûÊÇÒÔUNICODEÀ´±àÂëµÄ£¬Òò´ËĞèÒªÒ»¸ö±àÂë×ª»»µÄ¹ı³Ì¡£±¾º¯ÊıµÄÊµÏÖ»ùÓÚ
2098                 ¶ş·ÖËÑË÷£¬¿É¿ìËÙ²éÕÒµ½OEMÂë¶ÔÓ¦µÄUNICODE±àÂë¡£
2099          ************************************************************************************************/
2100          #ifdef OEMTOUNI
              UINT8 OEM2UNI(UINT16 oem_code,UINT16 *uni_code) //Í¨¹ı¶ş·Ö·¨²é±í½«OEMÂë×ªÎªUNIÂë
              {  
               UINT32 low=0,high=MAX_UNI_INDEX-1,mid;//ÖÃµ±Ç°²éÕÒÇø¼äÉÏÏÂ½çµÄ³õÖµ 
               
               if(oem_code<GET_PGM_WORD(&(oem_uni[0][1]))) return ERR_FAIL;
               if(oem_code>GET_PGM_WORD(&(oem_uni[MAX_UNI_INDEX-1][1]))) return ERR_FAIL; //Èç¹ûÊäÈëµÄoem_code²»ÊÇ±íµÄ·¶
             -Î§ÄÚ£¬ÔòÖ±½Ó·µ»Ø
              
               while(low<=high) //µ±Ç°²éÕÒÇø¼ä[low..high]·Ç¿Õ
               {
                mid=low+(high-low)/2;
              
                if(oem_code==GET_PGM_WORD(&(oem_uni[mid][1])))
                {
                 *uni_code=GET_PGM_WORD(&(oem_uni[mid][0]));
              
                 return ERR_SUCC; //²éÕÒ³É¹¦·µ»Ø
                }
              
                if(GET_PGM_WORD(&(oem_uni[mid][1]))>oem_code)
                {
                 high=mid-1;  //¼ÌĞøÔÚ[low..mid-1]ÖĞ²éÕÒ
                }
                else
                {
                 low=mid+1; //¼ÌĞøÔÚ[mid+1..high]ÖĞ²éÕÒ
                }
               }                                                                                      
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 36  

               return ERR_FAIL; //µ±low>highÊ±±íÊ¾²éÕÒÇø¼äÎª¿Õ£¬²éÕÒÊ§°Ü
              }
              #endif
2132          
2133          /***********************************************************************************************
2134           ¹¦ÄÜ£º½«OEM±àÂëµÄ×Ö·û´®×ªÎªÓÉUNICODE±àÂëµÄ×Ö·û´®
2135           ĞÎ²Î£ºoemstr:Ö¸Ïòoem±àÂëµÄ×Ö·û´®  unistr:Ö¸ÏòUNICODE±àÂëµÄ×Ö·û´®
2136           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦ ×Ö·û¼¯²»ÍêÕû »ò ³¤Ãû»º³åÒç³ö
2137           Ïê½â£ºÒıÈë³¤ÎÄ¼şÃûÖ®ºó£¬Éæ¼°µ½³¤ÎÄ¼şÃûµÄ±È¶ÔºÍÆ¥Åä£¬Òò´Ë±ØÈ»Òª½«oem±àÂëµÄ×Ö·û´®×ªÎªUNICODE±àÂë
2138                 µÄ×Ö·û´®£¬ÒÔ±ãÓëÓÉ³¤ÃûÏîÖĞÌáÈ¡Æ´½Ó¶ø³ÉµÄUNICODE×Ö·û´®½øĞĞ±È¶Ô¡£
2139          ************************************************************************************************/
2140          #ifdef OEMSTRTOUNISTR
              UINT8 oemstr2unistr(INT8 *oemstr,UINT16 *unistr)
              {
               UINT32 len=StringLen(oemstr);
               UINT32 i=0,pos=0;
               UINT8 res=0;
               UINT16 temp=0;
              
               for(i=0;i<len;i++)
               {
                if(IS_ASC(oemstr[i])) //¼ì²éÊÇ·ñÊÇASCIIÂë£¬ASCIIÂëµÄÊıÖµ·¶Î§Îª0X00~0X7F£¬OEM±àÂëÖµ²»ÔÚ´Ë·¶Î§£¬ÒÔ´ËÇø·ÖÊÇ
             -ASCII»¹ÊÇOEM
                {
                 unistr[pos]=(UINT16)(((UINT16)oemstr[i])&0X00FF);
                 pos++;
                }
                #ifdef USE_OEM_CHAR
                else //²»ÊÇASCIIÂë£¬¶øÊÇOEM±àÂë
                {
                 temp=((((UINT16)oemstr[i])<<8)&0xff00);
                 temp|=(((UINT16)oemstr[i+1])&0x00ff);
                 res=OEM2UNI(temp,unistr+pos);
                 if(res) 
                 {
                        unistr[0]=0;
                        return ERR_OEM_CHAR_NOT_COMPLETE;
                 }
                 pos++;i++;
                }
                #endif
              
                if(pos>MAX_LFN_LEN) 
                {
                 unistr[0]=0;
                 return ERR_LFN_BUF_OUT; 
                }
               }
              
               unistr[pos]=0;
              
               return ERR_SUCC;
              }
              #endif
2182          
2183          /***********************************************************************************************
2184           ¹¦ÄÜ£º¶Ô¿í×Ö·û´®£¨¼´Ã¿¸ö×Ö·û¾ùÕ¼ÓÃÁ½¸ö×Ö½Ú£¬ÈçUNICODE£©½øĞĞ×Ó´®²éÕÒ
2185           ĞÎ²Î£ºstr:Ö¸Ïò¿í×Ö·û´®µÄÖ¸Õë  substr:Ö¸Ïò×Ó´®µÄÖ¸Õë  pos:Òª²éÕÒµÄÆğÊ¼Î»ÖÃ
2186           ·µ»Ø£º×Ó´®ÔÚ¿í×Ö·û´®ÖĞµÄÆğÊ¼Î»ÖÃ£¬Èç¹ûÎ´ÕÒµ½£¬Ôò·µ»Ø-1
2187           Ïê½â£º´Ëº¯Êı»ù±¾ÓëÇ°ÃæSFNµÄÆ¥ÅäÖĞµÄ²éÕÒ×Ó´®µÄº¯ÊıÍ¬Àí£¬Ö»²»¹ı×Ö·û´®±»À©Õ¹ÎªÁË¿í×Ö·û´®
2188          ************************************************************************************************/
2189          #ifdef WFINDSUBSTR
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 37  

              UINT32 WFindSubStr(UINT16 *str,UINT16 *substr,UINT32 pos)
              {
               UINT32 i=pos,j=0,lens=WStringLen(str),lent=WStringLen(substr);
              
               while(i<lens && j<lent)
               {
                if(WLower2Up(str[i])==substr[j] || (UINT16)'?'==substr[j])
                {
                 i++;
                 j++;
                }
                else
                {
                 i=i-j+1;
                 j=0;
                }
               }
              
               if(j==lent) return i-lent; 
               else return (UINT32)-1;
              }
              #endif
2212          
2213          /***********************************************************************************************
2214           ¹¦ÄÜ£º¶ÔÁ½¸ö¿í×Ö·û´®½øĞĞÆ¥Åä£¬ÊµÎª³¤ÎÄ¼şÃûµÄÍ¨Åä±È¶Ô
2215           ĞÎ²Î£ºt:Ö¸ÏòÄ£°æ¿í×Ö·û´®µÄÖ¸Õë  s:Ö¸Ä¿±ê×Ö·û´®µÄÖ¸Õë  Àıt:ÕñÄÏ*ÎŞÏŞ.txt s:ÕñÄÏµç×ÓÔ­´´ÎŞÏŞ.txt
2216                 ËüÃÇÊÇÆ¥ÅäµÄ¡£
2217           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü
2218           Ïê½â£º´Ëº¯Êı»ù±¾ÓëÇ°ÃæSFNµÄÆ¥Åäº¯ÊıSFN_MatchÍ¬Àí¡£
2219          ************************************************************************************************/
2220          #ifdef LFN_MATCH
              UINT8 LFN_Match(UINT16 *t,UINT16 *s)
              {
               UINT32 i=0,j=0,lens=WStringLen(s),lent=WStringLen(t);
               UINT16 bufp=0;
              
               UINT16 buf[MAX_LFN_LEN+1];
              
               //======================================================
               
               while(j<lent && (UINT16)'*'!=t[j])
               {
                buf[bufp]=WLower2Up(t[j]);
                bufp++;
                j++;
               }
              
               if(0==t[j] && (lent!=lens)) return ERR_FAIL;
              
               buf[bufp]=0;
               
               if(WFindSubStr(s,buf,0)!=0) return ERR_FAIL;
               i=bufp;
               
               while(1)
               {
                while(j<lent && (UINT16)'*'==t[j]) j++;
                if(j==lent) return ERR_SUCC;
                bufp=0;
              
                while(j<lent && (UINT16)'*'!=t[j])
                {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 38  

                 buf[bufp]=(UINT16)WLower2Up(t[j]);
                 bufp++;
                 j++;
                }
                buf[bufp]=0;
                
                if(j==lent)
                {
                 if(WFindSubStr(s,buf,i)!=(lens-bufp)) return ERR_FAIL;
                 return 0;
                }
              
                i=WFindSubStr(s,buf,i);
                if(((UINT32)(-1))==i) return ERR_FAIL;
                i+=bufp;
               }
              }
              #endif
2270          
2271          /***********************************************************************************************
2272           ¹¦ÄÜ£º´Ó¶ÌÃûÎÄ¼şÄ¿Â¼ÏîÖĞ»ñÈ¡°ó¶¨Ğ£ÑéºÍ
2273           ĞÎ²Î£ºpdi:Ö¸Ïò¶ÌÃûÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë 
2274           ·µ»Ø£º°ó¶¨Ğ£ÑéºÍµÄÖµ
2275           Ïê½â£º´Ëº¯ÊıËùÊ¹ÓÃµÄĞ£ÑéËã·¨À´×ÔÓÚÎ¢ÈíµÄFAT32Ïà¹ØÎÄµµ¡£Ò»¸öÎÄ¼şµÄÎÄ¼şÃûÈç¹ûÎª³¤ÎÄ¼şÃû£¬ÔòËü½«ÓĞ
2276                 Èô¸É¸ö³¤ÃûÏîÀ´¹²Í¬±í´ï³¤Ãû£¬Í¬Ê±»¹ÓĞÓëÖ®¶ÔÓ¦µÄ¶ÌÃûÏî¡£±ÈÈç ABCDEFGHI.RMVB ÓĞ2¸ö³¤ÃûÏî£¨Ã¿
2277                 ¸ö³¤ÃûÏî¿É¼ÇÂ¼13¸öUNICODEÂë£©£¬ÓëÖ®¶ÔÓ¦µÄ¶ÌÃû¿ÉÄÜÎªABCDEF~1.RMV¡£Í¨³£Çé¿öÏÂ£¬¶ÌÃû½ô½ô¸úÔÚ
2278                 ³¤ÃûÏîºóÃæ£¬µ«ËüÃÇÖ®¼ä²¢²»¹â¿¿Î»ÖÃ¹ØÏµÀ´±£Ö¤ÆäÁªÏµ£¬»¹ÓĞÒ»ÖÖ°ó¶¨Ğ£ÑéºÍËã·¨£ºÍ¨¹ı¶ÌÃû¿ÉÒÔ
2279                 ¼ÆËãµÃµ½Ò»¸öÖµ£¬³¤ÃûÏîÖĞÓĞ×¨ÃÅµÄ×Ö¶ÎÒ²¼ÇÂ¼ÁËÕâ¸öÖµ£¬Èç¹ûÕâÁ½¸öÖµÏàµÈ£¬ÔòÈÏÎª³¤ÃûÏîÓë¶ÌÃû
2280                 ÏîÊÇÓĞ¹ØÁªµÄ£¬Åä¶Ô³É¹¦¡£
2281          ************************************************************************************************/
2282          #ifdef GET_BINDING_SUMCHK
              UINT8 Get_Binding_SumChk(struct FDI *pdi)
              {
               UINT8 i=0,c=0;
              
               for(i=0;i<11;i++)
               {
                c=(UINT8)(((c&0X01)?0X80:0)+(c>>1)+((pdi->Name)[i]));
               }
              
               return c;
              }
              #endif
2295          
2296          /***********************************************************************************************
2297           ¹¦ÄÜ£ºELF¹şÏ£Ëã·¨£¬ÓÃÓÚÓÉÒ»¸ö×Ö·û´®¼ÆËãµÃµ½Ò»¸öÖµ£¬Õâ¸öÖµÓë×Ö·û´®ÊÇÎ¨Ò»¶ÔÓ¦µÄ
2298           ĞÎ²Î£ºstr:Ö¸Ïò×Ö·û´®µÄÖ¸Õë
2299           ·µ»Ø£º¼ÆËãµÃµ½µÄ¹şÏ£Öµ
2300           Ïê½â£ºÔÚ´´½¨ÎÄ¼şºÍÄ¿Â¼Ê±£¬Èç¹ûÊÇ³¤Ãû£¬ÔÚÏòÄ¿Â¼´ØÖĞĞ´Èë³¤ÃûÏîµÄÍ¬Ê±£¬Ò²ÒªĞ´ÈëÆä¶ÔÓ¦µÄ¶ÌÃûÏî£¬¶ø
2301                 ¶ÌÃûÈçºÎÈ·¶¨£¨FAT32ÖĞÊ¹ÓÃ¼ÓÊı×Öºó×ºµÄ·½·¨£¬ÈçXXXXXX~n.YYY£¬µ«n<=5£¬n>5µÄÊ±ºò¾ÍĞèÒªÒ»ÖÖËã
2302                 ·¨ÓÉ³¤ÃûÖ±½Ó¼ÆËãµÃµ½Ò»¸öÎ¨Ò»ÓëÖ®¶ÔÓ¦µÄ¶ÌÎÄ¼şÃû£¬´ËËã·¨¼´¿ÉÓÉHASHËã·¨À´ÊµÏÖ£©¡£ELF¹şÏ£ÊÇ
2303                 ÖÚ¶à¹şÏ£Ëã·¨ÖĞÓÃµÃ±È½Ï¹ã·ºµÄ£¬Ëü¸ßĞ§¶øÇÒ±£Ö¤ÁË¹şÏ£ÖµÓë×Ö·û´®µÄÎ¨Ò»¶ÔÓ¦£¨²»Í¬µÄ×Ö·û´®ÓµÓĞ
2304                 ÏàÍ¬µÄ¹şÏ£ÖµµÄ¸ÅÂÊÊÇ¼«Ğ¡µÄ£©¡£»ùÓÚÕâ¸öÎ¨Ò»µÄ¹şÏ£ÖµÎÒÃÇ¿ÉÒÔ¿ìËÙ¹¹Ôì³ö³¤Ãû¶ÔÓ¦µÄ¶ÌÃû¡£
2305          ************************************************************************************************/
2306          #ifdef  ELFHASH
              UINT32 ELFHash(INT8 *str)
              {
               UINT32 hash=0;
               UINT32 x=0;
              
               while(*str)
               {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 39  

                hash=(hash<<4)+(*str++); //hash×óÒÆ4Î»£¬µ±Ç°×Ö·ûASCII´æÈëhashµÍËÄÎ»¡£ 
                x=hash&0xF0000000;
                if(0!=x)
                { //Èç¹û×î¸ßµÄËÄÎ»²»Îª0£¬ÔòËµÃ÷×Ö·û¶àÓà7¸ö£¬Èç¹û²»´¦Àí£¬ÔÙ¼ÓµÚ¾Å¸ö×Ö·ûÊ±£¬µÚÒ»¸ö×Ö·û»á±»ÒÆ³ö£¬Òò´ËÒªÓĞÈç
             -ÏÂ´¦Àí¡£
                  //¸Ã´¦Àí£¬Èç¹û¶ÔÓÚ×Ö·û´®(a-z »òÕßA-Z)¾Í»á½ö½öÓ°Ïì5-8Î»£¬·ñÔò»áÓ°Ïì5-31Î»£¬ÒòÎªCÓïÑÔÊ¹ÓÃµÄËãÊıÒÆÎ»
                 hash ^= (x >> 24);
                 //Çå¿Õ28-31Î»¡£
                 hash &= ~x;
                }
               }
              
               //·µ»ØÒ»¸ö·ûºÅÎ»Îª0µÄÊı£¬¼´¶ªÆú×î¸ßÎ»£¬ÒÔÃâº¯ÊıÍâ²úÉúÓ°Ïì¡£(ÎÒÃÇ¿ÉÒÔ¿¼ÂÇ£¬Èç¹ûÖ»ÓĞ×Ö·û£¬·ûºÅÎ»²»¿ÉÄÜÎª¸º)
               return (hash&0X7FFFFFFF);
              }
              #endif
2329          
2330          /***********************************************************************************************
2331           ¹¦ÄÜ£º½«Ò»¸ö32Î»µÄÕûĞÎÖµ×ªÎª16½øÖÆ×Ö·û´® Àı£º0X12345678×ªÎª"12345678"
2332           ĞÎ²Î£ºhex:Ò»¸ö32Î»µÄÕûĞÎÊı str:Ö¸Ïò×Ö·û´®µÄÖ¸Õë
2333           ·µ»Ø£º0
2334           Ïê½â£º´Ëº¯ÊıÓÃÓÚ½«ÉÏÃæµÄ¹şÏ£º¯Êı¼ÆËãµÃµ½µÄ32Î»µÄ¹şÏ£Öµ×ªÎª×Ö·û´®£¬ÒÔ±ã½øĞĞ¶ÌÎÄ¼şÃûµÄ¹¹Ôì¡£
2335          ************************************************************************************************/
2336          #ifdef HEX2STR_32B
              UINT8 Hex2Str_32b(UINT32 hex,INT8 *str)
              {
               UINT8 i=0,temp=0;
               for(i=0;i<8;i++)
               {
                temp=((unsigned char)((hex&(0X0000000F<<(i*4)))>>(i*4)));
                str[7-i]=(INT8)((temp>=10)?('A'+temp-10):(temp+0X30));        
               }
               str[i]=0;
               
               return 0;
              }
              #endif
2350          
2351          /***********************************************
2352           ¹¦ÄÜ£ºÓÉ³¤Ãû¹¹ÔìÆä¶ÔÓ¦µÄ¶ÌÃû
2353           ĞÎ²Î£ºpfn:Ö¸ÕëÏò³¤ÃûµÄÖ¸Õë psfn:Ö¸Ïò¶ÌÃûµÄÖ¸Õë
2354           ·µ»Ø£º0
2355           Ïê½â£º´Ëº¯Êı»¹ĞèÒª½øÒ»²½ĞŞ¸Ä£¬µ«Ôİ¿ÉÓÃ¡£
2356          ************************************************/
2357          #ifdef MAKE_SHORT_NAME
              UINT8 Make_Short_Name(char *pfn,char *psfn) //´Ëº¯ÊıÓÃÓÚÉú³É³¤Ãû¶ÔÓ¦µÄ¶ÌÃû£¬Ê¹ÓÃÁËELFHASHËã·¨ÓÃÓÚÉú³ÉÎ¨Ò»µ
             -Ä¶ÌÃû
              {
               //psfn[0]=Lower2Up(pfn[0]);
               //psfn[1]='~';
               UINT32 temp=ELFHash(pfn);
               Hex2Str_32b(temp,psfn);
               //psfn[0]='*';
               psfn[8]='.';
               psfn[9]=psfn[10]=psfn[11]='A';
               psfn[12]=0;
              
               return 0;
              }
              #endif
2372          
2373          /******************************************************************************
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 40  

2374           ¹¦ÄÜ£º¹¹ÔìµÚn¸ö³¤ÃûÏî
2375           ĞÎ²Î£ºunifn:Ö¸ÏòUNICODE±àÂëµÄ³¤ÎÄ¼şÃû plfni:Ö¸ÏòÓÃÓÚ´æ´¢¹¹ÔìµÄ³¤ÃûÏîµÄ±äÁ¿Ö¸Õë 
2376                 ChkSum:ÓÉ¶ÌÃûÏî¼ÆËãµÃµ½µÄ°ó¶¨Ğ£ÑéºÍ n:Ö¸Ê¾ÊÇµÚ¼¸¸ö³¤ÃûÏî
2377           ·µ»Ø£º0
2378           Ïê½â£º¹¹Ôì³¤ÃûÏîÊÇznFATÖĞÊµÏÖ³¤ÎÄ¼şÃûµÄÒ»¸ö¹Ø¼ü¹¦ÄÜº¯Êı
2379          *******************************************************************************/
2380          #ifdef FILL_LFN_FDI
              UINT8 Fill_LFN_FDI(UINT16 *unifn,struct LFN_FDI *plfni,UINT8 ChkSum,UINT8 n)
              {
               UINT8 temp=(UINT8)(n*13),i=0,j=0;
               UINT16 len=(UINT16)WStringLen(unifn+temp);
              
               (plfni->AttrByte[0])=(UINT8)(n+1); //³¤ÃûÏîµÄĞòºÅ×Ö½Ú
               if(len<=13) (plfni->AttrByte[0])|=0X40; //Èç¹û·¢ÏÖ´Óµ±Ç°Î»ÖÃ¿ªÊ¼µÄUNI´®³¤¶ÈĞ¡ÓÚµÈÓÚ13£¬ÔòËµÃ÷ÊéÕâÊÇ×îºóÒ»
             -¸ö³¤ÃûÏî
              
               (plfni->ChkVal[0])=ChkSum; //Ğ´ÈëÓëSFNµÄ°ó¶¨Ğ£ÑéÖµ
               (plfni->LFNSign[0])=0X0F; //³¤ÃûÏîµÄ±êÖ¾
              
               (plfni->Resv[0])=(plfni->StartClu[0])=(plfni->StartClu[1])=0;
              
               for(i=0;i<10;i++) (plfni->Name1)[i]=0XFF; 
               for(i=0;i<12;i++) (plfni->Name2)[i]=0XFF;
               for(i=0;i<4;i++)  (plfni->Name3)[i]=0XFF; //ÏÈ°Ñ³¤ÃûUNIµÄ×Ö¶ÎÓÃ0XFFÌî³ä
               
               for(i=0;i<5;i++)
               {
                (plfni->Name1)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name1)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len) 
                {
                 if(4==i) 
                 {
                  (plfni->Name2)[0]=(plfni->Name2)[1]=0;
                 }
                 else
                 {
                      i++;
                  (plfni->Name1)[2*i]=(plfni->Name1)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
                }
               }
              
               for(i=0;i<6;i++)
               {
                (plfni->Name2)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name2)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len)
                {
                 if(5==i) 
                 {
                  (plfni->Name3)[0]=(plfni->Name3)[1]=0;
                 }
                 else
                 {
                      i++;
                  (plfni->Name2)[2*i]=(plfni->Name2)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 41  

                }
               }
              
               for(i=0;i<2;i++)
               {
                (plfni->Name3)[2*i]=(UINT8)(unifn[j+temp]&0X00FF);
                (plfni->Name3)[2*i+1]=(UINT8)((unifn[j+temp]&0XFF00)>>8);
                j++;
                if(j>=len)
                {
                 if(1!=i) 
                 {
                      i++;
                  (plfni->Name3)[2*i]=(plfni->Name3)[2*i+1]=0;
                 }
                 return ERR_SUCC; 
                }
               }
               
               return ERR_SUCC;
              }
              #endif
2457          
2458          /********************************************************************************
2459           ¹¦ÄÜ£ºÏòÄ¿Â¼´ØÖĞ×¢²á³¤ÃûÏî¼°Æä¶ÔÓ¦µÄ¶ÌÃûÏî£¬²¢·µ»Ø¶ÌÃûÏîËùÔÚµÄÉÈÇøÓëÉÈÇøÄÚµÄÎ»ÖÃ
2460           ĞÎ²Î£ºcluster:Òª´´½¨µÄÎÄ¼ş»òÄ¿Â¼ËùÔÚµÄÄ¿Â¼µÄÊ×´Ø pfdi:Ö¸Ïò¶ÌÃûÏîµÄÖ¸Õë 
2461                 unifn:Ö¸ÏòUNICODE±àÂëµÄ³¤ÃûµÄÖ¸Õë psec:Ö¸ÏòÓÃÓÚ´æ´¢¶ÌÃûÏîËùÔÚÉÈÇøµÄ±äÁ¿Ö¸Õë
2462                 pn:Ö¸ÏòÓÃÓÚ¼ÇÂ¼¶ÌÃûÏîÔÚÆäËùÔÚÉÈÇøÖĞµÄÎ»ÖÃµÄ±äÁ¿µÄÖ¸Õë
2463           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»ò´íÎóºÅ
2464           Ïê½â£ºÒòÎª³¤ÃûÊÇÓÉ¶à¸ö³¤ÃûÏîºÍÒ»¸ö¶ÌÃûÏîËù¹²Í¬À´½øĞĞ±í´ïµÄ£¬Òò´Ë´´½¨³¤ÃûµÄÎÄ¼ş»ò
2465                 Ä¿Â¼£¬ÆäºËĞÄ²Ù×÷¾ÍÊÇ¿ÉÒÔÒ»´ÎĞÔÏòÄ¿Â¼´ØÖĞ×¢²á¶à¸öÎÄ¼şÄ¿Â¼Ïî¡£´Ëº¯Êı»ù±¾ÉÏÊÇ
2466                 ¶ÔRefigster_FDI£¨ËüÓÃÓÚÊµÏÖÎª¶ÌÃû×¢²áÎÄ¼şÄ¿Â¼Ïî£©µÄÀ©Õ¹¡£
2467          *********************************************************************************/
2468          #ifdef REGISTER_LFN_FDI
              UINT8 Register_LFN_FDI(UINT32 cluster,struct FDI *pfdi,UINT16 *unifn,UINT32 *psec,UINT8 *pn)
              {
               UINT32 temp_sec=0,old_cluster=0;
               UINT8 iClu=0,iSec=0,iFDI=0,res=0;
               struct FDIesInSEC *pitems;
               struct FDI *pitem;
              
               struct LFN_FDI *plfni;
              
               UINT8 have_lfn=0; //ÔÚÎÄ¼şÄ¿Â¼ÏîÉ¨Ãè¹ı³ÌÖÖ£¬ÓÃÓÚ±ê¼ÇÊÇ·ñÓĞ³¤Ãû
               UINT8 is_lfn_buf_err=0,cur_binding_sumchk=0,flag=0,chksum=Get_Binding_SumChk(pfdi);
               UINT16 lfn_buf[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNIÂëµÄ»º³å
               struct LFN_FDI temp_lfni; //ÓÃÓÚ¹¹Ôì³¤ÃûÏîµÄÁÙÊ±½á¹¹Ìå±äÁ¿
              
               UINT16 len=(UINT16)WStringLen(unifn),xlen=0; //¼ÆËãUNI´®³¤¶È
               UINT8 nclu=0,nsec=0,nlfni=(UINT8)(len/13);
               if(len%13) nlfni++; //¼ÆËãUNI´®»á·ÖÎª¶àÉÙ¸ö³¤ÃûÏî
              
               //===========================================================================================
              
               if(0==pInit_Args->Free_nCluster) return ERR_NO_SPACE; //Èç¹ûÃ»ÓĞ¿Õ¼ä£¬ÔòÖ±½Ó·µ»Ø
               
               //ÒÔÏÂ´úÂë¼ì²éÊÇ·ñÒÑ¾­´æÔÚÖØ¸´µÄÎÄ¼ş»òÄ¿Â¼£¬ÒÔ¼°²éÑ¯¿ÕÎ»²¢ÌîÈëÄ¿Â¼Ïî
               do
               {
                temp_sec=SOC(cluster);
                for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
                {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 42  

                 znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                 pitems=((struct FDIesInSEC *)znFAT_Buffer);
              
                 for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
                 {
                      pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
              
                      if((0X08!=pitem->Attributes) && (0X0F!=pitem->Attributes)  //²»ÊÇ¾í±ê¡¢²»ÊÇ³¤ÃûÏî¡¢Ã»ÓĞÉ¾³ı¡¢²»ÊÇ.Óë..
                     && (0XE5!=pitem->Name[0]) && ('.'!=pitem->Name[0])) //¼´Óöµ½Ò»¸öºÏ·¨µÄSFNÏî
                      {
                       if(have_lfn && !is_lfn_buf_err) //Óöµ½SFNÏîºó£¬ËüÇ°Ãæ¿ÉÄÜÓĞ³¤ÃûÏî£¬Èç¹ûÓĞÔòÓëÊäÈëµÄUNI´®±È¶Ô£¬ÒÔÈ·¶¨ÊÇ·ñ
             -ÓĞÍ¬ÃûÎÄ¼ş»òÄ¿Â¼
                       {                               //¶øÇÒÃ»ÓĞ·¢Éúlfn_bufµÄÒç³ö´íÎó
                    if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª³¤ÃûÓĞĞ§
                        { 
                         xlen=(UINT16)WStringLen(lfn_buf); //¼ÆËã´Ó¸÷³¤ÃûÏîºÏ³ÉºóµÄUNI´®µÄ³¤¶È
                         if(xlen==len && Memory_Compare(((UINT8 *)unifn),((UINT8 *)lfn_buf),2*((UINT32)len))) //¶ÔUNI´®½øĞĞ±È¶Ô
             -£¬³¤¶ÈºÍÄÚÈİÒªÏàµÈ
                         {
                          *psec=temp_sec+(UINT32)iSec;
                          *pn=iFDI; //¼ÇÂ¼ÖØÃûÎÄ¼şÄ¿Â¼ÏîµÄÎ»ÖÃ£¬ÒÔ±ã¶ÔÆä½øĞĞ½âÎö
                          return ERR_FDI_ALREADY_EXISTING; //ÒÑÓĞÍ¬ÃûÎÄ¼ş»òÄ¿Â¼
                         }
                        }
                       }
                       if(is_lfn_buf_err) is_lfn_buf_err=0; //»Ö¸´³¤ÃûÏîUNIÌáÈ¡µÄ´íÎó±ê¼Ç
                      }
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0])) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı
                      {
                       have_lfn=1;
                       
                       plfni=(struct LFN_FDI *)pitem;
              
                   cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
              
                   res=Get_Part_Name(lfn_buf,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖĞµÄÎÄ¼şÃû
             -UNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                        //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
                       if(res) is_lfn_buf_err=1; //·¢ÉúLFN_BUFÒç³ö´íÎó
                      }
                      else
                      {
                       have_lfn=0;
                      }
              
                      if(0==(pitem->Name)[0])
                      {
                   flag=1; //±ê¼Ç´ËÉÈÇøÒÑ¾­±»ĞŞ¸Ä
              
                       if(nlfni>0)
                       {
                        Fill_LFN_FDI(unifn,&temp_lfni,chksum,(UINT8)(nlfni-1));
                    Memory_Copy(((UINT8 *)pitem),((UINT8 *)(&temp_lfni)),FDI_NBYTES); //½«ºÏ³ÉµÄ³¤ÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                        nlfni--;
                       }
                       else
                       {
                        *psec=temp_sec+(UINT32)iSec;
                        *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 43  

                        Memory_Copy(((UINT8 *)pitem),((UINT8 *)pfdi),FDI_NBYTES); //½«¶ÌÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                        znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                        return ERR_SUCC;
                       }       
                      }
                 }
              
                 if(flag) 
                 {
                      znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                      flag=0;
                 }
                }
                old_cluster=cluster;
                cluster=Get_Next_Cluster(cluster);
               }while(!IS_END_CLU(cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
               //===========================================================
               //Èç¹ûÔËĞĞµ½ÕâÀï£¬ÔòËµÃ÷µ±Ç°´ØÖĞÒÑÎŞ¿ÕÎ»
               if(0!=pInit_Args->Free_nCluster) //Èç¹ûÊ£Óà¿Õ´ØÊıÎª0£¬ÔòËµÃ÷´ÅÅÌÒÑÎŞ¿Õ¼ä
               {
                nsec=(UINT8)((nlfni+1)/NFDI_PER_SEC); //Ê£ÓàµÄ³¤ÃûÏî»¹ĞèÒª¶àÉÙ¸öÉÈÇø,+1ÊÇÒòÎª×îºó»¹ÓĞÒ»¸ö¶ÌÃûÏî
                if((nlfni+1)%NFDI_PER_SEC) nsec++; 
              
                nclu=(UINT8)(nsec/(pInit_Args->SectorsPerClust));
                if(nsec%(pInit_Args->SectorsPerClust)) nclu++;
              
                for(iClu=0;iClu<nclu;iClu++)
                {
                 Modify_FAT(old_cluster,pInit_Args->Next_Free_Cluster);
                 Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
                 Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø
              
                 temp_sec=SOC(pInit_Args->Next_Free_Cluster);
              
                 old_cluster=pInit_Args->Next_Free_Cluster;
                 Update_Next_Free_Cluster();
              
                 for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
                 {
                  znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                      pitems=((struct FDIesInSEC *)znFAT_Buffer);
                  
                      for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
                      {
                       pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
              
                       if(nlfni>0)
                       {
                        Fill_LFN_FDI(unifn,&temp_lfni,chksum,(UINT8)(nlfni-1));
                    Memory_Copy(((UINT8 *)pitem),((UINT8 *)(&temp_lfni)),FDI_NBYTES); //½«ºÏ³ÉµÄ³¤ÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                        nlfni--;
                       }
                       else
                       {
                        *psec=temp_sec+(UINT32)iSec;
                        *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
                        Memory_Copy(((UINT8 *)pitem),((UINT8 *)pfdi),FDI_NBYTES); //½«¶ÌÃûÏî¿½±´µ½ÉÈÇøÊı¾İÖĞ
                        znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                        return ERR_SUCC;
                       }
                      }
                      znFAT_Device_Write_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 44  

                 }   
                }
                return ERR_SUCC;  
               }
               else
               {
                return ERR_NO_SPACE;
               } 
              }
              #endif
2627          
2628          //===================ÒÔÉÏ´úÂëÓÃÓÚÊµÏÖ³¤ÎÄ¼şÃû¹¦ÄÜ===for LFN=======================================
2629          
2630          /************************************************************************************
2631           ¹¦ÄÜ£º´ò¿ªÎÄ¼ş
2632           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë filepath:ÎÄ¼şµÄÂ·¾¶ n:ĞòºÅ is_file:Òª´ò¿ªÊÇ·ñÊÇÎÄ¼ş
2633           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦ »ò ´íÎóÂë
2634           Ïê½â£º´Ëº¯ÊıµÄ¹¦ÄÜ±È½Ï¶àÑùĞÔ£¬ÎÄ¼şµÄÂ·¾¶Ö§³ÖÎŞÏŞÉî²ãÄ¿Â¼ Èç /a/b/c/d/e/f/g/..../a.txt
2635                 Â·¾¶ÖĞµÄÄ¿Â¼·Ö¸ô·û¿ÉÒÔÎª/»ò\£¨ÔÚCÖĞ×Ö·û´®ÖĞ±í´ï\ÒªÕâÑùĞ´\\£©£¬ÎÄ¼şÃûÖĞÖ§³ÖÄÜÅä
2636                 ·û£¬Èç/a/b/c/d/.../a*.txt /??abc.txt £¬ÎÄ¼şÃûÖ§³Ö³¤ÎÄ¼şÃû£¬¶øÇÒÎŞÂÛ³¤Ãû¶ÌÃû¾ùÖ§
2637                 ³ÖÍ¨Åä£¬ÔÚÊ¹ÓÃÍ¨ÅäÎÄ¼şÃûÊ±£¬ÓëÖ®Æ¥ÅäµÄÎÄ¼ş¿ÉÄÜ»áÓĞ¶à¸ö£¬nÓÃÒÔÖ¸¶¨Òª´ò¿ªµÄÊÇµÚ¼¸
2638                 ¸öÎÄ¼ş£¬´Ëº¯ÊıÒà¿É´ò¿ªÄ¿Â¼£¬ÎÄ¼ş»òÄ¿Â¼´ò¿ªºó£¬ÆäĞÅÏ¢½«±»×°Èëµ½pfiËùÖ¸ÏòµÄÎÄ¼ş
2639                 ĞÅÏ¢¼¯ºÏÖĞ¡£×¢£º¶ÔÓÚÄ¿Â¼ËäÈ»´æ´¢ĞÎÊ½ÉÏÓëÎÄ¼şÏàËÆ£¬¶¼ÊÇÒÔÎÄ¼şÄ¿Â¼ÏîÀ´´æ´¢£¬µ«Ëü
2640                 Ã»ÓĞÎÄ¼ş´óĞ¡µÈ×Ö¶Î£¨ºã¶¨Îª0£©¡£
2641          *************************************************************************************/
2642          #ifdef ZNFAT_OPEN_FILE 
2643          UINT8 znFAT_Open_File(struct FileInfo *pfi,INT8 *filepath,UINT32 n,UINT8 is_file)
2644          {
2645   1       UINT8 result=0,flag=0;
2646   1       UINT32 sec_temp=0,Cur_Cluster=0,fn_pos=0,item=0;
2647   1       UINT32 iSec=0,iFDI=0;
2648   1      
2649   1       //===========for LFN=======
2650   1       #ifdef USE_LFN
               struct LFN_FDI *plfni;
              
               UINT8 cur_binding_sumchk=0;
               UINT8 is_wfn=0;
               UINT16 temp_lfn[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNICODEÂëµÄÁÙÊ±»º³å
               UINT8 is_lfn=0; //ÊäÈëµÄÎÄ¼şÃûÊÇ·ñÊÇ³¤Ãû
               UINT8 is_lfn_buf_err=0; //²úÉú³¤Ãû»º³åÒç³ö´íÎó£¬´Ë±ê¼ÇÎª1ÔòÖ±½ÓÌø¹ı³¤Ãû±È¶Ô
               #endif
2659   1       //===========for LFN=======
2660   1      
2661   1       INT8 temp_filename[13];
2662   1       INT8 *filename;
2663   1      
2664   1       struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
2665   1       struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
2666   1      
2667   1       #ifdef USE_LFN
               pfi->have_lfn=BOOL_FALSE; //ÏÈÉè¶¨ÎÄ¼şÎŞ³¤Ãû
               #endif
2670   1      
2671   1       just_file=pfi;
2672   1      
2673   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 45  

               #endif
2680   1      
2681   1       #ifdef USE_EXCHANGE_BUFFER
               #ifdef USE_ALONE_EXB
               //Memory_Set(just_file->exb_buf,512,0);
               just_file->exb_cursec=0;
               #endif
               #endif
2687   1      
2688   1       result=znFAT_Enter_Dir(filepath,&Cur_Cluster,&fn_pos); //»ñÈ¡Â·¾¶×îºóÒ»¼¶Ä¿Â¼µÄ¿ªÊ¼´Ø
2689   1       if(result) return result;
2690   1      
2691   1       filename=filepath+fn_pos; //filenameÖ¸ÏòfilepathÖĞµÄÎÄ¼şÃû
2692   1                                 //×¢£ºÈç¹û´ò¿ªµÄÊÇÄ¿Â¼£¬ÔòÂ·¾¶filepath²»ÒÔ/»ò\½áÊø£¬Èç´ò¿ªÄ¿Â¼\a\b\c 
2693   1                                 //²»ÒªĞ´³É\a\b\c\£¬ÕâÑù»áÔì³É´ò¿ªÊ§°Ü
2694   1                                 //znFATÈÏÎªÄãÒª´ò¿ªcÄ¿Â¼ÏÂµÄÒ»¸öÃû×ÖÎª¿ÕµÄÄ¿Â¼
2695   1                                 //´ò¿ªÄ¿Â¼Óë½øÈëÄ¿Â¼²»Í¬£¬½øÈëÄ¿Â¼½ö»ñÈ¡Ä¿Â¼Ê×´Ø£¬¶ø´ò¿ªÄ¿Â¼
2696   1                                 //Ôò¶ÔÄ¿Â¼½øĞĞ½âÎö£¬½«ÎÄ¼şÏà¹Ø²ÎÊıÌîÈëÎÄ¼şĞÅÏ¢¼¯ºÏ£¬ÈçÄ¿Â¼´´½¨Ê±¼äµÈ
2697   1      
2698   1       if(Check_Illegal_Char(filename)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û£¬ÎŞÂÛ³¤Ãû»¹ÊÇ¶ÌÃû£¬»òÊ
             -ÇÍ¨ÅäÃû 
2699   1      
2700   1       //ÕâÀïÖ÷ÒªÕë¶ÔÓÚLFN¡¢SFN¼°Í¨ÅäÃû½øĞĞÏà¹Ø¼ì²â
2701   1       if(!Is_WildFileName(filename)) //Èç¹û²»ÊÇÍ¨ÅäÎÄ¼şÃû£¬¼´È·¶¨Ãû£¬ÔòĞèÒª½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²â
2702   1       {
2703   2        #ifdef USE_LFN
                if(!Is_LFN(filename)) //Èç¹û²»ÊÇ³¤Ãû,¼´ÊÇ¶ÌÃû
                {
                #endif
2707   2         //¼ì²éSFNºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é±È½ÏÑÏ¸ñ)
2708   2         //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
2709   2      
2710   2         if(Check_SFN_Illegal_Length(filename)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
2711   2         if(Check_SFN_Dot(filename)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
2712   2         if(Check_SFN_Special_Char(filename)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
2713   2         if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´
             -óĞ¡Ğ´
2714   2      
2715   2        #ifdef USE_LFN
                }
                else //Èç¹ûÊÇ³¤Ãû
                {
                 is_lfn=1; //±ê¼ÇÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû
                 result=oemstr2unistr(filename,temp_lfn);//°Ñfilename×ªÎªUNICODEÂë£¬´æÔÚtemp_lfnÀï£¬ÒÔ±ãºóÃæ½øĞĞÎÄ¼şÃû±È
             -¶Ô
                 if(result) return result;
                }
                #endif
2724   2       }
2725   1       else //Èç¹ûÊÇÍ¨ÅäÃû£¬¼´º¬ÓĞ*»ò?
2726   1       {
2727   2        #ifdef USE_LFN
                is_wfn=1; //±êÖ¾ÊäÈëµÄÎÄ¼şÃûÎªÍ¨ÅäÃû
                is_lfn=1; //ÔÚÕâÖÖÇé¿öÏÂ£¬Ò²ÈÏÎªÊÇ³¤Ãû£¬Í¨ÅäÃûÒ²ÒªÓëLFNÏà±È¶Ô
                result=oemstr2unistr(filename,temp_lfn); //×ªÎª´øÍ¨Åä·ûµÄUNI´®
                if(result) return result; //OEM×Ö·û¼¯²»ÍêÈ«£¬OEM->UNI×ª»»ÖĞÓĞ×Ö·ûÕÒ²»µ½ »ò LFN»º³åÒç³ö
                #endif
2733   2       }
2734   1      
2735   1       //================================================
2736   1       do
2737   1       {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 46  

2738   2        sec_temp=SOC(Cur_Cluster); //µ±Ç°´ØÊ×ÉÈÇø
2739   2        for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
2740   2        {
2741   3         znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
2742   3         pitems=(struct FDIesInSEC *)znFAT_Buffer; 
2743   3      
2744   3         for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
2745   3         {
2746   4          pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
2747   4           
2748   4          if((is_file?CHK_ATTR_FILE(pitem->Attributes):CHK_ATTR_DIR(pitem->Attributes)) 
2749   4                      && (0XE5!=pitem->Name[0]) && ('.'!=pitem->Name[0])) //ÒÀis_file¼ì²éÊôĞÔ£¬ÇÒÃ»ÓĞ±»É¾³ı
2750   4                                                                          //²»ÊÇ.Óë..
2751   4          {
2752   5           To_File_Name((INT8 *)(pitem->Name),temp_filename); //½«FDIÖĞµÄÎÄ¼şÃû×Ö¶Î×ªÎª8.3ÎÄ¼şÃû
2753   5      
2754   5               #ifdef USE_LFN 
                   if(!is_lfn || is_wfn) //Èç¹ûÊäÈëµÄÎÄ¼şÃû²»ÊÇ³¤ÎÄ¼şÃû£¬¼´Îª¶ÌÎÄ¼şÃû£¬»òÕßÊÇÅäÍ¨Ãû£¬ÔòÒª½øĞĞSFN±È¶Ô
                       #endif                //Ö÷ÒªÊÇÎªÁË·ÀÖ¹¶àÓàµÄ²Ù×÷£¬Èç¹ûÊäÈëÎÄ¼şÃûÎª³¤ÎÄ¼şÃû£¬Ôò¸ù±¾²»ÓÃSFN±È¶Ô£¬¾Í
2757   5                                         //Ëã±È¶Ô£¬½á¹ûÒ²Ò»¶¨ÊÇ²»Æ¥ÅäµÄ
2758   5           {
2759   6            if(!SFN_Match(filename,temp_filename)) //¶ÌÎÄ¼şÃûÍ¨Åä
2760   6                {
2761   7                 if(n==item)
2762   7                 {
2763   8              Analyse_FDI(pfi,pitem); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
2764   8                  pfi->FDI_Sec=sec_temp+iSec; //ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
2765   8                  pfi->nFDI=(UINT8)iFDI; //ÎÄ¼şÄ¿Â¼ÏîÔÚÉÈÇøÖĞµÄË÷Òı
2766   8      
2767   8              #ifdef USE_LFN
                          if(!pfi->have_lfn) (pfi->longname)[0]=0;
                      #endif
2770   8      
2771   8                  return ERR_SUCC;
2772   8                 } 
2773   7                 flag=1;
2774   7                }
2775   6               }
2776   5      
2777   5           #ifdef USE_LFN
                   if(is_lfn && (pfi->have_lfn) && !is_lfn_buf_err) //Èç¹ûÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû£¬¶øÇÒÒ²·¢ÏÖÁË³¤Ãû
                       {
                        if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª
                        {                                                     //³¤ÃûÓĞĞ§
                     if(!LFN_Match(temp_lfn,(pfi->longname))) //³¤ÎÄ¼şÃûÍ¨Åä
                         {
                          if(n==item)
                              {
                       Analyse_FDI(pfi,pitem); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
                           pfi->FDI_Sec=sec_temp+iSec; //ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                           pfi->nFDI=(UINT8)iFDI; //ÎÄ¼şÄ¿Â¼ÏîÔÚÉÈÇøÖĞµÄË÷Òı
                           return ERR_SUCC;
                              }
                          flag=1;
                         }    
                        }
                       }
              
                       if(is_lfn_buf_err) is_lfn_buf_err=0;
                   #endif
2798   5      
2799   5               if(flag) {item++;flag=0;} //Èç¹ûLFN£¨Èç¹ûÓÃÁËLFNµÄ»°£©ÓëSFNÓĞÒ»Ïî±È¶Ô³É¹¦£¬µ«item²»Æ¥Åä£¬Ôòitem++
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 47  

2800   5              }
2801   4      
2802   4          #ifdef USE_LFN
                              if((CHK_ATTR_DIR(pitem->Attributes))||(CHK_ATTR_FILE(pitem->Attributes))) //Èç¹ûÓöµ½¶ÌÃûÏî»Ö¸´³¤¶È´íÎó±ê
             -¼Ç
                                      if(is_lfn_buf_err) is_lfn_buf_err=0;
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0]) && is_lfn) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı£¬²¢
             -ÇÒÊäÈëµÄÎÄ¼şÃûÊÇ³¤Ãû
                      {                                                                       //ÒòÎªÈç¹ûÎÒÃÇÊäÈëµÄÎÄ¼şÃû±¾Éí¾Í²
             -»ÊÇ³¤Ãû£¬ÄÇÎÒÃÇ¾ÍÃ»±ØÒªÈ¥¹ØĞÄ³¤ÃûÏî
                   pfi->have_lfn=1;
                       
                       plfni=(struct LFN_FDI *)pitem;
              
                       cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
                  
                   result=Get_Part_Name(pfi->longname,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖ
             -ĞµÄÎÄ¼şÃûUNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                        //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
                       if(result) is_lfn_buf_err=1; //·¢ÉúLFN_BUFÒç³ö´íÎó
                      }
                      else
                      {
                       pfi->have_lfn=0;
                      }
                  #endif
2824   4      
2825   4         }
2826   3        }
2827   2      
2828   2        Cur_Cluster=Get_Next_Cluster(Cur_Cluster); //»ñÈ¡ÏÂÒ»´Ø
2829   2       }while(!IS_END_CLU(Cur_Cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
2830   1      
2831   1       return ERR_NO_FILE;
2832   1      }
2833          #endif
2834          
2835          /************************************************************************************
2836           ¹¦ÄÜ£º»ñÈ¡Ò»¸öÄ¿Â¼µÄ¿ªÊ¼´Ø
2837           ĞÎ²Î£ºdir_name:Ä¿Â¼Ãû pCluster:Ö¸ÏòÓÃÓÚ´æ´¢´ØºÅµÄ±äÁ¿µÄÖ¸Õë ×¢£º´ËÖ¸Õë²»¹âÓÃÓÚ½«Ä¿Â¼
2838                 ËùÔÚµÄÄ¿Â¼´ØºÅ´«Èë£¬Í¬Ê±ÓÖ½ÓÊÕÄ¿Â¼µÄ¿ªÊ¼´Ø¡£±ÈÈç£ºÎÒÃÇÒª»ñÈ¡ /a/b/c cÄ¿Â¼µÄ¿ª
2839                 ´Ø£¬pClusterÊ×ÏÈ´«ÈëbµÄ¿ªÊ¼´Ø£¬È»ºó³ÌĞò»áÔÚÕâ¸ö¿ªÊ¼´Ø¼°Æäºó¼Ì´ØÖĞÑ°ÕÒÎªÃûdir_n
2840                 ameµÄÄ¿Â¼Ïî£¬ÕÒµ½ºó£¬½«Æä¿ªÊ¼Í¨¹ıpCluster´«»Ø£¬¼´pClusterËùÖ¸ÏòµÄ±äÁ¿·¢ÉúÁË¸Ä
2841                 ±ä¡£
2842           ·µ»Ø£ºÔËĞĞ½á¹û   ³É¹¦»ò´íÎóºÅ
2843           Ïê½â£º´Ëº¯ÊıµÄÊµÏÖ¹ı³ÌÓë´ò¿ªÎÄ¼ş²î²»¶à£¬¶øÇÒ±ÈËü»¹¼òµ¥Ğ©¡£dir_nameÍ¬ÑùÖ§³Ö³¤ÎÄ¼şÃû¼°
2844                 Í¨Åä¡£
2845          *************************************************************************************/
2846          #ifdef GET_DIR_START_CLUSTER
2847          UINT8 Get_Dir_Start_Cluster(INT8 *dir_name,UINT32 *pCluster) //»ñÈ¡Ä¿Â¼ÏÂÃûÎªdir_nameµÄ×ÓÄ¿Â¼µÄ¿ªÊ¼´Ø
2848          {                                                            //Ä¿Â¼µÄÊ×´Ø´æÈëpClusterËùÖ¸ÈëµÄ±äÁ¿
2849   1       UINT32 sec_temp=0;
2850   1       UINT8 iSec=0,iFDI=0;
2851   1       UINT32 Cur_Clust=*pCluster;
2852   1      
2853   1       //===========for LFN=======
2854   1       #ifdef USE_LFN
               struct LFN_FDI *plfni;
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 48  

               UINT8 cur_binding_sumchk=0,result=0;
               UINT16 temp_lfn[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNICODEÂëµÄÁÙÊ±»º³å
               UINT16 lfn_buf[MAX_LFN_LEN+1]; //´Ó³¤ÃûÏîÖĞÌáÈ¡µÄUNIÂë×°µ½Õâ¸ö»º³åÖĞ
               UINT8 is_lfn=0; //ÊäÈëµÄÎÄ¼şÃûÊÇ·ñÊÇ³¤Ãû
               UINT8 have_lfn=0; //ÔÚËÑË÷Ä¿Â¼ÏîÊ±·¢ÏÖÁË³¤ÃûÏî
               UINT8 is_lfn_buf_err=0; //²úÉú³¤Ãû»º³åÒç³ö´íÎó£¬´Ë±ê¼ÇÎª1ÔòÖ±½ÓÌø¹ı³¤Ãû±È¶Ô
               #endif
2864   1      
2865   1       //===========for LFN=======
2866   1      
2867   1       INT8 temp_dirname[13];
2868   1      
2869   1       struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
2870   1       struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
2871   1      
2872   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
2875   1      
2876   1       if(Check_Illegal_Char(dir_name)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
2877   1      
2878   1       #ifdef USE_LFN
               if(!Is_LFN(dir_name)) //Èç¹û²»ÊÇ³¤Ãû,¼´ÊÇ¶ÌÃû
               {
               #endif
2882   1        //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
2883   1        //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
2884   1        if(Check_SFN_Illegal_Length(dir_name)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
2885   1        if(Check_SFN_Dot(dir_name)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨  
2886   1        if(Check_SFN_Special_Char(dir_name)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
2887   1        if(((UINT8)(-1))==Check_SFN_Illegal_Lower(dir_name)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
2888   1       #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                is_lfn=1; //±ê¼ÇÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû
                result=oemstr2unistr(dir_name,temp_lfn);//°Ñfilename×ªÎªUNICODEÂë£¬´æÔÚtemp_lfnÀï£¬ÒÔ±ãºóÃæ½øĞĞÎÄ¼şÃû±È¶
             -Ô
                if(result) return result;
               }
               #endif
2897   1      
2898   1       //================================================
2899   1       do
2900   1       {
2901   2        sec_temp=SOC(Cur_Clust); //µ±Ç°´ØÊ×ÉÈÇø
2902   2        for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
2903   2        {
2904   3         znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
2905   3         pitems=(struct FDIesInSEC *)znFAT_Buffer; 
2906   3      
2907   3         for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
2908   3         {
2909   4          pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
2910   4           
2911   4          if((CHK_ATTR_DIR(pitem->Attributes)) && (0XE5!=pitem->Name[0])) //ÎÄ¼şÊôĞÔÎªÄ¿Â¼£¬ÇÒÃ»ÓĞ±»É¾³ı
2912   4          {
2913   5           To_File_Name((INT8 *)(pitem->Name),temp_dirname); //½«FDIÖĞµÄÄ¿Â¼Ãû×Ö¶Î×ªÎª8.3ÎÄ¼şÃû
2914   5           #ifdef USE_LFN
                   if(!is_lfn)
                   #endif
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 49  

2917   5               {
2918   6            if(!SFN_Match(dir_name,temp_dirname)) //Ä¿Â¼ÃûÆ¥Åä
2919   6                {
2920   7                 //»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø 
2921   7                 *pCluster=(Bytes2Value(pitem->LowClust,2))|(Bytes2Value(pitem->HighClust,2)<<16); 
2922   7                 return ERR_SUCC;
2923   7                }
2924   6               }
2925   5      
2926   5           #ifdef USE_LFN
                   if(is_lfn && have_lfn && !is_lfn_buf_err) //Èç¹ûÊäÈëµÄÎÄ¼şÃûÎª³¤Ãû£¬¶øÇÒÒ²·¢ÏÖÁË³¤Ãû
                       {                                         //Í¬Ê±ÓÖÃ»ÓĞ·¢Éú³¤Ãû»º³åÒç³ö´íÎó
                        if(cur_binding_sumchk==Get_Binding_SumChk(pitem)) //Èç¹ûLFNÓëSFNÄ¿Â¼Ïî°ó¶¨Ğ£ÑéºÍÏàµÈ£¬ÔòÈÏÎª
                        {                                                     //³¤ÃûÓĞĞ§
                     if(!LFN_Match(temp_lfn,lfn_buf)) //³¤ÎÄ¼şÃûÍ¨Åä
                         {
                          //»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø 
                          *pCluster=(Bytes2Value(pitem->LowClust,2))|(Bytes2Value(pitem->HighClust,2)<<16); 
                              return ERR_SUCC;
                         }    
                        }
                       }
                   #endif
2940   5      
2941   5          }
2942   4      
2943   4          #ifdef USE_LFN
                      if((CHK_ATTR_DIR(pitem->Attributes))||(CHK_ATTR_FILE(pitem->Attributes))) //Èç¹ûÓöµ½¶ÌÃûÏî»Ö¸´³¤¶È´íÎó±ê¼
             -Ç
                                      if(is_lfn_buf_err) is_lfn_buf_err=0;
              
                  if(CHK_ATTR_LFN(pitem->Attributes) && (0XE5!=pitem->Name[0]) && is_lfn) //ÊÇ³¤ÃûÏî£¬¶øÇÒÃ»ÓĞ±»É¾³ı,ÊäÈ
             -ëµÄÃû×ÓÎª³¤Ãû
                      {
                   have_lfn=1;
                       
                       plfni=(struct LFN_FDI *)pitem;
              
                       cur_binding_sumchk=(plfni->ChkVal)[0]; //»ñÈ¡³¤ÃûÏîµÄ°ó¶¨Ğ£ÑéºÍ
                  
                   result=Get_Part_Name(lfn_buf,plfni,(UINT8)((((plfni->AttrByte[0])&0XBF)-1)*13)); //½«µ±Ç°LFNÏîÖĞµÄÎÄ¼
             -şÃûUNICODEÂëÆ´ÈëÁÙÊ±»º³å
                                                                                    //´ËÁÙÊ±»º³å³¤¶ÈÎªMAX_LFN_LEN£¬Èç¹ûÔ
             -½½ç£¬Ôò
                                                                                        //²»ÔÙ×°Èë£¬×îÖÕÔì³ÉLFNµÄ½Ø¶Ï¡£
                       if(result) is_lfn_buf_err=1; //Èç¹û·¢ÉúLFN_BUFÒç³ö´íÎó
                      }
                  #endif
2961   4         }
2962   3        }
2963   2      
2964   2        Cur_Clust=Get_Next_Cluster(Cur_Clust); //»ñÈ¡ÏÂÒ»´Ø
2965   2       }while(!IS_END_CLU(Cur_Clust)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
2966   1      
2967   1       return ERR_NO_DIR; 
2968   1      }
2969          #endif
2970          
2971          /************************************************************************************
2972           ¹¦ÄÜ£º½øÈëÒ»¸öÄ¿Â¼£¬ÊµÎª»ñÈ¡Ä¿Â¼µÄ¿ªÊ¼´Ø
2973           ĞÎ²Î£ºdirpath:Ä¿Â¼µÄÂ·¾¶ pCluster:Ö¸ÏòÓÃÓÚ¼ÇÂ¼´ØºÅµÄ±äÁ¿µÄÖ¸Õë pos:Â·¾¶ÖĞÎÄ¼şÃûµÄÎ»ÖÃ
2974           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 50  

2975           Ïê½â£º´Ëº¯ÊıËäÈ»Ê¹ÓÃÕß¿É¼û£¬µ«ÓÃ´¦²»´ó¡£Ëü·µ»ØÄ¿Â¼µÄ¿ªÊ¼´Ø¡£dirpath¿ÉÒÔ´øÓĞÎÄ¼şÃû£¬Èç
2976                 /a/b/c/d/e/test.txt º¯ÊıÔËĞĞÖ®ºóposËùÖ¸ÏòµÄ±äÁ¿µÄÖµÎªtest.txtÔÚÂ·¾¶ÖĞµÄÎ»ÖÃ¡£Ö÷
2977                 ÒªÊÇ¿¼ÂÇµ½´Ëº¯ÊıÓë´ò¿ªÎÄ¼ş»òÄ¿Â¼µÄº¯ÊıÏàÅäºÏ£¬¿ÉÒÔºÜ·½±ãµÄ´ÓÂ·¾¶ÖĞÌáÈ¡ÖĞÎÄ¼şÃû
2978          *************************************************************************************/
2979          #ifdef ZNFAT_ENTER_DIR
2980          UINT8 znFAT_Enter_Dir(INT8 *dirpath,UINT32 *pCluster,UINT32 *pos) 
2981          {
2982   1       UINT8 index=0,res=0;
2983   1       UINT32 i=1;
2984   1      
2985   1       #ifndef USE_LFN
2986   1       INT8 dirname[13];
2987   1       #else
               INT8 dirname[MAX_LFN_LEN+1];
               #endif
2990   1      
2991   1       *pos=1;
2992   1       *pCluster=2;
2993   1      
2994   1       if(('\\'==dirpath[0] || '/'==dirpath[0]) && '\0'==dirpath[1]) //Èç¹ûÊÇ"\\"£¬ÔòÖ±½ÓÈ¡Ê×Ä¿Â¼´Ø£¬¼´µÚ2´Ø
2995   1       {
2996   2        return ERR_SUCC;
2997   2       }
2998   1      
2999   1       while('\0'!=dirpath[i])
3000   1       {
3001   2        if('\\'==dirpath[i] || '/'==dirpath[i])
3002   2        {
3003   3         dirname[index]='\0';
3004   3         index=0;
3005   3         
3006   3         res=Get_Dir_Start_Cluster(dirname,pCluster);
3007   3         if(res) 
3008   3         { 
3009   4              return res;  //·µ»Ø´íÎóÂë  
3010   4         }
3011   3         *pos=i+1;
3012   3        } 
3013   2        else
3014   2        {
3015   3         dirname[index]=dirpath[i];
3016   3         index++;
3017   3         #ifndef USE_LFN
3018   3         if(index>12) //Èç¹û²»Ê¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ı8+1+3
3019   3         {
3020   4              return ERR_SFN_ILL_LEN; //Ä¿Â¼Ãû³¤ÓÚ8.3£¬Òà·ÀÖ¹dirnameÒç³ö
3021   4         }
3022   3         #else
                 if(index>MAX_LFN_LEN) //Èç¹ûÊ¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ıÉè¶¨µÄ³¤Ãû×î³¤³¤¶È
                 {
                      return ERR_LFN_BUF_OUT; //Ä¿Â¼Ãû³¤ÓÚMAX_LFN_LEN£¬Òà·ÀÖ¹dirnameÒç³ö
                 }   
                 #endif
3028   3        }
3029   2        i++;
3030   2       }
3031   1         
3032   1       return ERR_SUCC; //³É¹¦
3033   1      }
3034          #endif
3035          
3036          /************************************************************************************
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 51  

3037           ¹¦ÄÜ£ºÓÉ¸ø¶¨µÄ¶ÌÎÄ¼şÃû¼°Ê±¼äĞÅÏ¢£¬¹¹Ôì³öÒ»¸öÎÄ¼şÄ¿Â¼Ïî
3038           ĞÎ²Î£ºpfdi:Ö¸ÏòÓÃÓÚ×°ÔØÎÄ¼şÄ¿Â¼ÏîµÄ±äÁ¿µÄÖ¸Õë pfn:Ö¸ÏòÎÄ¼şÃû pdt:Ö¸ÏòÊ±¼äĞÅÏ¢ 
3039                 is_file:¹¹ÔìµÄÎÄ¼şÄ¿Â¼ÏîÓÃÓÚ±í´ïÎÄ¼ş»¹ÊÇÄ¿Â¼
3040           ·µ»Ø£º0
3041           Ïê½â£ºÔÚ¹¹ÔìÄ¿Â¼µÄÎÄ¼şÄ¿Â¼ÏîÊ±£¬ÒªÊÂÏÈÎªÆä·ÖÅäºÃ¿Õ´Ø£¬Òò´ËÒıÈëÁËis_fileÓÃÒÔÇø·Ö¡£
3042          *************************************************************************************/
3043          #ifdef FILL_FDI
              UINT8 Fill_FDI(struct FDI *pfdi,INT8 *pfn,struct DateTime *pdt,UINT8 is_file)
              {
               UINT8 dot_pos=0,have_dot=0,lowcase=0;
               UINT8 i=0,j=0,fn_len=(UINT8)StringLen(pfn);
               UINT16 time=0,date=0;
              
               Memory_Set(((UINT8 *)pfdi),FDI_NBYTES,0); //¶ÔÎÄ¼şÄ¿Â¼ÏîÇå0
              
               for(i=(UINT8)(fn_len-1);i>0;i--) //·´ÏòÑ°ÕÒ. µÚÒ»¸ö.ÊÇÖ÷ÎÄ¼şÓëÀ©Õ¹ÃûµÄ·Ö½ç
               {
                if('.'==pfn[i]) 
                {
                 dot_pos=i;
                 have_dot=1;
                 break;
                }
               } 
              
               if(have_dot) //Èç¹ûÓĞµã
               {
                //ÌîÈëÖ÷ÎÄ¼şÃû
                for(i=0;i<dot_pos;i++)
                {
                 (pfdi->Name)[i]=(INT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
                }
                for(;i<8;i++)
                {
                 (pfdi->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
                }
              
                //ÌîÈëÀ©Õ¹Ãû
                for(i=(UINT8)(dot_pos+1);i<fn_len;i++)
                {
                 (pfdi->Extension)[j]=(UINT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
                 j++;
                }
                for(;j<3;j++)
                {
                 (pfdi->Extension)[j]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
                }
               }
               else //Èç¹ûÃ»ÓĞµã
               {
                //ÌîÈëÖ÷ÎÄ¼şÃû
                for(i=0;i<fn_len;i++)
                {
                 (pfdi->Name)[i]=(UINT8)Lower2Up(pfn[i]); //×ªÎª´óĞ´
                }
                for(;i<8;i++)
                {
                 (pfdi->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
                } 
                
                //ÌîÈëÀ©Õ¹Ãû
                for(j=0;j<3;j++)
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 52  

                {
                 (pfdi->Extension)[j]=' '; //À©Õ¹ÃûÌîÈë¿Õ¸ñ
                }
               }
               //=======================ÌîÈëÖ÷ÎÄ¼şÃûÓëÀ©Õ¹Ãû========
              
               pfdi->Attributes=(UINT8)(is_file?0X20:0X30); //ÉèÖÃÊôĞÔ
               //=======================ÌîÈëÊôĞÔ========
              
               lowcase=Check_SFN_Illegal_Lower(pfn); //»ñÈ¡Ö÷ÎÄ¼şÃûÓëÀ©Õ¹ÃûµÄ´óĞ¡Ğ´×´Ì¬
               if((lowcase&0X0F)==0X01) //Èç¹ûÖ÷ÎÄ¼şÃûÎªĞ¡Ğ´
               {
                pfdi->LowerCase|=0X08;
               }
               if((lowcase&0XF0)==0X10) //Èç¹ûÀ©Õ¹ÃûÎªĞ¡Ğ´
               {
                pfdi->LowerCase|=0X10;
               }
               //=======================ÌîÈë´óĞ¡Ğ´¿ØÖÆ×Ö============
              
               pfdi->CTime10ms=(UINT8)((((pdt->time).sec)%2)?0X78:0X00);
               //=======================ÌîÈë´´½¨Ê±¼ä10MSÎ»==========
              
               time=(UINT16)(MAKE_TIME((pdt->time).hour,(pdt->time).min,(pdt->time).sec));
               (pfdi->CTime)[0]=(UINT8)time;
               (pfdi->CTime)[1]=(UINT8)(time>>8);
               //=======================ÌîÈë´´½¨Ê±¼ä================
              
               date=(UINT16)(MAKE_DATE((pdt->date).year,(pdt->date).month,(pdt->date).day));
               (pfdi->CDate)[0]=(UINT8)date;
               (pfdi->CDate)[1]=(UINT8)(date>>8);
               //=======================ÌîÈë´´½¨ÈÕÆÚ================
              
               (pfdi->ADate)[0]=(UINT8)date;
               (pfdi->ADate)[1]=(UINT8)(date>>8);
               //=======================ÌîÈë·ÃÎÊÈÕÆÚ================
               
               (pfdi->MTime)[0]=(UINT8)time;
               (pfdi->MTime)[1]=(UINT8)(time>>8);
               //=======================ÌîÈëĞŞ¸ÄÊ±¼ä================ 
              
               (pfdi->MDate)[0]=(UINT8)date;
               (pfdi->MDate)[1]=(UINT8)(date>>8);
               //=======================ÌîÈëĞŞ¸ÄÈÕÆÚ================
              
               //Ìî³ä¿ªÊ¼´Ø
               if(!is_file) //Èç¹ûÊÇÄ¿Â¼£¬ÔòÔÚfdiÖĞÌî³ä¿Õ´Ø
               {
                pfdi->HighClust[0]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>16)&0X000000FF);//Ä¿Â¼ÓëÎÄ¼ş²»Í¬£¬Ä¿Â¼ÔÚ´´½
             -¨Ö®³õ
                pfdi->HighClust[1]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>24)&0X000000FF);//¾ÍÒªÎªÆä·ÖÅä¿Õ´Ø£¬ÎªµÄÊÇĞ
             -´Èë.Óë..
                pfdi->LowClust [0]=(UINT8)(((pInit_Args->Next_Free_Cluster)    )&0X000000FF);//ÕâÁ½¸öÌØÊâµÄÎÄ¼şÄ¿Â¼Ïî
                pfdi->LowClust [1]=(UINT8)(((pInit_Args->Next_Free_Cluster)>>8 )&0X000000FF);                           
             -                                                                                                                        
             -               
               }
              
               //ÎÄ¼ş´óĞ¡×Ö¶ÎÔİÖÃÎª0
               return 0;
              }
              #endif
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 53  

3157          
3158          /************************************************************************************
3159           ¹¦ÄÜ£ºÏò¹¹ÔìºÃµÄÎÄ¼şÄ¿Â¼Ïî×¢²áµ½Ä¿Â¼´ØÖĞÈ¥
3160           ĞÎ²Î£ºcluster:Ä¿Â¼´Ø pfdi:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë psec:ÎÄ¼şÄ¿Â¼Ïî±»Ğ´µ½µÄÉÈÇøµØÖ· 
3161                 pn:ÎÄ¼şÄ¿Â¼ÏîÔÚÆäÉÈÇøÖĞµÄÎ»ÖÃ 
3162           ·µ»Ø£ºÔËĞĞ½á¹û£¬³É¹¦»ò´íÎóÎó
3163           Ïê½â£º´Ëº¯ÊıÊÇ´´½¨ÎÄ¼şºÍÄ¿Â¼µÄÖØÒªºËĞÄ²Ù×÷£¬ËüÊÇÕë¶Ô¶ÌÃûµÄ£¬ÓëRegister_LFN_FDIÏà¶ÔÓ¦
3164          *************************************************************************************/
3165          #ifdef REGISTER_FDI
              UINT8 Register_FDI(UINT32 cluster,struct FDI *pfdi,UINT32 *psec,UINT8 *pn)
              {
               UINT32 temp_sec=0,old_cluster=0;
               UINT8 iSec=0,iFDI=0;
               struct FDIesInSEC *pfdis;
              
               if(0==pInit_Args->Free_nCluster) return ERR_NO_SPACE; //Èç¹ûÃ»ÓĞ¿Õ¼ä£¬ÔòÖ±½Ó·µ»Ø
               
               //ÒÔÏÂ´úÂë¼ì²éÊÇ·ñÒÑ¾­´æÔÚÖØ¸´µÄÎÄ¼şÄ¿Â¼Ïî£¬ÒÔ¼°²éÑ¯¿ÕÎ»
               do
               {
                temp_sec=SOC(cluster);
                for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
                {
                 znFAT_Device_Read_Sector(temp_sec+(UINT32)iSec,znFAT_Buffer);
                 pfdis=((struct FDIesInSEC *)znFAT_Buffer);
                 for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
                 {
                  if(Memory_Compare((UINT8*)((pfdis->FDIes)+iFDI),(UINT8*)pfdi,11))  //±È½ÏÎÄ¼şÃû
                  {
                   *psec=temp_sec+(UINT32)iSec;
                   *pn=iFDI; //¼ÇÂ¼ÖØÃûÎÄ¼şÄ¿Â¼ÏîµÄÎ»ÖÃ£¬ÒÔ±ã¶ÔÆä½øĞĞ½âÎö
                   return ERR_FDI_ALREADY_EXISTING;
                  }
                  else
                  {
                       if(0==((((pfdis->FDIes)[iFDI]).Name)[0]))
                       {
                        *psec=temp_sec+(UINT32)iSec;
                        *pn=iFDI; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
              
                    znFAT_Device_Read_Sector(*psec,znFAT_Buffer);
                    Memory_Copy((UINT8*)((((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+*pn),(UINT8 *)pfdi,FDI_NBYTES);
                    znFAT_Device_Write_Sector(*psec,znFAT_Buffer);
              
                        return ERR_SUCC;
                       }
                  }
                 }
                }
                old_cluster=cluster;
                cluster=Get_Next_Cluster(cluster);
               }while(!IS_END_CLU(cluster)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
               //===========================================================
               //Èç¹ûÔËĞĞµ½ÕâÀï£¬ÔòËµÃ÷µ±Ç°´ØÖĞÒÑÎŞ¿ÕÎ»
               if(0!=pInit_Args->Free_nCluster) //Èç¹ûÊ£Óà¿Õ´ØÊıÎª0£¬ÔòËµÃ÷´ÅÅÌÒÑÎŞ¿Õ¼ä
               {
                Modify_FAT(old_cluster,pInit_Args->Next_Free_Cluster);
                Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
                Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø
              
                *psec=SOC(pInit_Args->Next_Free_Cluster);
                *pn=0; //¼ÇÂ¼¿ÕÎ»µÄÎ»ÖÃ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 54  

              
                znFAT_Device_Read_Sector(*psec,znFAT_Buffer);
                Memory_Copy((UINT8*)((((struct FDIesInSEC *)znFAT_Buffer)->FDIes)),(UINT8 *)pfdi,FDI_NBYTES);
                znFAT_Device_Write_Sector(*psec,znFAT_Buffer);
              
                Update_Next_Free_Cluster();
              
                return ERR_SUCC;  
               }
               else
               {
                return ERR_NO_SPACE;
               } 
              }
              #endif
3234          
3235          /************************************************************************************
3236           ¹¦ÄÜ£ºÎÄ¼ş´´½¨
3237           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏÖ¸Õë pfn:Ö¸ÏòÎÄ¼şÂ·¾¶ pdt:Ö¸ÏòÊ±¼äĞÅÏ¢
3238           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3239           Ïê½â£º´Ëº¯Êı¿ÉÒÔÖ§³Ö¶ÌÃûÓë³¤Ãû£¬ÎŞÏŞÉî²ãÄ¿Â¼¡£ÎÄ¼ş´´½¨Íê³ÉÖ®ºó£¬ĞÂ½¨ÎÄ¼şµÄĞÅÏ¢½«±»
3240                 ×°ÈëÎÄ¼şĞÅÏ¢¼¯ºÏ£¬Ëæ¼´¿ÉÒÔ¶Ô´ËÎÄ¼ş½øĞĞ²Ù×÷£¬¶øÎŞĞè´ò´Îµ÷open_file´ò¿ªËü¡£Èç¹û
3241                 Òª´´½¨µÄÎÄ¼şÒÑ¾­ÓĞÖØÃû£¬Ôò·µ»ØÖØÃû´íÎó£¬²¢½«ÒÑ¾­´æÔÚµÄÎÄ¼şµÄĞÅÏ¢×°ÈëÎÄ¼şĞÅÏ¢
3242                 ¼¯ºÏ¡£Òò´ËËüÄ³Ğ©Çé¿öÏÂÒ²¿ÉÒÔÓÃÀ´³äµ±open_fileº¯Êı£ºÃ»ÓĞÖØÃûÎÄ¼ş¾Í´´½¨Ò»¸öĞÂµÄ£¬
3243                 Èç¹ûÓĞÖØÃûÎÄ¼şÔò´ò¿ª¡£
3244          *************************************************************************************/
3245          #ifdef ZNFAT_CREATE_FILE
              UINT8 znFAT_Create_File(struct FileInfo *pfi,INT8 *pfn,struct DateTime *pdt)
              {
               UINT32 Cur_Cluster=0,pos=0,sec=0;
               UINT8 res=0,n=0;
               struct FDI fdi;
               INT8 *filename;
              
               #ifdef USE_LFN
               UINT8 is_lfn=0;
               INT8 temp_filename[13];
               #endif
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               Memory_Set((UINT8 *)pcccb_buf,sizeof(UINT32)*CCCB_LEN,0);
               #endif
               #endif
              
               #ifdef USE_EXCHANGE_BUFFER
               #ifdef USE_ALONE_EXB
               //Memory_Set(just_file->exb_buf,512,0);
               just_file->exb_cursec=0;
               #endif
               #endif
              
               res=znFAT_Enter_Dir(pfn,&Cur_Cluster,&pos); //½øÈëÄ¿Â¼
               if(res)
               {
                return res;
               }
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 55  

               filename=pfn+pos;
              
               if(Check_Illegal_Char(filename)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
               
               #ifdef USE_LFN
               if(!Is_LFN(filename))
               {
               #endif
                //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
                //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
                if(Check_SFN_Illegal_Length(filename)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
                if(Check_SFN_Dot(filename)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
                if(Check_SFN_Special_Char(filename)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
                if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
               #ifdef USE_LFN
               }
               else
               {
                is_lfn=1;
                res=oemstr2unistr(filename,pfi->longname); //Èç¹ûÊÇ³¤Ãû£¬Ôò½«filename×ªÎªUNI´®
                if(res) return res;
               }
              
               if(!is_lfn) //Èç¹û²»ÊÇ³¤Ãû
               {
               #endif
                Fill_FDI(&fdi,filename,pdt,BOOL_TRUE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
                res=Register_FDI(Cur_Cluster,&fdi,&sec,&n);//ÔÚµ±Ç°´ØÖĞ½øĞĞÎÄ¼şÄ¿Â¼ÏîµÄ"×¢²á"
              
               #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                Make_Short_Name(filename,temp_filename);
                Fill_FDI(&fdi,temp_filename,pdt,BOOL_TRUE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
                res=Register_LFN_FDI(Cur_Cluster,&fdi,(pfi->longname),&sec,&n); //ÔÚµ±Ç°´ØÖĞ½øĞĞ³¤ÃûÏî¼°ÏàÓ¦¶ÌÃûÏî¡°×¢²á
             -¡±
               }
               #endif
               
               if(!res)
               {
                //½«ĞÂ½¨ÎÄ¼şµÄĞÅÏ¢×°ÈëÎÄ¼şĞÅÏ¢¼¯ºÏ
                #ifdef USE_LFN
                if(is_lfn)
                {
                 StringCopy(pfi->File_Name,temp_filename);
                 pfi->have_lfn=1;
                }
                else
                #endif
                {
                 StringCopy(pfi->File_Name,filename);
                }
                pfi->File_Attr=0X20;
                (pfi->File_CTime).hour=(pdt->time).hour;
                (pfi->File_CTime).min=(pdt->time).min;
                (pfi->File_CTime).sec=(pdt->time).sec;
                (pfi->File_CDate).year=(pdt->date).year;
                (pfi->File_CDate).month=(pdt->date).month;
                (pfi->File_CDate).day=(pdt->date).day;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 56  

                //(pfi->File_ADate).year=(pdt->date).year;
                //(pfi->File_ADate).month=(pdt->date).month;
                //(pfi->File_ADate).day=(pdt->date).day;
                //(pfi->File_MTime).hour=(pdt->time).hour;
                //(pfi->File_MTime).min=(pdt->time).min;
                //(pfi->File_MTime).sec=(pdt->time).sec;
                //(pfi->File_MDate).year=(pdt->date).year;
                //(pfi->File_MDate).month=(pdt->date).month;
                //(pfi->File_MDate).day=(pdt->date).day;
              
                pfi->File_StartClust=0;
                pfi->File_Size=0;
              
                pfi->File_CurClust=0;
                pfi->File_CurSec=0;
                pfi->File_CurPos=0;
              
                pfi->File_CurOffset=0;
                pfi->File_IsEOF=BOOL_TRUE;
              
                pfi->FDI_Sec=sec;
                pfi->nFDI=n;
              
                return ERR_SUCC;
               }
               else
               {
                if(res==ERR_FDI_ALREADY_EXISTING) //Èç¹ûÎÄ¼şÒÑ¾­´æÔÚ£¬ÔòÖ±½Ó½âÎöËü
                {
                 znFAT_Device_Read_Sector(sec,znFAT_Buffer); //Èç¹ûÖØÃûÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                 Analyse_FDI(pfi,(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+n); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
                 pfi->FDI_Sec=sec;
                 pfi->nFDI=n;
                 
                 #ifdef USE_LFN
                 if(is_lfn)
                 {
                  pfi->have_lfn=1;
                 }
                 else
                 {
                  pfi->have_lfn=0;
                 }
                 #endif 
                }
                return res;
               }
              }
              #endif
3390          
3391          /************************************************************************************
3392           ¹¦ÄÜ£ºÔÚÒ»¸öÄ¿Â¼ÖĞ´´½¨Ò»¸öÄ¿Â¼
3393           ĞÎ²Î£ºcluster:Ä¿Â¼´Ø pdn:Ö¸ÏòÄ¿Â¼Ãû pdt:Ö¸ÏòÊ±¼äĞÅÏ¢
3394           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3395           Ïê½â£ºÖ§³Ö³¤Ä¿Â¼Ãû´´½¨ cluster×îÖÕ»á·µ»ØĞÂ´´½¨µÄÄ¿Â¼µÄ¿ªÊ¼´Ø
3396                 ´Ëº¯ÊıÊÇznFATÊµÏÖ¶à¼¶Ä¿Â¼´´½¨µÄÖØÒªº¯Êı
3397          *************************************************************************************/
3398          #ifdef CREATE_DIR_IN_CLUSTER
              UINT8 Create_Dir_In_Cluster(UINT32 *cluster,INT8 *pdn,struct DateTime *pdt)
              {
               UINT8 res=0,i=0;
               UINT32 dummy=0;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 57  

               struct FDI fdi;
              
               #ifdef USE_LFN
               UINT8 is_lfn=0; //±ê¼ÇÊäÈëµÄÄ¿Â¼ÃûÊÇ·ñ³¤Ãû
               UINT16 temp_lfn_buf[MAX_LFN_LEN+1]; //ÓÃÓÚ×°ÔØ³¤ÃûUNI´®µÄÁÙÊ±»º³å
               INT8 temp_dirname[13];
               #endif
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               if(Check_Illegal_Char(pdn)) return ERR_ILL_CHAR; //¼ì²éÄ¿Â¼ÃûÖĞÊÇ·ñÓĞ·Ç·¨×Ö·û
               
               #ifdef USE_LFN
               if(!Is_LFN(pdn))
               {
               #endif
                //¼ì²é¶ÌÎÄ¼şÃûºÏ·¨ĞÔ£¬Èô·Ç·¨ÔòÖ±½Ó·µ»Ø£¬²»ÔÙ½øĞĞºóÃæµÄ´¦Àí(´Ë´¦¶ÔSFNµÄºÏ·¨ĞÔ¼ì²é·Ç³£ÑÏ¸ñ)
                //ÊÂÏÈ¼ì²éSFNµÄºÏ·¨ĞÔ£¬¼õÉÙºóÃæ´¦ÀíÉÏµÄÂé·³
                if(Check_SFN_Illegal_Length(pdn)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
                if(Check_SFN_Dot(pdn)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
                if(Check_SFN_Special_Char(pdn)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
                if(((UINT8)(-1))==Check_SFN_Illegal_Lower(pdn)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´óĞ¡Ğ´
               #ifdef USE_LFN
               }
               else
               {
                is_lfn=1;
                res=oemstr2unistr(pdn,temp_lfn_buf); //Èç¹ûÊÇ³¤Ãû£¬Ôò½«pdn×ªÎªUNI´®
                if(res) return res;
               }
              
               if(!is_lfn) //Èç¹û²»ÊÇ³¤Ãû
               {
               #endif
                Fill_FDI(&fdi,pdn,pdt,BOOL_FALSE); //¹¹ÔìÄ¿Â¼Ïî
                res=Register_FDI(*cluster,&fdi,&dummy,&i);//ÔÚµ±Ç°´ØÖĞ½øĞĞÎÄ¼şÄ¿Â¼ÏîµÄ"×¢²á"
              
               #ifdef USE_LFN
               }
               else //Èç¹ûÊÇ³¤Ãû
               {
                Make_Short_Name(pdn,temp_dirname);
                Fill_FDI(&fdi,temp_dirname,pdt,BOOL_FALSE); //¹¹ÔìÎÄ¼şÄ¿Â¼Ïî
                res=Register_LFN_FDI(*cluster,&fdi,temp_lfn_buf,&dummy,&i); //ÔÚµ±Ç°´ØÖĞ½øĞĞ³¤ÃûÏî¼°ÏàÓ¦¶ÌÃûÏî¡°×¢²á¡±
               }
               #endif
              
               if(res)
               {
                return res;
               }
              
               //====================================================================================
              
               //ÏòÄ¿Â¼´ØÖĞĞ´Èë.Óë..
               Modify_FAT(pInit_Args->Next_Free_Cluster,0X0FFFFFFF); //¹¹ÔìFAT´ØÁ´
               Clear_Cluster(pInit_Args->Next_Free_Cluster); //Çå¿Õ¿ÕÏĞ´Ø 
              
               //°ÑfdiÖĞµÄÃû×ÖÌæ»»Îª. ÃûÎª.µÄÄ¿Â¼Ö¸ÏòÁËÏàÇ°´Ø
               fdi.Name[0]='.';
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 58  

               for(i=1;i<11;i++)
               {
                fdi.Name[i]=' '; //.ºóÃæÈ«²¿Ìî³ä¿Õ¸ñ
               }
              
               Memory_Copy(znFAT_Buffer,((UINT8 *)(&fdi)),FDI_NBYTES); //½«ÎÄ¼şÄ¿Â¼Ïî.×°Èëµ½ÄÚ²¿»º³åÇøÖĞ
              
               //°ÑfdiÖĞµÄÃû×ÖÌæ»»Îª.. ÃûÎª..µÄÄ¿Â¼Ö¸ÏòÁËÉÏÒ»´Ø(DOSÖĞÊ¹ÓÃCD..¿ÉÒÔ»Øµ½ÉÏÒ»¼¶Ä¿Â¼¾ÍÊÇÕâ¸öµÀÀí)
               fdi.Name[1]='.';
               
               //°ÑfdiÖĞµÄ´ØÖµ¸ÄÎªÉÏÒ»¼¶Ä¿Â¼µÄÊ×´Ø 
               if(2!=(*cluster)) //Èç¹ûÉÏÒ»¼¶Ä¿Â¼Ê×´Ø²»ÊÇ"¸ùÄ¿Â¼"(Ê×Ä¿Â¼)
               {
                fdi.HighClust[0]=(UINT8)(((*cluster)>>16)&0X000000FF);
                fdi.HighClust[1]=(UINT8)(((*cluster)>>24)&0X000000FF);
                fdi.LowClust [0]=(UINT8)(((*cluster)    )&0X000000FF);
                fdi.LowClust [1]=(UINT8)(((*cluster)>>8 )&0X000000FF); 
               }
               else
               {
                fdi.HighClust[0]=fdi.HighClust[1]=fdi.LowClust[0]=fdi.LowClust[1]=0;
               }
              
               Memory_Copy(znFAT_Buffer+FDI_NBYTES,((UINT8 *)(&fdi)),FDI_NBYTES); //½«ÎÄ¼şÄ¿Â¼Ïî..×°Èëµ½ÄÚ²¿»º³åÇøÖĞ
              
               znFAT_Device_Write_Sector(SOC(pInit_Args->Next_Free_Cluster),znFAT_Buffer);
              
               *cluster=(pInit_Args->Next_Free_Cluster); //·µ»ØĞÂ´´½¨µÄÄ¿Â¼Ê×´Ø
              
               Update_Next_Free_Cluster();
              
               return ERR_SUCC;
              }
              #endif
3499          
3500          /************************************************************************************
3501           ¹¦ÄÜ£º´´½¨Ä¿Â¼
3502           ĞÎ²Î£ºpdp:Ö¸ÏòÄ¿Â¼Â·¾¶ pdt:Ö¸ÏòÊ±¼äĞÅÏ¢ 
3503           ·µ»Ø£ºÔËĞĞ½á¹û  ³É¹¦»ò´íÎóÂë
3504           Ïê½â£ºÖ§³ÖÎŞÏŞÉîÄ¿Â¼´´½¨ Èç Ä¿Â¼Â·¾¶¿ÉÒÔÊÇ /a/b/c/d/e/f/g/h/ ×¢Òâ×îÖÕÒ»¶¨ÒªÒÔ/»ò"\\"
3505                 ½áÊø¡£·ñÔòznFAT»áÈÏÎª×îºóÒ»¼¶Ä¿Â¼ÃûÊÇÎÄ¼şÃû£¬¶ø²»ÓèÒÔ´´½¨¡£Ö§³Ö³¤Ä¿Â¼Ãû
3506          *************************************************************************************/
3507          #ifdef ZNFAT_CREATE_DIR
              UINT8 znFAT_Create_Dir(INT8 *pdp,struct DateTime *pdt)
              {
               UINT32 Cur_Cluster=0,i=0;
               UINT8 index=0,res=0;
              
               #ifndef USE_LFN
               UINT8 dirname[13];
               #else
               UINT8 dirname[MAX_LFN_LEN+1];
               #endif
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               if(znFAT_Enter_Dir(pdp,&Cur_Cluster,&i)) //½øÈëÄ¿Â¼£¬Èç¹ûÖĞÍ¾·¢Éú´íÎó
               {                                        //±ÈÈçÄ³Ò»¼¶Ä¿Â¼Ãû²»ºÏ·¨£¬»ò
                while('\0'!=pdp[i])                     //Ä¿Â¼²»´æÔÚ£¬Ôò½«×î½üµÄÒ»²ã
                {                                       //Ä¿Â¼µÄÊ×´Ø¼ÇÂ¼ÔÚCur_ClusterÀï
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 59  

                 if('\\'==pdp[i] || '/'==pdp[i])                       //¶ø½«Ê§°ÜµÄÄÇÒ»¼¶Ä¿Â¼ÃûµÄµÚÒ»
                 {                                      //×Ö·ûµÄÎ»ÖÃ¼ÇÂ¼ÔÚiÖĞ
                  dirname[index]='\0';                  //±ÈÈç\a1\b2\c3\e4\f5\£¬Ä¿Â¼c3²»´æÔÚ
                  index=0;                              //ÔòCur_ClusterÎªÄ¿Â¼b2µÄÊ×´Ø£¬i¼ÇÂ¼µÄÊÇ'c'µÄÎ»ÖÃ¼´7
                 
                  res=Create_Dir_In_Cluster(&Cur_Cluster,(INT8 *)dirname,pdt); //ÔÚ´ØCur_ClusterÖĞ´´½¨Ä¿Â¼
                  if(res) 
                  { 
                       return res;  //·µ»Ø´íÎóÂë  
                  }
                 }
                 else
                 {
                  dirname[index]=pdp[i];
                  index++;
                  #ifndef USE_LFN
                  if(index>12) //Èç¹û²»Ê¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ı8+1+3
                  {
                       return ERR_SFN_ILL_LEN; //Ä¿Â¼Ãû³¤ÓÚ8.3£¬Òà·ÀÖ¹dirnameÒç³ö
                  }
                  #else
                  if(index>MAX_LFN_LEN) //Èç¹ûÊ¹ÓÃ³¤Ãû£¬ÔòÄ¿Â¼ÃûÒÔ¼°ÎÄ¼şÃû×î³¤²»ÄÜ³¬¹ıÉè¶¨µÄ³¤Ãû×î³¤³¤¶È
                  {
                       return ERR_LFN_BUF_OUT; //Ä¿Â¼Ãû³¤ÓÚMAX_LFN_LEN£¬Òà·ÀÖ¹dirnameÒç³ö
                  }   
                  #endif
                 }
                 i++;
                }
                
                return ERR_SUCC; //³É¹¦  
               }
               else
               {
                return ERR_DIR_ALREADY_EXISTING; //Òª´´½¨µÄÄ¿Â¼ÒÑ¾­´æÔÚÁË
               }
              }
              #endif
3565          
3566          //========================ÒÔÏÂ´úÂë³¢ÊÔÊµÏÖÄ¿Â¼É¾³ı¹¦ÄÜ=====================
3567          
3568          /************************************************************************************
3569           ¹¦ÄÜ£ºÏú»ÙÒ»¸öFAT´ØÁ´
3570           ĞÎ²Î£ºcluster:´ØÁ´µÄ¿ªÊ¼´ØºÅ
3571           ·µ»Ø£º0
3572           Ïê½â£ºÕñÄÏÔ­À´Ê¹ÓÃModify_FAT+Ñ­»·À´ÊµÏÖ´Ëº¯Êı£¬Ğ§ÂÊ¼«µÍ£¬ËÙ¶ÈºÜÂı£¬ÏÖÔÚ½øĞĞÁË¸Ä½ø£¬
3573                 Ğ§ÂÊ½Ï¸ß¡£
3574          *************************************************************************************/
3575          #ifdef DESTROY_FAT_CHAIN
              UINT8 Destroy_FAT_Chain(UINT32 cluster)
              {
               UINT32 clu_sec=0,temp1=0,temp2=0,old_clu=0,nclu=1;
              
               struct FAT_Sec *pFAT_Sec;
              
               if(cluster<(pInit_Args->Next_Free_Cluster)) //Èç¹ûÒªÏú»ÙµÄ´ØÁ´Í·´Ø±ÈÏÂÒ»¿Õ´ØÖµĞ¡£¬Ôò½«ÏÂÒ»¿Õ´ØÖµÖÃÎªËü
               {
                pInit_Args->Next_Free_Cluster=cluster;
               }
              
               old_clu=cluster;
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 60  

               znFAT_Device_Read_Sector((old_clu/NITEMSINFATSEC)+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
               pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer;
              
               cluster=Bytes2Value(((pFAT_Sec->items)[cluster%NITEMSINFATSEC]).Item,4);
              
               while(!IS_END_CLU(cluster))
               {
                nclu++;
              
                clu_sec=cluster/NITEMSINFATSEC;
              
                temp1=old_clu%NITEMSINFATSEC;
                temp2=old_clu/NITEMSINFATSEC;
              
                ((pFAT_Sec->items)[temp1]).Item[0]=0;
                ((pFAT_Sec->items)[temp1]).Item[1]=0;
                ((pFAT_Sec->items)[temp1]).Item[2]=0;
                ((pFAT_Sec->items)[temp1]).Item[3]=0;
              
                if(temp2!=clu_sec)
                {     
                 znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
                 znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                }
              
                old_clu=cluster;
                cluster=Bytes2Value(((pFAT_Sec->items)[cluster%NITEMSINFATSEC]).Item,4);
               }
              
               temp1=old_clu%NITEMSINFATSEC;
               temp2=old_clu/NITEMSINFATSEC;
              
               ((pFAT_Sec->items)[temp1]).Item[0]=0;
               ((pFAT_Sec->items)[temp1]).Item[1]=0;
               ((pFAT_Sec->items)[temp1]).Item[2]=0;
               ((pFAT_Sec->items)[temp1]).Item[3]=0;
              
               znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(temp2+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
               pInit_Args->Free_nCluster+=nclu; //¸üĞÂÊ£Óà¿Õ´ØÊı
              
               return ERR_SUCC;
              }
              #endif
3637          
3638          /************************************************************************************
3639           ¹¦ÄÜ£ºÏú»ÙÒ»¸öÎÄ¼şÄ¿Â¼ÏîËù¶ÔÓ¦µÄÕûÌõ´ØÁ´
3640           ĞÎ²Î£ºpitem:Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
3641           ·µ»Ø£º0
3642           Ïê½â£ºÖ÷ÒªÊÇÓÃÓÚÎÄ¼şºÍÄ¿Â¼µÄÉ¾³ı
3643          *************************************************************************************/
3644          #ifdef DESTROY_FDI
              UINT8 Destroy_FDI(struct FDI *pitem)
              {
               UINT32 start_cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
              
               if(0==start_cluster) return ERR_SUCC;
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 61  

               Destroy_FAT_Chain(start_cluster); //Ïú»Ù´ØÁ´
              
               return ERR_SUCC;
              } 
              #endif
3656          
3657          /************************************************************************************
3658           ¹¦ÄÜ£º¶ÔÄ³¸öÄ¿Â¼´Ø½øĞĞËÑË÷£¬¿´ÆäÖĞÊÇ·ñÓĞÄ¿Â¼Ïî£¬¼´¸ÃÄ¿Â¼ÏÂÓĞ×ÓÄ¿Â¼£¬ËÑË÷¹ı³ÌÖĞÓöµ½µÄ
3659                 ÎÄ¼şÏî½«È«²¿Ïú»Ù¡£
3660           ĞÎ²Î£ºcluster:Òª½øĞĞËÑË÷µÄÄ¿Â¼¿ªÊ¼´ØºÅ 
3661                 for_del_dir:ÔÚÓöµ½Ä¿Â¼ÏîÖ®ºó£¬ÊÇ·µ»ØÆä¿ªÊ¼´Ø£¬»¹ÊÇ½«ÆäÖ±½ÓÏú»Ù
3662           ·µ»Ø£ºÔËĞĞ½á¹û ÕÒµ½×ÓÄ¿Â¼»òÎ´ÕÒµ½ ×¢£ºÈç¹ûÔÚÄ¿Â¼ÖĞÎ´ÕÒµ½×ÓÄ¿Â¼£¬Ôò´ËÄ¿Â¼ÖĞµÄËùÓĞÎÄ¼ş
3663                 ½«±»È«²¿Ïú»Ù£¬ÔÚÕâÖÖÇé¿öÏÂ£¬Õâ¸öÄ¿Â¼Ëæ¼´Ò²»á±»Ïú»Ù£¬È»ºó½øĞĞÄ¿Â¼»ØËİ.....
3664           Ïê½â£ºÄ¿Â¼É¾³ıµÄÏà¹ØËã·¨¾ù½ÏÎª¸´ÔÓ£¬µ«Èç¹ûÁìÎò£¬Ôò»á¾õµÃ±È½Ï¼òµ¥¡£Ä¿Â¼ÒòÎªÓĞ×ÓÄ¿Â¼
3665                 ¶øÇÒÊÇÒ»ÖÖÊ÷ĞÎµÄ½á¹¹£¬Òò´ËÉ¾³ıÄ¿Â¼µÄ¹ı³ÌÆäÊµÊÇÒ»¸ö¡°µİ¹é»ØËİ¡±µÄ¹ı³Ì£¬Ö±µ½»Øµ½
3666                 ¶¥²ãÄ¿Â¼¡£
3667          *************************************************************************************/
3668          #ifdef HAVE_ANY_SUBDIR_WITH_DEL_FOREFILE
              UINT8 Have_Any_SubDir_With_Del_ForeFile(UINT32 *cluster,UINT8 for_del_dir)
              {
               UINT8 iSec=0,iFDI=0;
               UINT32 sec_temp=0;
               UINT32 temp=*cluster;
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=0;
               #endif
              
               do
               {
                sec_temp=SOC(temp); //µ±Ç°´ØÊ×ÉÈÇø
                for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++) 
                {
                 znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
                 pitems=(struct FDIesInSEC *)znFAT_Buffer; 
              
                 for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
                 {
                  pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
              
                      if((CHK_ATTR_FILE(pitem->Attributes)) && (0XE5!=pitem->Name[0])) //ÎÄ¼şÊôĞÔÎªÎÄ¼ş£¬ÇÒÃ»ÓĞ±»É¾³ı
                  {
                   Destroy_FDI(pitem); //Ïú»ÙÎÄ¼şÄ¿Â¼Ïî¼°Æä¶ÔÓ¦µÄ´ØÁ´ ×¢£ºÄÚ²¿»º³åÇøÊı¾İ±»±ä¸ü
                       znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //ÖØĞÂ¶ÁÈ¡ÉÈÇøÊı¾İ£¬»Ö¸´ÄÚ²¿»º³åÇøµÄÊı¾İ
              
                       pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                   pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
              
                   znFAT_Device_Write_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //Èç¹ûÓĞÏú»Ù²Ù×÷£¬Ôò»ØĞ´ÉÈÇø
                      }
              
                  if((CHK_ATTR_DIR(pitem->Attributes)) && (0XE5!=pitem->Name[0]) //ÎÄ¼şÊôĞÔÎªÄ¿Â¼£¬ÇÒÃ»ÓĞ±»É¾³ı
                         && ('.'!=pitem->Name[0]))                          //²»ÊÇ.Óë..
                  { 
                       if(!for_del_dir) //²»ÊÇÎªÁË°Ñ×ÓÄ¿Â¼±¾ÉíÉ¾³ı£¬¶øÊÇÎªÁË»ñÈ¡ÆäÊ×´Ø£¬½ø¶ø½øÈë¸üÉî×ÓÄ¿Â¼
                       {
                        *cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
                       }
                   else
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 62  

                       {
                    Destroy_FDI(pitem); //Ïú»ÙÎÄ¼şÄ¿Â¼Ïî¼°Æä¶ÔÓ¦µÄ´ØÁ´ ×¢£ºÄÚ²¿»º³åÇøÊı¾İ±»±ä¸ü
                        znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //ÖØĞÂ¶ÁÈ¡ÉÈÇøÊı¾İ£¬»Ö¸´ÄÚ²¿»º³åÇøµÄÊı¾İ
              
                        pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                    pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
              
                    znFAT_Device_Write_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer); //Èç¹ûÓĞÏú»Ù²Ù×÷£¬Ôò»ØĞ´ÉÈÇø       
                       }
                   return BOOL_TRUE;
                  }
                 }
                }
              
                temp=Get_Next_Cluster(temp); //»ñÈ¡ÏÂÒ»´Ø
               }while(!IS_END_CLU(temp)); //Èç¹û²»ÊÇ×îºóÒ»¸ö´Ø£¬Ôò¼ÌĞøÑ­»·
                
               return BOOL_FALSE;
              }
              #endif
3733          
3734          /************************************************************************************
3735           ¹¦ÄÜ£º½øÈë´ÓÄ³¸öÄ¿Â¼¿ªÊ¼µÄ×îÉî×î¡°×ó¡±µÄÄ¿Â¼
3736           ĞÎ²Î£ºcluster:Ö¸ÏòÄ¿Â¼´ØµÄÖ¸Õë
3737           ·µ»Ø£º0
3738           Ïê½â£º´Ëº¯ÊıÊÇÄ¿Â¼É¾³ı¹¦ÄÜµÄÒ»¸ö»ù±¾¶ø¹Ø¼üµÄ²Ù×÷¡£ËüÓÃÀ´½øÈëµ½¡°×îÉî×î×ó¡±µÄÄ¿Â¼£¬
3739                 Í¬Ê±ÔÚ´Ë¹ı³ÌÖĞ£¬É¾³ı¡°×î×ó¡±Ä¿Â¼¡°×ó±ß¡±µÄËùÓĞÎÄ¼ş¡££¨´Ëº¯ÊıµÄË¼Ïë½ÏÎª³éÏó£©
3740          *************************************************************************************/
3741          #ifdef ENTER_DEEP_AHEAD_DIR
              UINT8 Enter_Deep_Ahead_Dir(UINT32 *cluster)
              {
               UINT32 dir_cluster=*cluster; 
              
               while(Have_Any_SubDir_With_Del_ForeFile(&dir_cluster,BOOL_FALSE));
              
               *cluster=dir_cluster;
              
               return ERR_SUCC;
              }
              #endif
3753          
3754          /************************************************************************************
3755           ¹¦ÄÜ£º»ñÈ¡Ò»¸öÄ¿Â¼µÄÉÏÒ»¼¶Ä¿Â¼¿ªÊ¼´Ø
3756           ĞÎ²Î£ºcluster:Ä¿Â¼µÄ¿ªÊ¼´Ø£¬Í¬Ê±ÓÖÓÃÓÚ½ÓÊÕ¼ÆËãµÃµ½µÄÉÏÒ»¼¶Ä¿Â¼µÄ¿ªÊ¼´Ø
3757           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë 
3758           Ïê½â£ºÔÚÄ¿Â¼µÄ×îÍ·ÉÏ£¬ÓĞ.Óë..£¬ÔÚ..ÖĞ¼ÇÂ¼ÁËÉÏÒ»²ãÄ¿Â¼µÄ¿ªÊ¼´Ø£¬´Ëº¯Êı¾ÍÊÇ»ùÓÚÕâÒ»µã
3759                 À´»ñÈ¡Ä¿Â¼ÉÏÒ»¼¶Ä¿Â¼¿ªÊ¼´ØµÄ¡£
3760          *************************************************************************************/
3761          #ifdef GET_UPPER_DIR
              UINT8 Get_Upper_Dir(UINT32 *cluster)
              {
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               znFAT_Device_Read_Sector(SOC(*cluster),znFAT_Buffer);
               pitems=(struct FDIesInSEC *)znFAT_Buffer; 
                 
               pitem=&(pitems->FDIes[1]); //Ö¸Ïò..ÎÄ¼şÄ¿Â¼Ïî£¬ÓÃÒÔ»ñÈ¡ÉÏÒ»¼¶Ä¿Â¼µÄÊ×´Ø
              
               if('.'==pitem->Name[0] && '.'==pitem->Name[1])
                *cluster=Bytes2Value(pitem->LowClust,2)+Bytes2Value(pitem->HighClust,2)*65536;
               else
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 63  

                return ERR_FS_DIR; //Èç¹ûÔÚÄ¿Â¼µÄ×îÍ·ÉÏ²»ÊÇ.Óë..£¬ÔòËµÃ÷ÎÄ¼şÏµÍ³ÒÑ±»Ëğ»µ
               
               if(0==(*cluster)) (*cluster)=2; //Èç¹ûÉÏÒ»¼¶Ä¿Â¼Îª¸ùÄ¿Â¼(Ê×Ä¿Â¼)£¬½«´ØÖµÖÃÎª2
              
               return ERR_SUCC;
              }
              #endif
3782          
3783          /************************************************************************************
3784           ¹¦ÄÜ£ºÉ¾³ıÄ¿Â¼
3785           ĞÎ²Î£ºdirpath:Ö¸ÕëÏòÄ¿Â¼Â·¾¶ Ä¿Â¼ÃûÖ§³ÖÍ¨Åä
3786           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3787           Ïê½â£ºdirpathÈç\a\b\c£¬É¾³ıÄ¿Â¼c£¬×îºó²»ÒªÒÔ\½áÊø¡£É¾³ıÄ¿Â¼½«»áÉ¾³ıÄ¿Â¼ÏÂµÄËùÓĞ×ÓÄ¿Â¼
3788                 ÓëÎÄ¼ş£¬×ÓÄ¿Â¼ÏÂ¿ÉÒÔÔÙÓĞ×ÓÄ¿Â¼ÓëÎÄ¼ş£¬ÒÀ´Îµİ¹é¡£dirpathÒ²¿ÉÒÔÎª/a/b/c* £¬Ëü½«
3789                 É¾³ıbÄ¿Â¼ÏÂËùÓĞÒÔc´òÍ·µÄÄ¿Â¼¡£
3790          *************************************************************************************/
3791          #ifdef ZNFAT_DELETE_DIR
              UINT8 znFAT_Delete_Dir(INT8 *dirpath) 
              {
               UINT32 top_dir_first_cluster=0,sub_dir_first_cluster=0;
               UINT8 res=0;
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
              
               struct FileInfo fi;
              
               res=znFAT_Open_File(&fi,dirpath,0,BOOL_FALSE); //³¢ÊÔ´ò¿ªÄ¿Â¼
              
               if(res) return res; //Èç¹û´ò¿ªÄ¿Â¼Ê§°Ü£¬ÔòÖ±½Ó·µ»Ø´íÎóÂë
              
               while(!res) //Ä¿Â¼´ò¿ª³É¹¦
               {
                top_dir_first_cluster=fi.File_StartClust; //¶¥²ãÄ¿Â¼µÄÊ×´Ø
                sub_dir_first_cluster=top_dir_first_cluster;
              
                //ÒÔÏÂ´úÂë½«¶¥¼¶Ä¿Â¼ÏÂËùÓĞÄÚÈİ(ÎÄ¼ş¡¢×ÓÄ¿Â¼¼°×ÓÄ¿Â¼ÖĞµÄÄÚÈİ£¬º¬µİ¹é)Ïú»Ù
              
                Enter_Deep_Ahead_Dir(&sub_dir_first_cluster); //»ñÈ¡×îÉî×î¿¿Ç°µÄÄ¿Â¼Ê×´Ø
              
                while(sub_dir_first_cluster!=top_dir_first_cluster) //Èç¹û×îÉî×î¿¿Ç°Ä¿Â¼Ê×´Ø¾ÍÊÇÒªÉ¾³ıµÄ¶¥¼¶Ä¿Â¼
                {                                                   //ÔòËµÃ÷¶¥¼¶Ä¿Â¼ÏÂµÄËùÓĞÄÚÈİ¶¼ÒÑ¾­Çå¿Õ
                 Get_Upper_Dir(&sub_dir_first_cluster); //»ñÈ¡ÉÏÒ»²ãÄ¿Â¼Ê×´Ø 
                 
                 Have_Any_SubDir_With_Del_ForeFile(&sub_dir_first_cluster,BOOL_TRUE); //°ÑÒÑÇå¿ÕÆäÄÚÈİµÄ×ÓÄ¿Â¼Ïú»Ù 
              
                 Enter_Deep_Ahead_Dir(&sub_dir_first_cluster); //»ñÈ¡×îÉî×î¿¿Ç°µÄÄ¿Â¼Ê×´Ø
                }  
              
                //Ïú»Ù¶¥¼¶Ä¿Â¼¶ÔÓ¦µÄÎÄ¼şÄ¿Â¼Ïî¼°Æä´ØÁ´
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                pitems=(struct FDIesInSEC *)znFAT_Buffer;
              
                Destroy_FDI((pitems->FDIes)+fi.nFDI); //Ïú»Ù¶¥¼¶Ä¿Â¼
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
                (pitems->FDIes)[fi.nFDI].Name[0]=0XE5;
                (pitems->FDIes)[fi.nFDI].HighClust[0]=(pitems->FDIes)[fi.nFDI].HighClust[1]=0;
              
                znFAT_Device_Write_Sector(fi.FDI_Sec,znFAT_Buffer); //»ØĞ´ÉÈÇø
              
                res=znFAT_Open_File(&fi,dirpath,0,BOOL_FALSE); //³¢ÊÔ´ò¿ªÄ¿Â¼
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 64  

               }
               
               znFAT_Close_File(&fi);
              
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               return ERR_SUCC; 
              }
              #endif
3848          
3849          //========================ÒÔÉÏ´úÂëÓÃÓÚÊµÏÖÄ¿Â¼É¾³ı¹¦ÄÜ====================
3850          
3851          /************************************************************************************
3852           ¹¦ÄÜ£ºÎÄ¼şÉ¾³ı
3853           ĞÎ²Î£ºfilepath:ÎÄ¼şÂ·¾¶ 
3854           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
3855           Ïê½â£ºÉ¾³ıÎÄ¼ş±ÈÉ¾³ıÄ¿Â¼Òª¼òµ¥µÄ¶à¡£filepathÈç\a\b\test.txt£¬É¾³ıÎÄ¼ştest.txt
3856                 ÔËĞĞÍ¨Åä£¬filepath¿ÉÒÔÎª/a/b/c/d/t*.txt É¾³ıdÄ¿Â¼ÏÂËùÓĞµÄt´òÍ·µÄtxtÎÄ¼ş
3857          *************************************************************************************/
3858          #ifdef ZNFAT_DELETE_FILE
              UINT8 znFAT_Delete_File(INT8 *filepath) 
              {
               UINT8 res=0;
               struct FileInfo fi; 
              
               struct FDIesInSEC *pitems; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÉÈÇøÊı¾İµÄÖ¸Õë
               struct FDI *pitem; //Ö¸ÏòÎÄ¼şÄ¿Â¼ÏîÊı¾İµÄÖ¸Õë
              
               res=znFAT_Open_File(&fi,filepath,0,BOOL_TRUE);
               if(res) return res;
              
               while(!res) //´ò¿ªÎÄ¼ş³É¹¦
               {
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şµÄÎÄ¼şÄ¿Â¼ÏîËùÔÚÉÈÇø
                pitems=(struct FDIesInSEC *)znFAT_Buffer;
                pitem=(pitems->FDIes)+fi.nFDI;
              
                if(0!=fi.File_StartClust) Destroy_FAT_Chain(fi.File_StartClust); //Ïú»ÙÕûÌõ´ØÁ´
              
                znFAT_Device_Read_Sector(fi.FDI_Sec,znFAT_Buffer); //¶ÁÈ¡ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
              
                pitem->Name[0]=0XE5; //¸øÎÄ¼şÄ¿Â¼Ïî´òÉÏ"ÒÑÉ¾³ı"µÄ±ê¼Ç
                pitem->HighClust[0]=pitem->HighClust[1]=0; //¿ªÊ¼´ØµÄ¸ß×ÖÇå0
              
                znFAT_Device_Write_Sector(fi.FDI_Sec,znFAT_Buffer); //»ØĞ´ÉÈÇø
              
                res=znFAT_Open_File(&fi,filepath,0,BOOL_TRUE);
               }
              
               znFAT_Close_File(&fi);
              
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               return ERR_SUCC; 
              }
              #endif
3897          
3898          //==========================ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖ¸ñÊ½»¯¹¦ÄÜ============================
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 65  

3899          
3900          /************************************************************************************
3901           ¹¦ÄÜ£º»ñÈ¡ÔÚÄ³ÖÖ´ÅÅÌÈİÁ¿ÏÂ´Ø´óĞ¡µÄÍÆ¼öÖµ
3902           ĞÎ²Î£ºnsec:×ÜÉÈÇøÊı
3903           ·µ»Ø£º0
3904           Ïê½â£ºÈç¹û·µ»Ø0£¬ÔòËµÃ÷´ÅÅÌÈİÁ¿¶ÔÓÚFAT32ÎÄ¼şÏµÍ³À´ËµÌ«Ğ¡ÁË£¬ÎŞ·¨ÓÃFAT32À´¸ñÊ½»¯¡£
3905          *************************************************************************************/
3906          #ifdef GET_RECMD_SZCLU
              UINT8 Get_Recmd_szClu(UINT32 nsec)
              {
               if(nsec<(14336)) return 0;
              
               if((nsec>=(14336)) && (nsec<=(32767))) return 0;
               if((nsec>=(32768)) && (nsec<=(65535))) return 1;
               if((nsec>=(65536)) && (nsec<=(131071))) return 1;
               if((nsec>=(131072)) && (nsec<=(262143))) return 2;
               if((nsec>=(262144)) && (nsec<=(524287))) return 4;
               if((nsec>=(524288)) && (nsec<=(16777215))) return 8;
               if((nsec>=(16777216)) && (nsec<=(33554431))) return 16;
               if((nsec>=(33554432)) && (nsec<=(67108863))) return 32;
               if((nsec>=(67108864)) && (nsec<=(4294967295UL))) return 64;
              
               return 0;
              }
              #endif
3924          
3925          /************************************************************************************
3926           ¹¦ÄÜ£ºÔÚ´ÅÅÌÉÏ´´½¨Ò»¸öFAT32µÄÎÄ¼şÏµÍ³£¬¼´¸ñÊ½»¯
3927           ĞÎ²Î£ºtt_sec:×ÜÉÈÇøÊı clu_sz:Ê¹ÓÃÕßÖ¸¶¨µÄ´Ø´óĞ¡£¬Èç¹ûÎª0£¬ÔòÈ¡ÍÆ¼öÖµ
3928           ·µ»Ø£º0
3929           Ïê½â£ºFAT32µÄ¸ñÊ½»¯·ÖÎªÁ½ÖÖ²ßÂÔ£ºFDISKÓëSFD¡£FDISKÊÇÖ§³Ö¶à·ÖÇøµÄ£¬Òò´ËĞèÒª¹¹ÔìMBR
3930                 ¹¹ÔìMBR»áÉæ¼°µ½Ò»Ğ©±È½Ïµ×²ãµÄÄÚÈİ£¬½ÏÓĞÄÑ¶È£¬Òò´ËÎªÁË¼òµ¥¶ø¸ßĞ§£¬znFATÖĞÊ¹ÓÃÁË
3931                 SFD²ßÂÔ£¬Ëü½«Õû¸ö´ÅÅÌ¾Íµ±×÷Ò»¸öÄ¬ÈÏµÄ´ó·ÖÇø£¬Òò´ËËüÃ»ÓĞMBR¡£¸ñÊ½»¯ºó´ÅÅÌµÄ¾í
3932                 ±êÎªZN'ZNFATOK!
3933          *************************************************************************************/
3934          #ifdef ZNFAT_MAKE_FS
              UINT8 znFAT_Make_FS(UINT32 tt_sec,UINT16 clu_sz) //¸ñÊ½»¯ tt_sec ×ÜÉÈÇøÊı clu_sz Ö¸¶¨µÄ´Ø´óĞ¡
              {                                          //ÈôÎª0Ôò°´´ÅÅÌ´óĞ¡Ñ¡¶¨Ä¬ÈÏÖµ ¸ñÊ½»¯²ßÂÔ²ÉÓÃ±È½Ï¼òµ¥µÄSFD²ßÂÔ
                                                             //ÎŞMBR£¬²»Ö§³Ö·ÖÇø£¬Ö±½Ó´ÓDBR¿ªÊ¼
               struct DBR      *pdbr;
               struct FSInfo   *pfsinfo;
              
               UINT32 temp=0,temp1=0,temp2=0;
              
               tt_sec/=(UINT32)(NSECPERCYLINDER); 
               tt_sec*=(UINT32)(NSECPERCYLINDER);//ÉáÈ¥¡°Ê£ÓàÉÈÇø¡±£¬Ê£ÓàÉÈÇøÊÇÖ¸²»×ãÒ»¸öÖùÃæµÄÉÈÇøÊı
              
               //=================ºÏ³ÉDBRÉÈÇøÊı¾İ=============================================================
               PGM2RAM(znFAT_Buffer,_dbr,512); //´ÓÄ£°æÊı×éÖĞ°ÑÊı¾İ°áµ½ÄÚ²¿»º³åÇø
               pdbr=(struct DBR *)znFAT_Buffer;
              
               pdbr->BPB_SecPerClus=(UINT8)(clu_sz/512); //Ã¿´ØÉÈÇøÊı
               if(0==pdbr->BPB_SecPerClus) pdbr->BPB_SecPerClus=Get_Recmd_szClu(tt_sec);
               if(0==pdbr->BPB_SecPerClus) return ERR_FMT_TOO_LOW_VOLUME; //ÈİÁ¿Ì«Ğ¡£¬²»ÄÜÓÃFAT32½øĞĞ¸ñÊ½»¯
              
               temp1=pdbr->BPB_SecPerClus;
              
               pdbr->BPB_TotSec32[0]=(UINT8)((tt_sec)    &0X000000FF);
               pdbr->BPB_TotSec32[1]=(UINT8)((tt_sec>>8) &0X000000FF);
               pdbr->BPB_TotSec32[2]=(UINT8)((tt_sec>>16)&0X000000FF);
               pdbr->BPB_TotSec32[3]=(UINT8)((tt_sec>>24)&0X000000FF); //¸Ã·ÖÇøµÄ×ÜÉÈÇøÊı
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 66  

               temp=(tt_sec-32)/(((UINT32)NITEMSINFATSEC)*((UINT32)(pdbr->BPB_SecPerClus)));
               if((tt_sec-32)%((UINT32)NITEMSINFATSEC)*((UINT32)pdbr->BPB_SecPerClus)) temp++; //((tt_sec-32)-2*FATsz)/(
             -SecPerClus*128)=FATsz ½âÕâ¸öµÈÊ½
               temp2=temp;
               
               pdbr->BPB_FATSz32[0]=(UINT8)((temp)    &0X000000FF);
               pdbr->BPB_FATSz32[1]=(UINT8)((temp>>8) &0X000000FF);
               pdbr->BPB_FATSz32[2]=(UINT8)((temp>>16)&0X000000FF);
               pdbr->BPB_FATSz32[3]=(UINT8)((temp>>24)&0X000000FF); //FAT±íµÄÉÈÇøÊı
              
               znFAT_Device_Write_Sector(0,znFAT_Buffer); //½«ºÏ³ÉºÃµÄDBRÊı¾İĞ´Èëµ½0ÉÈÇøÖĞÈ¥
              
               //===============================ÒÔÉÏ´úÂëÍê³É¶ÔDBRÉÈÇøÊı¾İµÄºÏ³É===============================
              
               //===================================ÒÔÏÂ´úÂëÍê³É¶ÔFSINFOÉÈÇøÊı¾İµÄºÏ³É========================
              
               Memory_Set(znFAT_Buffer,ZNFAT_BUF_SIZE,0); //½«ÄÚ²¿»º³åÇøÇå0
               PGM2RAM(znFAT_Buffer,_fsinfo_1,4); //½«FSINFOÄ£°åÊı¾İµÄµÚÒ»²¿·Ö°á¹ıÀ´
               PGM2RAM(znFAT_Buffer+484,_fsinfo_2,28); //½«FSINFOÄ£°åÊı¾İµÄµÚ¶ş²¿·Ö°á¹ıÀ´
                                                           //×¢£ºFSINFOÄ£°åÊı¾İ·ÖÎªÁ½²¿·Ö£¬Ö÷ÒªÊÇÒòÎªÆäÖĞÓĞ¾ø´ó
                                                           //²¿·ÖÊÇ0£¬ÎªÁË½ÚÊ¡¹Ì»¯Êı¾İÁ¿£¬¼õÉÙFLASHROM¿Õ¼äµÄÊ¹ÓÃÁ¿
               pfsinfo=(struct FSInfo *)znFAT_Buffer;
               
               temp=(tt_sec-32-2*temp)/((UINT32)(temp1))-1; //×Ü´ØÊı-1£¬ÒòÎªµÚ2´ØÎªÊ×Ä¿Â¼£¬ÒÑ¾­±»¾í±êÕ¼ÓÃ
               pfsinfo->Free_Cluster[0]=(UINT8)((temp)    &0X000000FF);
               pfsinfo->Free_Cluster[1]=(UINT8)((temp>>8) &0X000000FF);
               pfsinfo->Free_Cluster[2]=(UINT8)((temp>>16)&0X000000FF);
               pfsinfo->Free_Cluster[3]=(UINT8)((temp>>24)&0X000000FF); //Ê£Óà¿Õ´ØÊı
              
               znFAT_Device_Write_Sector(1,znFAT_Buffer); //½«ºÏ³ÉºÃµÄDBRÊı¾İĞ´Èëµ½64ÉÈÇøÖĞÈ¥£¬¼´DBRÉÈÇøµÄºóÒ»¸öÉÈÇø
              
               //=====================================ÒÔÉÏ´úÂëÍê³É¶ÔFSINFOÉÈÇøÊı¾İµÄºÏ³É=====================
              
               //=====================================ÒÔÏÂ´úÂëÍê³É¶ÔFAT±íµÄ³õÊ¼»¯============================
              
               znFAT_Device_Clear_nSector(temp1,32+2*temp2);
               znFAT_Device_Clear_nSector(temp2-1,33);
               znFAT_Device_Clear_nSector(temp2-1,33+temp2);
              
               PGM2RAM(znFAT_Buffer,_fatsec,12); //½«FAT±íÄ£°æÊı¾İ°áµ½ÄÚ²¿»º³åÇø
               znFAT_Device_Write_Sector(32,znFAT_Buffer); //ÏòFAT±í1ÖĞĞ´Èë0
               znFAT_Device_Write_Sector(32+temp2,znFAT_Buffer); //ÏòFAT±í2ÖĞĞ´Èë0
              
               //=====================================ÒÔÉÏ´úÂëÍê³É¶ÔFAT±íµÄ³õÊ¼»¯============================
              
               //=====================================ÒÔÏÂ´úÂë¶ÔÊı¾İÇøÊ×ÉÈÇø½øĞĞ³õÊ¼»¯£¬Ğ´Èë¾í±ê=============
              
               PGM2RAM(znFAT_Buffer,_1stsec,26); 
               znFAT_Device_Write_Sector(32+2*temp2,znFAT_Buffer); //ÏòÊı¾İÇøµÚÒ»¸öÉÈÇøĞ´ÈëÊı¾İ
              
               //=====================================ÒÔÉÏ.....==============================================
               return ERR_SUCC;
              }  
              #endif
4014          
4015          //===================ÒÔÏÂ´úÂëÓÃÓÚÊµÏÖÎÄ¼şÊı¾İĞ´Èë=====================
4016          
4017          /************************************************************************************
4018           ¹¦ÄÜ£º¸üĞÂÎÄ¼şµÄ´óĞ¡£¬½«µ±Ç°ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞµÄFile_SizeÖµĞ´Èëµ½ÎÄ¼şÄ¿Â¼ÏîÖĞÈ¥
4019           ĞÎ²Î£ºpfi:Ö¸ÕëÎÄ¼şÄ¿Â¼ÏîµÄÖ¸Õë
4020           ·µ»Ø£º0
4021           Ïê½â£ºÔÚÏòÎÄ¼şĞ´ÈëÊı¾İ£¬»òÉ¾³ıÊı¾İÖ®ºó£¬Èç¹û²»µ÷ÓÃ´Ëº¯Êı½«ÎÄ¼ş´óĞ¡¸üĞÂµ½Ä¿Â¼ÏîÖĞÈ¥
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 67  

4022                 ÔòÎÒÃÇÔÚµçÄÔÉÏÊÇ¿´²»µ½Ğ´ÈëµÄÊı¾İµÄ¡£´Ëº¯ÊıÔÚznFATÖĞÊÜµ½RT_UPDATE_FILESIZEÕâ¸ö
4023                 ºêµÄ¿ØÖÆ£¬ÒÔ¾ö¶¨ÊÇ·ñÊµÊ±¸üĞÂÎÄ¼ş´óĞ¡¡£
4024          *************************************************************************************/
4025          #ifdef UPDATE_FILE_SIZE
4026          UINT8 Update_File_Size(struct FileInfo *pfi) //¸üĞÂÎÄ¼ş´óĞ¡
4027          {
4028   1       struct FDI *pfdi;
4029   1      
4030   1       just_file=pfi;
4031   1      
4032   1       znFAT_Device_Read_Sector(pfi->FDI_Sec,znFAT_Buffer);
4033   1      
4034   1       pfdi=(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+(pfi->nFDI); //ÎÄ¼şµÄÎÄ¼şÄ¿Â¼Ïî
4035   1      
4036   1       (pfdi->FileSize)[0]=(UINT8)((pfi->File_Size)&0X000000FF)      ;
4037   1       (pfdi->FileSize)[1]=(UINT8)(((pfi->File_Size)&0X0000FF00)>>8) ;
4038   1       (pfdi->FileSize)[2]=(UINT8)(((pfi->File_Size)&0X00FF0000)>>16);
4039   1       (pfdi->FileSize)[3]=(UINT8)(((pfi->File_Size)&0XFF000000)>>24);
4040   1      
4041   1       znFAT_Device_Write_Sector(pfi->FDI_Sec,znFAT_Buffer);
4042   1      
4043   1       return 0;
4044   1      }
4045          #endif
4046          
4047          /************************************************************************************
4048           ¹¦ÄÜ£º¸üĞÂÎÄ¼şµÄ¿ªÊ¼´Ø
4049           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë clu:ÎÄ¼ş¿ªÊ¼´ØºÅ
4050           ·µ»Ø£º0
4051           Ïê½â£º¶ÔÓÚÒ»¸ö¸Õ¸Õ´´½¨µÄÎÄ¼ş£¨¿ÕÎÄ¼ş£©£¬ËüµÄ¿ªÊ¼´ØÎª0£¬Òò´ËÏòÆäĞ´ÈëÊı¾İÊ±£¬²»¹âÒª¸ü
4052                 ĞÂ´ØÁ´£¬»¹Òª¸üĞÂÎÄ¼şµÄ¿ªÊ¼´Ø£¬ËüÊÇÎÄ¼şÕûÌõ´ØÁ´µÄ¿ªÊ¼¡£
4053          *************************************************************************************/
4054          #ifdef UPDATE_FILE_SCLUST
              UINT8 Update_File_sClust(struct FileInfo *pfi,UINT32 clu) //¸üĞÂÎÄ¼ş¿ªÊ¼´Ø
              {
               struct FDI *pfdi;
              
               just_file=pfi;
              
               znFAT_Device_Read_Sector(pfi->FDI_Sec,znFAT_Buffer);
              
               pfdi=(((struct FDIesInSEC *)znFAT_Buffer)->FDIes)+(pfi->nFDI); //ÎÄ¼şµÄÎÄ¼şÄ¿Â¼Ïî
              
               pfi->File_StartClust=clu;
              
               (pfdi->HighClust)[0]=(UINT8)((clu&0X00FF0000)>>16);
               (pfdi->HighClust)[1]=(UINT8)((clu&0XFF000000)>>24);
               (pfdi->LowClust )[0]=(UINT8)((clu&0X000000FF))    ;
               (pfdi->LowClust )[1]=(UINT8)((clu&0X0000FF00)>>8) ;
              
               znFAT_Device_Write_Sector(pfi->FDI_Sec,znFAT_Buffer);
              
               return 0; 
              }
              #endif
4077          
4078          /************************************************************************************
4079           ¹¦ÄÜ£º´´½¨Ò»Ìõ´ØÁ´
4080           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë cluster:´ØÁ´µÄ¿ªÊ¼´Ø datalen:Êı¾İ³¤¶È(×Ö½Ú)
4081           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»ò´íÎóÂë
4082           Ïê½â£º´Ëº¯ÊıµÄ¹¦ÄÜÊÇÎªÁËÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ¶øÔ¤ÏÈ½¨Á¢´ØÁ´£¬´Ó¶ø¿ÉÒÔÌá¹©Êı¾İĞ´ÈëµÄĞ§ÂÊ
4083                 £¨Ê¹Êı¾İĞ´ÈëµÄ¹ı³ÌÖĞ£¬²»ÔÙÇ£³¶´ØÁ´¹¹ÔìµÄ²Ù×÷£©¼ÓÖ®¶Ô´ØÁ´µÄÁ¬Ğø¶ÎµÄ·ÖÎö£¬¿ÉÒÔºÜ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 68  

4084                 ´ó³ÌĞòÉÏÌá¸ß¶àÉÈÇøÁ¬Ğø¶ÁĞ´Çı¶¯µÄÊ¹ÓÃÂÊ¡£ÕâÒ»º¯ÊıÊÇznFAT¡°´óÄ£Ê½¡±µÄ»ù´¡£¨´óÄ£
4085                 Ê½¾ÍÊÇÏÈÎªÎÄ¼şÔ¤ÏÈ½¨Á¢ºÃ´ØÁ´£¬È»ºó¾ÍÊÇµ¥´¿µÄÊı¾İĞ´ÈëÁË£¬ÕâÑù¼«´óµÄÌáÉıÁËÊı¾İĞ´
4086                 ÈëµÄËÙ¶ÈºÍĞ§ÂÊ£¬ÊÇÊı¾İ¸ßËÙ´æ´¢µÄ½â¾ö·½°¸£©¡£
4087          *************************************************************************************/
4088          #ifdef CREATE_CLUSTER_CHAIN
              UINT8 Create_Cluster_Chain(struct FileInfo *pfi,UINT32 cluster,UINT32 datalen)
              {
               UINT32 iSec=0,clu_sec=0,old_clu=cluster,ncluster=0,temp_ncluster=0;
               UINT8 iItem=0,temp=0;
               struct FAT_Sec *pFAT_Sec=(struct FAT_Sec *)znFAT_Buffer; //½«Êı¾İ»º³åÇøÊ×µØÖ·Ç¿×ªÎªFAT_Sec½á¹¹ÌåµÄÖ¸ÕëÀàĞ
             -Í
              
               UINT32 Clu_Size=(pInit_Args->SectorsPerClust*pInit_Args->BytesPerSector); //´Ø´óĞ¡£¬ÒÔÃâºóÃæÖØ¸´¼ÆËã
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               ncluster=datalen/Clu_Size;
               if(0!=datalen%Clu_Size) ncluster++; //Èç¹ûÓĞÊı¾İÓàÁ¿£¨ÕûÉÈÇø£©£¬´ØÊı¼Ó1
              
               temp_ncluster=ncluster; //¼ÇÂ¼ÏÂ´ØÁ´µÄ´ØÊı
              
               if((pInit_Args->Free_nCluster)<ncluster) return ERR_NO_SPACE; //ÎŞ×ã¹»µÄ´æ´¢¿Õ¼ä
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               if(pfi!=pcccb_cur_oc) //Èç¹ûµ±Ç°Õ¼ÓÃCCCBµÄ²»ÊÇÏÖÔÚÒª²Ù×÷µÄÎÄ¼ş
               {
                CCCB_Update_FAT();
                pcccb_cur_oc=pfi;
                (*pcccb_curdev)=Dev_No;
                pcccb_cur_initargs=pInit_Args;
               }
               #endif
               (*pcccb_curval)=cluster;
               #endif
              
               //===================================ÕâÀï¿ÉÄÜ²úÉú·µÁ´==========================================
              
               cluster=(pInit_Args->Next_Free_Cluster);
              
               pfi->File_CurClust=pInit_Args->Next_Free_Cluster; //µ±Ç°´ØÎªÏÂÒ»¿Õ´Ø
               pfi->File_CurSec=SOC(pfi->File_CurClust); //µ±Ç°´ØµÄÊ×ÉÈÇø
              
               ncluster--;
               //============================
              
               if(0!=old_clu)
               {
                clu_sec=(old_clu/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                temp=(UINT8)(old_clu%NITEMSINFATSEC);
                (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 69  

                (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                #else
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                if(0==(*pcccb_counter)) 
                {
                 pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
                 (*pcccb_counter)++;
                }
              
                if(cluster==((*pcccb_curval)+1))
                {
                 (*pcccb_curval)++;
                }
                else
                {
                 if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                 {
                  pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
                  (*pcccb_counter)++;
                  pcccb_buf[(*pcccb_counter)]=cluster;
                  (*pcccb_curval)=cluster;
                  (*pcccb_counter)++;
                 }
                 else //CCCBÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT
                 {
                      CCCB_Update_FAT();
                      #ifndef USE_ALONE_CCCB
                      pcccb_cur_oc=pfi;
                  (*pcccb_curdev)=Dev_No;
                  pcccb_cur_initargs=pInit_Args;
                  #endif
              
                  (*pcccb_counter)=0;
                  pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                  pcccb_buf[(*pcccb_counter)+2]=cluster;
                  (*pcccb_curval)=cluster;
                  (*pcccb_counter)+=3;
                 }
                }
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                #endif
               }
               else
               {
                clu_sec=(cluster/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                
                #ifndef RT_UPDATE_CLUSTER_CHAIN
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                (*pcccb_counter)=0;
                pcccb_buf[(*pcccb_counter)]=cluster;
                (*pcccb_curval)=cluster;
                (*pcccb_counter)++;
                //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                #endif
               }
              
               #ifdef RT_UPDATE_CLUSTER_CHAIN
               if(clu_sec==(cluster/NITEMSINFATSEC)) //Èç¹ûÄ¿±ê´ØÏîÓëÇ°Ò»´ØÏîÔÚÍ¬Ò»ÉÈÇø
               {
                if(0==ncluster) 
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 70  

                {
                 temp=(UINT8)(cluster%NITEMSINFATSEC);
                 (((pFAT_Sec->items)[temp]).Item)[0]=0XFF;  //´ØÁ´·â¿Ú  
                 (((pFAT_Sec->items)[temp]).Item)[1]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[2]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[3]=0X0F;   
              
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                }
               }
               else //Èç¹ûÄ¿±ê´ØÏîÓëÇ°Ò»´ØÏî²»ÔÚÍ¬Ò»ÉÈÇø
               {
                znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
              
                clu_sec=(cluster/NITEMSINFATSEC); //¼ÆËãÇ°Ò»´ØµÄ´ØÏîËùÔÚµÄFATÉÈÇø
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                if(0==ncluster) 
                {
                 temp=(UINT8)(cluster%NITEMSINFATSEC);
              
                 (((pFAT_Sec->items)[temp]).Item)[0]=0XFF;  //´ØÁ´·â¿Ú  
                 (((pFAT_Sec->items)[temp]).Item)[1]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[2]=0XFF;
                 (((pFAT_Sec->items)[temp]).Item)[3]=0X0F;   
              
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                 znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                }
               }
               #endif
               
               if(0==ncluster) //Èç¹û´ØÁ´¹¹ÔìÍê³É
               {
                pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
              
                Update_Next_Free_Cluster();
              
                #ifdef RT_UPDATE_FSINFO
                Update_FSINFO();
                #endif
              
                return ERR_SUCC;
               }
              
               old_clu=cluster; 
              
               //=============================================================================================
              
               clu_sec=(old_clu/NITEMSINFATSEC);
              
               if(((UINT8)((cluster%NITEMSINFATSEC)+1))!=((UINT8)NITEMSINFATSEC)) //Èç¹ûµ±Ç°µÄ´ØÏî²»ÊÇÆäËùÔÚFATÉÈÇøÖĞµÄ×
             -îºóÒ»¸ö´ØÏî
               {
                znFAT_Device_Read_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                for(iItem=(UINT8)((cluster%NITEMSINFATSEC)+1);iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏ
             -îÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                {
                 cluster++; //´ØºÅ×ÔÔö
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 71  

              
                 if(0==(((pFAT_Sec->items)[iItem]).Item)[0]  //Èç¹û·¢ÏÖ¿Õ´Ø
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                 { 
                      #ifdef RT_UPDATE_CLUSTER_CHAIN
                  temp=(UINT8)(old_clu%NITEMSINFATSEC);
              
                  (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                  (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                  (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
                  (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                  #else
                      //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  if(cluster==((*pcccb_curval)+1))
                      {
                   (*pcccb_curval)++;
                      }
                  else
                      {
                   if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                   {
                    pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
                    (*pcccb_counter)++;
                    pcccb_buf[(*pcccb_counter)]=cluster;
                    (*pcccb_curval)=cluster;
                    (*pcccb_counter)++;
                   }
                   else //CCCBÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT£¬²¢Çå¿ÕCCCB£¬ÒÔ±ãÔÙ´ÎÀûÓÃ
                   {
                        CCCB_Update_FAT();
                        #ifndef USE_ALONE_CCCB
                        pcccb_cur_oc=pfi;
                    (*pcccb_curdev)=Dev_No;
                    pcccb_cur_initargs=pInit_Args;
                    #endif
              
                        (*pcccb_counter)=0;
                        pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                        pcccb_buf[(*pcccb_counter)+2]=cluster;
                    (*pcccb_curval)=cluster;
                        (*pcccb_counter)+=3;
                   }
                      }
                      //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  #endif
                  ncluster--;
                  old_clu=cluster;
                 }
              
                 if(0==ncluster) 
                 {
                  #ifdef RT_UPDATE_CLUSTER_CHAIN
                      (((pFAT_Sec->items)[iItem]).Item)[0]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[1]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[2]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[3]=0X0F; //FATÁ´·â¿Ú
                  
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 72  

                  #endif
                  pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
                  pInit_Args->Next_Free_Cluster=cluster; 
              
                  Update_Next_Free_Cluster();
              
                  #ifdef RT_UPDATE_FSINFO
                  Update_FSINFO();
                  #endif
              
                  return ERR_SUCC;
                 }
                }
               }
               #ifdef RT_UPDATE_CLUSTER_CHAIN
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
               znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
               #endif
               //=============================================================================================
              
               for(iSec=(clu_sec+1);iSec<(pInit_Args->FATsectors);iSec++) //ÔÚºóÃæµÄFATÉÈÇøÖĞ¼ÌĞø²éÕÒ
               {
                znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
              
                for(iItem=0;iItem<NITEMSINFATSEC;iItem++) //¼ì²âÔÚµ±Ç°FATÉÈÇøÄÚµ±Ç°´ØÏîÖ®ºóÊÇ·ñÓĞ¿Õ´Ø
                {
                 cluster++;
              
                 if(0==(((pFAT_Sec->items)[iItem]).Item)[0]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[1]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[2]
                 && 0==(((pFAT_Sec->items)[iItem]).Item)[3])
                 {
                  #ifdef RT_UPDATE_CLUSTER_CHAIN
                      clu_sec=(old_clu/NITEMSINFATSEC);
                  temp=(UINT8)(old_clu%NITEMSINFATSEC);
              
                  if(iSec!=clu_sec) //Èç¹ûÒª¸üĞÂµÄ´ØÏîËùÔÚµÄÉÈÇøÓëµ±Ç°ÉÈÇø²»ÊÇÍ¬Ò»ÉÈÇø
                      {                 //ÔòĞèÒªÔÚ¸üĞÂ´ØÏîºó£¬»Ö¸´ÄÚ²¿¼¶³åµÄÊı¾İÎªµ±Ç°ÉÈÇø
                   Modify_FAT(old_clu,cluster);
              
                   znFAT_Device_Read_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);   
                      }
                      else //¶øÈç¹ûÒª¸üĞÂµÄ´ØÏîËùÔÚÉÈÇøÓëµ±Ç°ÉÈÇøÎªÍ¬Ò»ÉÈÇø£¬ÔòÖ»ĞèÒªÔÚÄÚ²¿»º³åÖĞ½øĞĞ¸üĞÂ
                      {    //¶øÎŞĞèÏòÉÈÇøÖĞ»ØĞ´£¬ÕâÊÇÌá¹©´ØÁ´´´½¨ËÙ¶ÈµÄºËĞÄË¼Ïë
                   (((pFAT_Sec->items)[temp]).Item)[0]=(UINT8)(cluster&0X000000FF)      ;  //½«ÆäÁ´ÔÚÇ°ÃæµÄ´ØÏîÉÏ   
                   (((pFAT_Sec->items)[temp]).Item)[1]=(UINT8)((cluster&0X0000FF00)>>8) ;
                   (((pFAT_Sec->items)[temp]).Item)[2]=(UINT8)((cluster&0X00FF0000)>>16);
                   (((pFAT_Sec->items)[temp]).Item)[3]=(UINT8)((cluster&0XFF000000)>>24);
                      }
                  #else
                      //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  if(cluster==((*pcccb_curval)+1))
                      {
                   (*pcccb_curval)++;
                      }
                  else
                      {
                   if(((*pcccb_counter)+1)!=CCCB_LEN) //CCCBÃ»ÓĞÒç³ö
                   {
                    pcccb_buf[(*pcccb_counter)]=(*pcccb_curval);
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 73  

                    (*pcccb_counter)++;
                    pcccb_buf[(*pcccb_counter)]=cluster;
                    (*pcccb_curval)=cluster;
                    (*pcccb_counter)++;
                   }
                   else //CCCBÃ»ÓĞÒç³ö£¬´ËÊ±ĞèÒª½«CCCB¸üĞÂµ½FAT
                   {
                        CCCB_Update_FAT();
                        #ifndef USE_ALONE_CCCB
                        pcccb_cur_oc=pfi;
                    (*pcccb_curdev)=Dev_No;
                    pcccb_cur_initargs=pInit_Args;
                    #endif
              
                        (*pcccb_counter)=0;
                        pcccb_buf[(*pcccb_counter)]=pcccb_buf[(*pcccb_counter)+1]=(*pcccb_curval);
                        pcccb_buf[(*pcccb_counter)+2]=cluster;
                    (*pcccb_curval)=cluster;
                        (*pcccb_counter)+=3;
                   }
                      }
                      //---------------------------------CCCBµÄ´¦Àí--------------------------------------
                  #endif
                      ncluster--;
                      old_clu=cluster;
                 }
              
                 if(0==ncluster) 
                 {
                      #ifdef RT_UPDATE_CLUSTER_CHAIN
                      clu_sec=(old_clu/NITEMSINFATSEC);
              
                      (((pFAT_Sec->items)[iItem]).Item)[0]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[1]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[2]=0XFF;
                      (((pFAT_Sec->items)[iItem]).Item)[3]=0X0F; //FATÁ´·â¿Ú
              
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                  znFAT_Device_Write_Sector(clu_sec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                  #endif
                  pInit_Args->Free_nCluster-=temp_ncluster; //¸üĞÂÊ£Óà¿Õ´ØÊı
                  pInit_Args->Next_Free_Cluster=cluster; 
              
                  Update_Next_Free_Cluster();
              
                  #ifdef RT_UPDATE_FSINFO
                  Update_FSINFO();
                  #endif
              
                  return ERR_SUCC;
                 }
                }
                #ifdef RT_UPDATE_CLUSTER_CHAIN
                znFAT_Device_Write_Sector(iSec+(pInit_Args->FirstFATSector),znFAT_Buffer);
                znFAT_Device_Write_Sector(iSec+(pInit_Args->FirstFATSector+pInit_Args->FATsectors),znFAT_Buffer);
                #endif
               } 
              
               return ERR_FAIL;
              }
              #endif
4452          
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 74  

4453          /************************************************************************************
4454           ¹¦ÄÜ£º´ÓÎÄ¼şÕû´ØÎ»ÖÃ¿ªÊ¼Ğ´ÈëÊı¾İ
4455           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë len:ÒªĞ´ÈëµÄÊı¾İ³¤¶È pbuf:Ö¸ÏòÊı¾İ»º³åÇø
4456           ·µ»Ø£ºÊµ¼ÊĞ´ÈëµÄÊı¾İÁ¿
4457           Ïê½â£ºznFATÖĞÏòÎÄ¼şĞ´ÈëÊı¾İÊÇÒÔ×·¼Ó·½Ê½Ğ´ÈëµÄ£¬¼´×ÜÊÇ´ÓÎÄ¼şµÄÄ©Î²ÏòºóĞ´ÈëÊı¾İ¡£Ğ´Èë
4458                 Êı¾İµÄÒÀ¾İÊÇÎÄ¼şµ±Ç°µÄÎ»ÖÃ²ÎÊı£¬µ«ÊÇµ±ÎÄ¼şÎª¿ÕÎÄ¼ş£¬¼´ÆäÊı¾İÎª0£¬»òÊÇÊı¾İÎª´Ø
4459                 ´óĞ¡µÄÕûÊı±¶£¬´ËÊ±ÎÄ¼şµÄÎ»ÖÃ²ÎÊı½«²»ÄÜÈçÊµ±í´ïÎÄ¼şÊı¾İµÄµ±Ç°Î»ÖÃ£¨ÎÄ¼şÎª¿ÕÊ±
4460                 µ±Ç°´ØÎª0£¬Õû´ØÊ±µ±Ç°´ØÎª×îºóÒ»¸öÓĞĞ§´Ø£©£¬ÕâÖÖÇé¿ö¾ÍÊÇznFATÖĞµÄ¡°å´Ø¡±£¬´Ëº¯
4461                 Êı×¨ÃÅÓÃÒÔ´¦ÀíÕâÖÖÇé¿ö¡£
4462          *************************************************************************************/
4463          #ifdef WRITEDATA_FROM_NCLUSTER
              UINT32 WriteData_From_nCluster(struct FileInfo *pfi,UINT32 len,UINT8 *pbuf)
              {
               UINT32 CluSize=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust)); //¼ÆËã´Ø´óĞ¡£¬ÒÔÃâºóÃæÖØ¸´¼Æ
             -Ëã
               UINT32 temp=len/CluSize;//¼ÆËãÒªĞ´ÈëµÄÊı¾İÁ¿¹»¼¸¸öÕû´Ø
               UINT32 iClu=0,start_clu=0,end_clu=0,next_clu=0; 
               UINT32 temp1=0,temp2=0;
               UINT8 res=0;
              
               #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               UINT8 old_devno=Dev_No;
               #else
               pexb_buf=(pfi->exb_buf);
               #endif
               #endif
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               if(0==len) return 0; //Èç¹ûÒªĞ´ÈëµÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø
              
               if(0==pfi->File_CurClust) //Èç¹ûÊÇ¿ÕÎÄ¼ş£¬Ôòµ±Ç°´ØÎª0£¬¼´ÉĞÎ´ÎªÆä·ÖÅä´Ø
               {
                pfi->File_StartClust=pInit_Args->Next_Free_Cluster;
                Update_File_sClust(pfi,pInit_Args->Next_Free_Cluster);
               }
              
               res=Create_Cluster_Chain(pfi,pfi->File_CurClust,len); //ÎªÕû´ØÊı¾İÔ¤½¨´ØÁ´
               if(res) return res;
              
               if(0==temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÉÙÓÚÒ»¸ö´Ø
               {
                temp=len/(pInit_Args->BytesPerSector); //ÒªĞ´ÈëµÄÊı¾İ¹»¼¸¸öÕûÉÈÇø
                znFAT_Device_Write_nSector(temp,SOC(pfi->File_CurClust),pbuf);
                pfi->File_CurSec+=temp;
                pbuf+=(temp*(pInit_Args->BytesPerSector));
              
                temp=len%(pInit_Args->BytesPerSector);
                if(0!=temp) //»¹ÓĞÊı¾İÒªĞ´Èë£¬²»×ãÉÈÇøµÄ×îºóÒ»µãÊı¾İ
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 Memory_Copy(znFAT_Buffer,pbuf,temp); //°Ñ²»×ãÒ»ÉÈÇøµÄÊı¾İÏÈ·ÅÈëÄÚ²¿»º³åÇøÖĞ
                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //½«ÄÚ²¿»º³åÇøÖĞµÄÊı¾İĞ´ÈëÉÈÇøÖĞ
                                                                       //Èç¹ûÖ±½ÓÊ¹ÓÃpbuf×÷Êı¾İÔ´À´Ğ´Èë£¬Òò²»×ãÒ»¸öÉÈÇø
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 75  

                                                                       //´Ó¶ø»áÔì³ÉÄÚ´æÒç³ö,³ÌĞò±ÀÀ£
                 #else
                 #ifndef USE_ALONE_EXB
                 if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                      if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                      {
                       Dev_No=sexb_cur_dev;
                       znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                   Dev_No=old_devno;
                      }
                 }
                 else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                 {
                      if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                      {
                       if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                       {
                        znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
                       }         
                      }
                 }
                 #endif 
              
                 Memory_Copy(pexb_buf,pbuf,temp);
              
                 #ifndef USE_ALONE_EXB
                 sexb_cur_sec=pfi->File_CurSec;   //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞËù·´Ó³µÄÉÈÇøµØÖ·
                 sexb_cur_dev=Dev_No; //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞÊı¾İËùÔÚµÄÉè±¸ºÅ
                 psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                 #else
                 just_file->exb_cursec=pfi->File_CurSec;
                 #endif
                 #endif
                        
                 pfi->File_CurPos=(UINT16)temp;   
                }
               }
               else
               {
                //¼ÆËã¸÷Á¬Ğø´Ø¶Î£¬ÒÔ¾¡¿ÉÄÜµÄÊ¹ÓÃ¶àÉÈÇøĞ´Çı¶¯£¬ÒÔÌá¸ßÊı¾İĞ´ÈëËÙ¶È
                //start_cluÓëend_cluÓÃÓÚ¼ÇÂ¼Á¬Ğø´Ø¶ÎµÄÊ¼Ä©
                start_clu=end_clu=pfi->File_CurClust; 
              
                for(iClu=1;iClu<temp;iClu++)
                {
                 next_clu=Get_Next_Cluster(end_clu);
              
                 if((next_clu-1)==end_clu) //Èç¹ûÁ½¸ö´ØÏàÁÙ£¬¼´Á¬Ğø
                 {
                  end_clu=next_clu;
                 }
                 else //Èç¹ûÁ½¸ö´Ø²»ÏàÁÙ£¬¼´Óöµ½´ØÁ´¶Ïµã
                 {
                  znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),pbuf);
                      pbuf+=((end_clu-start_clu+1)*CluSize);
                  start_clu=next_clu;
                  end_clu=next_clu;
                 }
                }
              
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 76  

                temp1=(len%CluSize)/(pInit_Args->BytesPerSector); //Ê£ÓàÊı¾İ¹»¼¸¸öÕûÉÈÇø
                temp2=Get_Next_Cluster(end_clu);
                temp=(end_clu-start_clu+1)*(pInit_Args->SectorsPerClust);
               
                if(!IS_END_CLU(temp2)) //Èç¹ûÏÂÒ»´Ø²»ÊÇ½áÊø´Ø£¬¼´ºóÃæ»¹ÓĞÊı¾İÒªĞ´Èë
                {
                 if((temp2-1)==end_clu) //Èç¹û×îºóÒ»¸ö´ØÖĞµÄÊ£ÓàÉÈÇøÓëÇ°ÃæµÄ×îºóµÄÁ¬Ğø´Ø¶ÎÊÇÁ¬ĞøµÄ
                 {
                  znFAT_Device_Write_nSector((temp+temp1),SOC(start_clu),pbuf);
                  pbuf+=((temp+temp1)*(pInit_Args->BytesPerSector));
                 }
                 else
                 {
                  znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),pbuf);
             - 
                  pbuf+=(temp*(pInit_Args->BytesPerSector));
                  znFAT_Device_Write_nSector(temp1,SOC(temp2),pbuf);
                  pbuf+=(temp1*(pInit_Args->BytesPerSector));
                 }
              
                 pfi->File_CurClust=temp2;
                 pfi->File_CurSec=(SOC(temp2)+temp1);
                 //=======================================================================================
                 temp=len%(pInit_Args->BytesPerSector);
                 if(0!=temp) //»¹ÓĞÊı¾İÒªĞ´Èë
                 {
                      #ifndef USE_EXCHANGE_BUFFER
                  Memory_Copy(znFAT_Buffer,pbuf,temp); //°Ñ²»×ãÒ»ÉÈÇøµÄÊı¾İÏÈ·ÅÈëÄÚ²¿»º³åÇøÖĞ
                  znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //½«ÄÚ²¿»º³åÇøÖĞµÄÊı¾İĞ´ÈëÉÈÇøÖĞ
                                                                       //Èç¹ûÖ±½ÓÊ¹ÓÃpbuf×÷Êı¾İÔ´À´Ğ´Èë£¬Òò²»×ãÒ»¸öÉÈÇø
                                                                       //´Ó¶ø»áÔì³ÉÄÚ´æÒç³ö,³ÌĞò±ÀÀ£
                  #else
                  #ifndef USE_ALONE_EXB
                  if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                  {
                       if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                       {
                        Dev_No=sexb_cur_dev;
                        znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno;
                       }
                  }
                  else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                  {
                       if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                       {
                        if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                        {
                         znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
                        }        
                       }
                  }
                  #endif
              
                  Memory_Copy(pexb_buf,pbuf,temp);
              
                  #ifndef USE_ALONE_EXB
                  sexb_cur_sec=pfi->File_CurSec;
                      sexb_cur_dev=Dev_No; //¼ÇÂ¼µ±Ç°½»»»»º³åÖĞÊı¾İËùÔÚµÄÉè±¸ºÅ
                      psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 77  

                  #else
                  just_file->exb_cursec=pfi->File_CurSec;
                  #endif
                  #endif   
                      
                      pfi->File_CurPos=(UINT16)temp;
                 }
                }
                else //Èç¹ûÏÂÒ»´ØÒÑÎª½áÊø´Ø£¬¼´ºóÃæÒÑÎŞÊı¾İÔÙÒªĞ´Èë
                {
                 znFAT_Device_Write_nSector(temp,SOC(start_clu),pbuf);
                 pbuf+=((temp+temp1)*(pInit_Args->BytesPerSector)); 
              
                 pfi->File_CurClust=end_clu;
                 pfi->File_CurSec=SOC(end_clu);
                }
               }
              
               //========================ÒÔÉÏ´úÂëÓÃÓÚ´¦ÀíÕû´ØÓëÕûÉÈÇøÊı¾İµÄĞ´Èë£¬¾¡¿ÉÄÜÀûÓÃÁËÉÈÇøµÄÁ¬ĞøĞÔ===============
             -=========
               #ifdef RT_UPDATE_FSINFO
               Update_FSINFO();
               #endif
              
               pfi->File_CurOffset+=len;
              
               return len;
              } 
              #endif
4664          
4665          /************************************************************************************
4666           ¹¦ÄÜ£ºÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ
4667           ĞÎ²Î£ºpfi:Ö¸ÕëÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë len:ÒªĞ´ÈëµÄÊı¾İÁ¿ pbuf:Ö¸ÏòÊı¾İ»º³åÇøµÄÖ¸Õë
4668           ·µ»Ø£ºÊµ¼ÊÏòÎÄ¼şÖĞĞ´ÈëµÄÊı¾İÁ¿  Èç¹ûÎÄ¼ş´óĞ¡ÒÑ¾­´ïµ½FAT32ÖĞËùÏŞÖÆµÄ¼«ÏŞ£¬·µ»Ø-2
4669           Ïê½â£ºÕâÊÇ×îÖÕ¹©Ê¹ÓÃÕßµ÷ÓÃµÄÎÄ¼şÊı¾İĞ´Èëº¯Êı£¬Ëü×ÜÊÇ´ÓÎÄ¼şµÄÄ©Î²ÏòºóĞ´ÈëÊı¾İ£¬¼´Êı¾İ
4670                 ÊÇÒÔ×·¼ÓµÄ·½Ê½±»Ğ´ÈëµÄ¡£ÔÚÊı¾İĞ´ÈëÖ®ºó£¬Òª¼°Ê±µÄ¸üĞÂÎÄ¼ş´óĞ¡£¬·ñÔòĞ´ÈëµÄÊı¾İ½«
4671                 ²»¿É¼û¡£¿ÉÒÔ´ò¿ªRT_UPDATE_FILESIZEºêÀ´¿ªÆôÊµÊ±ÎÄ¼ş´óĞ¡¸üĞÂ¹¦ÄÜ£¬¼´Ã¿´ÎĞ´ÈëÊı¾İ
4672                 znFAT¶¼»áÈ¥¸üĞÂÎÄ¼ş´óĞ¡£¬ÕâÖÖ¹¤×÷·½Ê½ÏÂÄÄÅÂÖĞ¼äÍ»È»¶Ïµç»òËÀ»ú¶¼Ã»ÓĞ¹ØÏµ£¬¿ÉÒÔ
4673                 ±£Ö¤ÎÄ¼ş´óĞ¡ÈçÊµ·´Ó³ÎÄ¼şµÄÓĞĞ§Êı¾İÁ¿£¬µ«ÕâÖÖ·½Ê½Ê¹Êı¾İĞ´ÈëµÄËÙ¶ÈºÍĞ§ÂÊ±äÂı¡£Èô
4674                 ²»Ê¹ÓÃ´Ëºê£¬ÔòĞèÒªÊ¹ÓÃÕßÔÚËùÓĞĞ´ÈëÊı¾İµÄ²Ù×÷Íê³ÉÖ®ºó£¬µ÷ÓÃ¸üĞÂÎÄ¼ş´óĞ¡µÄº¯Êı¡£
4675          *************************************************************************************/
4676          #ifdef ZNFAT_WRITEDATA
              UINT32 znFAT_WriteData(struct FileInfo *pfi,UINT32 len,UINT8 *pbuf)
              {
               UINT32 temp=0,temp1=0,len_temp=len;
               UINT32 Cluster_Size=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust));
              
               #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               UINT8 old_devno=Dev_No;
               #else
               pexb_buf=(pfi->exb_buf);
               #endif
               #endif
              
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 78  

               #endif
              
               if(0==len) return 0; //Èç¹ûÒªĞ´ÈëµÄÊı¾İ³¤¶ÈÎª0£¬ÔòÖ±½Ó·µ»Ø0
              
               if(len>(0XFFFFFFFF-pfi->File_Size)) return (UINT32)-2; //ÎÄ¼ş´óĞ¡ÔÚĞ´ÈëÊı¾İºó½«·¢ÉúÒç³ö´íÎó
               
               znFAT_Seek(pfi,pfi->File_Size); //ÎÄ¼şÊı¾İ¶¨Î»µ½ÎÄ¼şÄ©Î²£¬ÎÄ¼şÎ»ÖÃÏà¹ØĞÅÏ¢Ëæ¼´¸Ä±ä
              
               //¼ì²é´ÅÅÌÊ£Óà¿Õ¼äÊÇ·ñ¹»ÓÃ
               if((pfi->File_CurOffset%Cluster_Size)!=0)
               {
                temp=((pInit_Args->BytesPerSector)-(pfi->File_CurPos))+((LAST_SEC_OF_CLU(pfi->File_CurClust))-(pfi->File
             -_CurSec))*(Cluster_Size);
                //µ±Ç°´ØÊ£ÓàÊı¾İÁ¿
              
                if(len>temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÁ¿´óÓÚtemp£¬ÔòËµÃ÷±ØÈ»»á³¬³öµ±Ç°´Ø£¬ÎªÆäÀ©Õ¹¿Õ´Ø
                {
                 temp1=(len-temp)/(Cluster_Size);
                 if((len-temp)%(Cluster_Size)) temp1++; //¼ÆËãĞèÒª¶àÉÙ¸ö¿Õ´Ø
              
                 if(temp1>(pInit_Args->Free_nCluster)) return ((UINT32)-1); //¿Õ¼ä²»×ã
                }
              
               }
               else
               {
                temp1=len/(Cluster_Size);
                if(len%(Cluster_Size)) temp1++; //¼ÆËãĞèÒª¶àÉÙ¸ö¿Õ´Ø  
                if(temp1>(pInit_Args->Free_nCluster)) return ((UINT32)-1); //¿Õ¼ä²»×ã
               }
              
               //=======================================================================================================
             -====
              
               temp=((pInit_Args->BytesPerSector)-(pfi->File_CurPos)); //¼ÆËã¸³¸øÁÙÊ±±äÁ¿£¬ÒÔÃâºóÃæÖØ¸´¼ÆËã
              
               if((pfi->File_CurOffset%Cluster_Size)!=0)
               {
                if(len<=temp) //ÒªĞ´ÈëµÄÊı¾İĞ¡ÓÚµÈÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //¶ÁÈ¡µ±Ç°ÉÈÇøÊı¾İ£¬ÒÔ±ã×÷ÉÈÇøÄÚÊı¾İÆ´½Ó
                 Memory_Copy(znFAT_Buffer+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //»ØĞ´ÉÈÇøÊı¾İ
                 #endif
              
                 if(len==temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÕıºÃÕ¼Âúµ±Ç°ÉÈÇø
                 {
                      #ifdef USE_EXCHANGE_BUFFER
                      if(0!=pfi->File_CurPos) 
                      {
                   #ifndef USE_ALONE_EXB
                       if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                       {
                        if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                        {
                         Dev_No=sexb_cur_dev;
                         znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                     Dev_No=old_devno;
                        }
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 79  

                        znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                       }
                       else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                       {
                        if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                        {
                         if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                         {
                          znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇø
             -ÖĞ
              
                          znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                         }       
                        }
                       }
              
                   #else
                       if(0==(just_file->exb_cursec)) 
                       {
                        znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                       }
                   #endif
              
                       Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
              
                   znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //»ØĞ´ÉÈÇøÊı¾İ
                   
                   #ifndef USE_ALONE_EXB
                       sexb_cur_sec=0; //Ã¿´ÎEXBÖĞµÄÊı¾İÒÔÕûÉÈÇøÊı¾İ»ØĞ´Ö®ºó£¬ÎÒÃÇ±ãÈÏÎªËü²»ÔÙ±»Õ¼ÓÃÁË
                       sexb_cur_dev=(UINT8)(-1); //EXBµÄµ±Ç°Éè±¸ºÅÖÃÎª¿Õ£¬ÕâÀïÈ¡-1ÈÏ¶¨ÆäÎª¿Õ£¬ÎªÁËÓëÓĞĞ§Éè±¸ºÅ0ÏàÇø·Ö
                       psexb_cur_oc=(struct FileInfo *)0; //´ËÊ±EXB²»¹éÈÎºÎÎÄ¼şËùÓĞ
                   #else
                       (just_file->exb_cursec)=0; //ÎÄ¼şµÄ¶ÀÁ¢EXBÎ´Õ¼ÓÃ
                   #endif
                      }
                      else
                      {
                       znFAT_Device_Write_Sector(pfi->File_CurSec,pbuf); //»ØĞ´ÉÈÇøÊı¾İ
                      }
                  #endif
              
                      if(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust)) //Èç¹ûµ±Ç°ÉÈÇøÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                      {
                       pfi->File_CurSec=SOC(pfi->File_CurClust); //¸üĞÂµ±Ç°ÉÈÇø£¬ÆäÊµÎŞĞ§£¬ÎªÁË¹æÕû
                      }
                      else //µ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÉÈÇø
                      {
                       pfi->File_CurSec++;
                      }
              
                      pfi->File_CurPos=0;
                      pfi->File_CurOffset+=len; //¸üĞÂµ±Ç°Æ«ÒÆÁ¿
                      pfi->File_Size+=len; //¸üĞÂÎÄ¼ş´óĞ¡
                   
                  #ifdef RT_UPDATE_FILESIZE
                      Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                  #endif
              
                      return len;
                 }
                 else//lenĞ¡ÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
                 {  
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 80  

                      #ifdef USE_EXCHANGE_BUFFER
                  #ifndef USE_ALONE_EXB
                      if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                      {
                       if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                       {
                        Dev_No=sexb_cur_dev;
                        znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno; 
                       }
                       znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                      }
                      else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                      {
                       if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                       {
                        if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                        {
                         znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                         znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                        }        
                       }
                      }
                  #else
                      if((0==(just_file->exb_cursec)) && (0!=(pfi->File_CurPos))) //µ±Ç°ÎÄ¼şµÄ¶ÀÁ¢EXBÎ´±»Õ¼ÓÃ£¬ÇÒÎÄ¼şµ±Ç°ÉÈÇøÄÚ
             -Æ«ÒÆ²»Îª0£¬Èç¹ûÎª0ÔòÃ»±ØÒª¶ÁÉÈÇø
                      {
                       znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                      }
                  #endif
              
                      Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,len); //ÉÈÇøÊı¾İÆ´½Ó
              
                  #ifndef USE_ALONE_EXB
                      sexb_cur_dev=Dev_No;
                      sexb_cur_sec=pfi->File_CurSec;
                      psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                  #else
                      (just_file->exb_cursec)=pfi->File_CurSec;
                  #endif
                  #endif
                  //znFAT_Device_Write_Sector(pfi->File_CurSec,ex_buf); //»ØĞ´ÉÈÇøÊı¾İ
              
                  pfi->File_CurPos+=(UINT16)len;
                  pfi->File_CurOffset+=len; //¸üĞÂµ±Ç°Æ«ÒÆÁ¿
                  pfi->File_Size+=len; //¸üĞÂÎÄ¼ş´óĞ¡ 
                      
                  #ifdef RT_UPDATE_FILESIZE
                      Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                  #endif
              
                      return len;      
                 }
                }
                else 
                {
                 #ifndef USE_EXCHANGE_BUFFER
                 znFAT_Device_Read_Sector(pfi->File_CurSec,znFAT_Buffer); //¶ÁÈ¡µ±Ç°ÉÈÇø
                 Memory_Copy(znFAT_Buffer+pfi->File_CurPos,pbuf,temp); //ÉÈÇøÊı¾İÆ´½Ó
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 81  

                 znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer); //»ØĞ´ÉÈÇø
                 #else
              
                 if(0!=pfi->File_CurPos) 
                 {
                  #ifndef USE_ALONE_EXB
                      if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                      {
                       if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                       {
                        Dev_No=sexb_cur_dev;
                        znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖĞ
              
                    Dev_No=old_devno;
                       }
                       znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                      }
                      else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                      {
                       if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                       {
                        if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                        {
                         znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇøÖ
             -Ğ
              
                         znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf); 
                        }        
                       }
                      }
                  #else
                      if(0==(just_file->exb_cursec)) 
                      {
                       znFAT_Device_Read_Sector(pfi->File_CurSec,pexb_buf);
                      }
                  #endif
              
                      Memory_Copy(pexb_buf+pfi->File_CurPos,pbuf,temp); //ÉÈÇøÊı¾İÆ´½Ó
              
                  znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //»ØĞ´ÉÈÇøÊı¾İ
              
                  #ifndef USE_ALONE_EXB
                      sexb_cur_sec=0; //Ã¿´ÎEXBÖĞµÄÊı¾İÒÔÕûÉÈÇøÊı¾İ»ØĞ´Ö®ºó£¬ÎÒÃÇ±ãÈÏÎªËü²»ÔÙ±»Õ¼ÓÃÁË
                      sexb_cur_dev=(UINT8)(-1); //EXBµÄµ±Ç°Éè±¸ºÅÖÃÎª¿Õ£¬ÕâÀïÈ¡-1ÈÏ¶¨ÆäÎª¿Õ£¬ÎªÁËÓëÓĞĞ§Éè±¸ºÅ0ÏàÇø·Ö
                      psexb_cur_oc=(struct FileInfo *)0;
                  #else
                      (just_file->exb_cursec)=0; //µ±Ç°ÎÄ¼ş¶ÀÁ¢EXBÎ´±»Õ¼ÓÃ
                  #endif
                 }
                 else //Èç¹ûµ±Ç°Î»ÖÃÔÚ0Î»ÖÃ£¬ÔòÖ±½ÓĞ´ÉÈÇø
                 {
                      znFAT_Device_Write_Sector(pfi->File_CurSec,pbuf); //»ØĞ´ÉÈÇøÊı¾İ
                 }
                 #endif
              
                 len_temp-=temp;
                 pbuf+=temp;
              
                 if(!(IS_END_SEC_OF_CLU(pfi->File_CurSec,pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ×îºóÒ»¸öÉÈÇø
                 {
                      pfi->File_CurSec++;
                      pfi->File_CurPos=0;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 82  

              
                  pfi->File_CurOffset+=temp;
              
                  temp=(LAST_SEC_OF_CLU(pfi->File_CurClust)-(pfi->File_CurSec)+1)*(pInit_Args->BytesPerSector);//µ±Ç°´ØÖ
             -ĞµÄÊ£ÓàÕûÕûÉÈÇøÊı¾İÁ¿
              
                  if(len_temp<=temp) //Èç¹ûÒªĞ´ÈëµÄÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°´ØÖĞµÄÊ£ÓàÕûÉÈÇøÊı¾İÁ¿
                      {
                       temp1=len_temp/(pInit_Args->BytesPerSector); //¼ÆËãÒªĞ´ÈëµÄÊı¾İÁ¿¹»¼¸¸öÕûÉÈÇø
              
                       znFAT_Device_Write_nSector(temp1,pfi->File_CurSec,pbuf);
                       pbuf+=((pInit_Args->BytesPerSector)*temp1);
              
                       if(len_temp==temp) //Èç¹ûÕıºÃĞ´Âúµ±Ç°´Ø
                       {
                        pfi->File_CurSec=SOC(pfi->File_CurClust); //å´Ø
                        pfi->File_CurPos=0;
              
                        pfi->File_CurOffset+=len_temp;
                        pfi->File_Size+=len;
              
                    #ifdef RT_UPDATE_FILESIZE
                        Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                    #endif
              
                        return len;
                       }
                       else
                       {
                        pfi->File_CurSec+=temp1;
                        pfi->File_CurPos=(UINT16)(len_temp%(pInit_Args->BytesPerSector));
              
                        if(pfi->File_CurPos) //»¹ÓĞÒªĞ´µÄÊı¾İ,´¦Àí×îºóµÄ×Ö½ÚÊı¾İ
                        {
                     #ifndef USE_EXCHANGE_BUFFER
                         Memory_Copy(znFAT_Buffer,pbuf,pfi->File_CurPos);
                         znFAT_Device_Write_Sector(pfi->File_CurSec,znFAT_Buffer);
                     #else
                     #ifndef USE_ALONE_EXB
                     if(Dev_No!=sexb_cur_dev) //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸²»ÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                         {
                          if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                              {
                           Dev_No=sexb_cur_dev;
                           znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈÇ
             -øÖĞ
              
                       Dev_No=old_devno;
                              }
                         }
                     else //Èç¹ûÏÖÔÚ²Ù×÷µÄÉè±¸ÕıÊÇµ±Ç°Õ¼ÓÃEXBµÄÉè±¸
                         {
                          if(sexb_cur_sec!=(pfi->File_CurSec)) //Õ¼ÓÃEXBµÄÉÈÇø²»ÊÇµ±Ç°Òª²Ù×÷µÄÉÈÇø
                              {
                           if(0!=sexb_cur_sec) //Èç¹ûEXBÕı±»Õ¼ÓÃ
                               {
                            znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //Èç¹ûEXBÖĞ»¹ÓĞÊı¾İ£¬ÔòÏÈ½«ÕâĞ©Êı¾İ»ØĞ´µ½ÆäÏàÓ¦ÉÈ
             -ÇøÖĞ
                               }         
                              }
                         }
                     #endif
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 83  

              
                         Memory_Copy(pexb_buf,pbuf,pfi->File_CurPos);
              
                     #ifndef USE_ALONE_EXB
                         sexb_cur_sec=pfi->File_CurSec;
                         sexb_cur_dev=Dev_No;
                         psexb_cur_oc=pfi; //¼ÇÂ¼EXBÖĞ»º³åµÄÊı¾İÊôÓÚÄÄ¸öÎÄ¼ş
                     #else
                         just_file->exb_cursec=pfi->File_CurSec;
                     #endif
                     #endif
                        }
              
                    pfi->File_CurOffset+=len_temp;
                        pfi->File_Size+=len;
              
                    #ifdef RT_UPDATE_FILESIZE
                        Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
                    #endif
              
                        return len;
                       }
                      }
                      else
                      {
                       temp1=temp/(pInit_Args->BytesPerSector);
              
                       znFAT_Device_Write_nSector(temp1,pfi->File_CurSec,pbuf);
                       pbuf+=temp;
              
                       len_temp-=temp;
              
                       pfi->File_CurSec=SOC(pfi->File_CurClust);
                       pfi->File_CurPos=0;
              
                       pfi->File_CurOffset+=temp;      
                      }
                 }
                 else //µ±Ç°ÉÈÇøÊÇµ±Ç°´Ø×îºóÒ»¸öÉÈÇø
                 {
                      pfi->File_CurSec=SOC(pfi->File_CurClust);
                      pfi->File_CurPos=0;
              
                      pfi->File_CurOffset+=temp;         
                 }   
                }
               }
              
               //Èç¹ûÎÄ¼şµÄµ±Ç°Æ«ÒÆÁ¿ÊÇ´Ø´óĞ¡µÄÕûÊı±¶£¬Ôò
               //Ö±½Ó½øÈë¿ÕÎÄ¼ş¿ªÊ¼Î»ÖÃ»òÕû´ØÎ»ÖÃĞ´Êı¾İµÄ½×¶Î
               WriteData_From_nCluster(pfi,len_temp,pbuf); //´Ó¿ÕÎÄ¼ş¿ªÊ¼Î»ÖÃ»òÕû´ØÎ»ÖÃĞ´Êı¾İ£¬´ËÊ±¶¼ÊÇÒ»ÖÖ¡°¾½¾³´Ø¡±µÄÇ
             -é¿ö
                                                            //ÕâÖÖÇé¿öÏÂ£¬Êı¾İÕıºÃÍ£Ö¹ÓÚÄ©´ØµÄÄ©Î²»òÊÇ¿ÕÎÄ¼ş¶øÃ»ÓĞÊı¾İ£¬
             -Í¨
                                                            //³£ÎÄ¼şĞÅÏ¢¼¯ºÏÖĞ¼ÇÂ¼µÄÎÄ¼şÎ»ÖÃĞÅÏ¢Ó¦¸ÃÊÇÏÂÒ»´ØµÄ×î¿ªÊ¼Î»ÖÃ
             -£¬
                                                            //µ«ÊÇÕâ¸öÊ±ºòÏÂÒ»´ØÉĞÃ»ÓĞ±»·ÖÅä£¬¼´ÎÄ¼şÄ©´ØµÄFAT´ØÏî¼ÇÂ¼µÄÊ
             -Ç
                                                            //0XFFFFFF0F£¨´ØÁ´½áÊø±ê¼Ç£©£¬Òò´Ë´ËÊ±µÄÎÄ¼şÎ»ÖÃĞÅÏ¢ÊÇÎŞĞ§µÄ
                                                            //znFATÖĞ×÷³öÔ¼¶¨:¡°¾½¾³´Ø¡±Çé¿öÏÂ£¬¿ÕÎÄ¼şµ±Ç°´ØÎª0£¬ÔÚÄ©´ØÄ
             -©Î²
                                                            //Ê±£¬µ±Ç°´ØÎªÄ©´Ø¡£ÕâÖÖÔ¼¶¨±ãÓÚznFATµÄÊı¾İĞ´Èë¹¦ÄÜÔÚ¡°¾½¾³´
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 84  

             -Ø¡±
                                                            //Çé¿öÏÂµÄÕıÈ·ĞÔ
               pfi->File_Size+=len;
               
               #ifdef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
              
               return len;
              }
              #endif
5064          
5065          /************************************************************************************
5066           ¹¦ÄÜ£ºÎÄ¼şÊı¾İ½Ø¶Ï
5067           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë offset:Òª½øĞĞÊı¾İ½Ø¶ÏµÄÆğÊ¼Î»ÖÃ
5068           ·µ»Ø£ºÔËĞĞ½á¹û ³É¹¦»òÊ§°Ü 
5069           Ïê½â£º´Ëº¯ÊıÓÃÓÚ½«ÎÄ¼şµÄÊı¾İ´ÓoffsetÎ»ÖÃ½øĞĞ½Ø¶Ï£¬¼´´Ó´ËÎ»ÖÃºóÃæµÄÊı¾İ¾ù±»É¾³ı¡£Èç¹û
5070                 Ö¸¶¨µÄoffsetÈç¹û´óÓÚµÈÓÚÎÄ¼şµÄ´óĞ¡£¬ÔòÖ±½Ó·µ»Ø´íÎó¡£
5071          *************************************************************************************/
5072          #ifdef ZNFAT_DUMP_DATA
              UINT8 znFAT_Dump_Data(struct FileInfo *pfi,UINT32 offset)
              {
               just_file=pfi;
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
              
               if(offset>=(pfi->File_Size)) //Òª½Ø¶ÏµÄÎ»ÖÃ³¬³öÎÄ¼ş·¶Î§
               {
                return ERR_FAIL;
               }
              
               znFAT_Seek(pfi,offset); //¶¨Î»µ½Òª½Ø¶ÏµÄÎ»ÖÃ
              
               #ifndef RT_UPDATE_CLUSTER_CHAIN //Ïú»ÙÖ®Ç°£¬ÏÈ°ÑCCCBÖĞµÄ´ØÁ´¶Î¸üĞÂµ½FAT
               #ifndef USE_ALONE_CCCB
               if(pfi==pcccb_cur_oc) 
               #endif
               {
                CCCB_Update_FAT();
               }
               #endif
              
               Destroy_FAT_Chain(pfi->File_CurClust); //Ïú»Ù´ØÁ´
              
               if(offset>0)
               {
                Modify_FAT(pfi->File_CurClust,0X0FFFFFFF); //´ØÁ´·â¿Ú
               }
              
               pfi->File_Size=offset; //¸üĞÂÎÄ¼ş´óĞ¡
              
               #ifdef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
              
               if(0==pfi->File_Size) Update_File_sClust(pfi,0); //Èç¹ûÎÄ¼ş´óĞ¡Îª0£¬¸üĞÂÎÄ¼ş¿ªÊ¼´ØÎª0
              
               #ifdef RT_UPDATE_FSINFO
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 85  

               Update_FSINFO();
               #endif
              
               return ERR_SUCC;
              }
              #endif
5121          
5122          #ifdef ZNFAT_MODIFY_DATA
5123          UINT32 znFAT_Modify_Data(struct FileInfo *pfi,UINT32 offset,UINT32 len,UINT8 *app_Buffer)
5124          {
5125   1       UINT32 temp_len=0,temp=0,nsec=0,iClu=0,start_clu=0,end_clu=0,next_clu=0,temp2=0,temp1=0;
5126   1       UINT32 Cluster_Size=((pInit_Args->BytesPerSector)*(pInit_Args->SectorsPerClust));
5127   1      
5128   1       if(offset>=(pfi->File_Size)) return ERR_MD_POS_OVER_FSIZE; //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İÎ»ÖÃ³¬³öÎÄ¼ş´óĞ¡
5129   1      
5130   1       if((offset+len)>=(pfi->File_Size))  //´ÓoffsetÎ»ÖÃÒª¸ÄĞ´µÄÊı¾İ³¤¶È³¤ÓÚÎÄ¼ş³¤¶È£¬ÔòÈ¡Êµ¼Ê³¤¶È
5131   1       {
5132   2        len=(pfi->File_Size)-offset;
5133   2        (pfi->File_IsEOF)=1; //´ËÖÖÇé¿öÒ»¶¨»áĞŞ¸Äµ½ÎÄ¼ş×îÄ©Î²£¬ÎÄ¼ş½«´ïµ½½áÊøÎ»ÖÃ
5134   2       }
5135   1      
5136   1       temp_len=len; 
5137   1      
5138   1       znFAT_Seek(pfi,offset); //¶¨Î»ÎÄ¼şoffsetÎ»ÖÃ£¬¶¨Î»Ö®ºóÎÄ¼şĞÅÏ¢ÌåÏà¹Ø±äÁ¿¼´µÃµ½¸üĞÂ
5139   1      
5140   1       //======================================ÏÂÃæ¿ªÊ¼¶ÔÊı¾İ½øĞĞ¸ÄĞ´==================================
5141   1       just_file=pfi;
5142   1      
5143   1       #ifndef RT_UPDATE_CLUSTER_CHAIN //Èç¹ûÊ¹ÓÃÁËCCCB»º³å£¬ÔòĞèÒª´ò¿ªÔÚCCCBÖĞÑ°´ØµÄ±ê¼Ç
               get_next_cluster_in_cccb=1;
               #ifdef USE_ALONE_CCCB //Èç¹ûÊ¹ÓÃÁË¶ÀÁ¢CCCB»º³å£¬Ôò°ÑCCCB´òµ½µ±Ç°Ëù²Ù×÷ÎÄ¼şµÄCCCB
               CCCB_To_Alone();
               #endif
               #endif 
5149   1       //==============================================================================================
5150   1       if(((pfi->File_CurOffset)%Cluster_Size)!=0) //Èç¹ûµ±Ç°Î»ÖÃ·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´²»ÔÚ´Ø¿ªÊ¼Î»ÖÃ
5151   1       {
5152   2        if(((pfi->File_CurOffset)%(pInit_Args->BytesPerSector))!=0) //Èç¹ûµ±Ç°Î»ÖÃ·ÇÕûÉÈÇø´óĞ¡ÕûÊı±¶£¬¼´²»ÔÚÉÈÇø
             -¿ªÊ¼Î»ÖÃ
5153   2        {
5154   3         if(len<=((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İ³¤¶ÈĞ¡ÓÚµÈÓÚÎÄ¼şµ±Ç°ÉÈÇøÊ£
             -ÓàÊı¾İÁ¿
5155   3         {
5156   4              //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
5157   4          #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
                  #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                  if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ¼
             -ÓÃ¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                      {
                       Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                      }
                      else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                      {
                       znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                   Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                   znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                      }
                  #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                      if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄÊı¾İ
             -ÔÚ´ËÎÄ¼şµÄEXBÖĞ
                      {
                       Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 86  

                      }
                      else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                      {
                       znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                   Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                   znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ    
                      }
                  
                  #endif
                  #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
5183   4              znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
5184   4          Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
5185   4          znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
5186   4          
5187   4          #endif
5188   4      
5189   4          //ÒÔÏÂ¸üĞÂÎÄ¼şÎ»ÖÃĞÅÏ¢
5190   4              if(len<((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //ÒªĞŞ¸ÄµÄÊı¾İÁ¿Ğ¡ÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
5191   4              {
5192   5               (pfi->File_CurOffset)+=len;
5193   5               (pfi->File_CurPos)+=len;
5194   5              }
5195   4          else
5196   4              if(len==((pInit_Args->BytesPerSector)-(pfi->File_CurPos))) //ÒªĞŞ¸ÄµÄÊı¾İÁ¿µÈÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
5197   4              {
5198   5           if((len+(pfi->File_CurOffset))==(pfi->File_Size)) //ÕıºÃĞ´µ½ÎÄ¼şÄ©Î²
5199   5               {
5200   6                if(((pfi->File_Size)%Cluster_Size)==0) //Èç¹ûÎÄ¼ş´óĞ¡Îª´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±²úÉúÁË¡°å´Ø¡±
5201   6                {
5202   7                 (pfi->File_CurOffset)+=len;
5203   7                 (pfi->File_CurPos)=0;
5204   7                 (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5205   7                }
5206   6                else //Èç¹ûÎÄ¼ş´óĞ¡·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±Êı¾İĞ´µ½ÁË·Ç´ØÄ©ÉÈÇøÄ©Î²
5207   6                {
5208   7                 (pfi->File_CurOffset)+=len;
5209   7                 (pfi->File_CurPos)=0;
5210   7                 (pfi->File_CurSec)++;
5211   7                }
5212   6               }
5213   5               else
5214   5               {
5215   6                if(((len+(pfi->File_CurOffset))%Cluster_Size)==0) //Èç¹ûĞ´µ½µÄÎ»ÖÃÕıºÃÊÇ´Ø´óĞ¡ÕûÊı±¶£¬¶ø´ËÊ±²¢Ã»ÓĞµ½ÎÄ¼
             -şÄ©Î²
5216   6                {
5217   7                 (pfi->File_CurOffset)+=len;
5218   7                 (pfi->File_CurPos)=0;
5219   7                 (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
5220   7                 (pfi->File_CurSec)=SOC((pfi->File_CurClust));           
5221   7                }
5222   6                else //Èç¹ûĞ´µ½µÄÎ»ÖÃ·Ç´Ø´óĞ¡ÕûÊı±¶£¬¼´´ËÊ±Êı¾İĞ´µ½ÁË·Ç´ØÄ©ÉÈÇøÄ©Î²
5223   6                {
5224   7                 (pfi->File_CurOffset)+=len;
5225   7                 (pfi->File_CurPos)=0;
5226   7                 (pfi->File_CurSec)++;
5227   7                }
5228   6               }
5229   5              }
5230   4              return temp_len;
5231   4         }
5232   3         else //ÒªĞŞ¸ÄµÄÊı¾İ³¤¶È´óÓÚµ±Ç°ÉÈÇøÊ£ÓàÊı¾İÁ¿
5233   3         {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 87  

5234   4              temp=(pInit_Args->BytesPerSector)-(pfi->File_CurPos);
5235   4              znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer);
5236   4          Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,temp);
5237   4              znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer);
5238   4              len-=temp;app_Buffer+=temp;
5239   4          (pfi->File_CurOffset)+=temp;
5240   4      
5241   4              (pfi->File_CurPos)=0;
5242   4      
5243   4          if(!IS_END_SEC_OF_CLU((pfi->File_CurSec),(pfi->File_CurClust))) //Èç¹ûµ±Ç°ÉÈÇø²»ÊÇµ±Ç°´ØµÄ½áÊøÉÈÇø
5244   4              {
5245   5               (pfi->File_CurSec)++;
5246   5              }
5247   4              else
5248   4              {
5249   5               (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
5250   5               (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5251   5              }
5252   4         }
5253   3        }
5254   2      
5255   2        if(((pfi->File_CurOffset)%(Cluster_Size))!=0) //ÕâÀïÔÙ´ÎÅĞ¶Ï´ËÊ±µÄÎ»ÖÃÊÇ·ñÔÚÕû´Ø¿ªÊ¼£¬ÎªÁËºóÃæµÄÍ³Ò»»¯´¦
             -Àí
5256   2        {
5257   3         temp=(((SOC(pfi->File_CurClust))+(pInit_Args->SectorsPerClust)-1)-(pfi->File_CurSec)+1)*(pInit_Args->By
             -tesPerSector);
5258   3      
5259   3         if(len<=temp) //ÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿Ğ¡ÓÚµÈÓÚµ±Ç°ÕûÉÈÇøµÄÊ£ÓàÊı¾İÁ¿
5260   3         {
5261   4          nsec=len/(pInit_Args->BytesPerSector); //¼ÆËãÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿ÖĞµÄÕûÉÈÇøÊı
5262   4          znFAT_Device_Write_nSector(nsec,(pfi->File_CurSec),app_Buffer); //Ïòµ±Ç°´ØÄÚÒªĞŞ¸ÄµÄÕûÉÈÇøÊı¾İ²¿·ÖĞ´Èë
             -Êı¾İ
5263   4          temp=(nsec*(pInit_Args->BytesPerSector));
5264   4          len-=temp;app_Buffer+=temp;
5265   4      
5266   4          (pfi->File_CurOffset)+=temp;
5267   4      
5268   4          if(len==0) //ÒªĞŞ¸ÄµÄÊı¾İÕıºÃĞ´Âúµ±Ç°´Ø
5269   4              {
5270   5           if((pfi->File_CurOffset)==(pfi->File_Size)) //Èç¹ûÕıºÃĞ´µ½ÁËÎÄ¼şÄ©Î²£¬Ôò´ËÊ±²úÉú¡°å´Ø¡±
5271   5               {
5272   6                (pfi->File_CurPos)=0;
5273   6                (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5274   6               }
5275   5           else //Ğ´ÂúÁËµ±Ç°´Ø£¬µ«²¢²»ÊÇÎÄ¼şÄ©Î²
5276   5               {
5277   6                (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
5278   6                (pfi->File_CurPos)=0;
5279   6                (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5280   6               }
5281   5              }
5282   4          else //Ã»ÓĞĞ´Âúµ±Ç°´Ø
5283   4              {
5284   5           (pfi->File_CurPos)=0;
5285   5           (pfi->File_CurSec)+=nsec;
5286   5      
5287   5           //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
5288   5           #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
                   #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                   if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ
             -¼ÓÃ¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                       {
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 88  

                        Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                       }
                   else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                       {
                        znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                    Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                    znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                       }
                   #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                   if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄ
             -Êı¾İÔÚ´ËÎÄ¼şµÄEXBÖĞ
                       {
                        Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
                       }
                   else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                       {
                        znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                    Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                    znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ   
                       }
                 
                   #endif
                   #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
5314   5           znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
5315   5           Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
5316   5           znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
5317   5         
5318   5           #endif
5319   5      
5320   5           (pfi->File_CurOffset)+=len;
5321   5           (pfi->File_CurPos)=len;
5322   5              }
5323   4      
5324   4              return temp_len;
5325   4         }
5326   3         else //ÒªĞŞ¸ÄµÄÊ£ÓàÊı¾İÁ¿´óÓÚµ±Ç°´ØÄÚÊ£ÓàÊı¾İÁ¿
5327   3         {
5328   4          //temp=(pInit_Args->BytesPerSector)-(pfi->File_CurPos);
5329   4          //znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer);
5330   4          //Memory_Copy(znFAT_Buffer,app_Buffer,temp);
5331   4          //znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer);
5332   4          //len-=temp;app_Buffer+=temp;
5333   4          //(pfi->File_CurOffset)+=temp;
5334   4          //(pfi->File_CurSec)++;
5335   4      
5336   4          temp=(((SOC(pfi->File_CurClust))+(pInit_Args->SectorsPerClust)-1)-(pfi->File_CurSec)+1);
5337   4          znFAT_Device_Write_nSector(temp,(pfi->File_CurSec),app_Buffer); //Ïòµ±Ç°´ØÄÚÒªĞŞ¸ÄµÄÕûÉÈÇøÊı¾İ²¿·ÖĞ´Èë
             -Êı¾İ
5338   4              temp*=(pInit_Args->BytesPerSector);
5339   4              len-=temp;app_Buffer+=temp;
5340   4      
5341   4              (pfi->File_CurOffset)+=temp;
5342   4              (pfi->File_CurClust)=Get_Next_Cluster((pfi->File_CurClust));
5343   4              (pfi->File_CurPos)=0;
5344   4              (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5345   4         }
5346   3        }
5347   2       }
5348   1      
5349   1       //¼ÆËã¸÷Á¬Ğø´Ø¶Î£¬ÒÔ¾¡¿ÉÄÜµÄÊ¹ÓÃ¶àÉÈÇøĞ´Çı¶¯£¬ÒÔÌá¸ßÊı¾İĞ´ÈëËÙ¶È
5350   1       //start_cluÓëend_cluÓÃÓÚ¼ÇÂ¼Á¬Ğø´Ø¶ÎµÄÊ¼Ä©
5351   1       temp=(len/Cluster_Size); 
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 89  

5352   1      
5353   1       if(temp>0) //Èç¹ûÕû´ØÊı´óÓÚ0£¬ÔòÉæ¼°µ½¶à´ØĞ´
5354   1       {
5355   2        start_clu=end_clu=(pfi->File_CurClust);
5356   2      
5357   2        for(iClu=1;iClu<temp;iClu++)
5358   2        {
5359   3         next_clu=Get_Next_Cluster(end_clu);
5360   3      
5361   3         if((next_clu-1)==end_clu) //Èç¹ûÁ½¸ö´ØÏàÁÙ£¬¼´Á¬Ğø
5362   3         {
5363   4          end_clu=next_clu;
5364   4         }
5365   3         else //Èç¹ûÁ½¸ö´Ø²»ÏàÁÙ£¬¼´Óöµ½´ØÁ´¶Ïµã
5366   3         {
5367   4          znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Bu
             -ffer);
5368   4          app_Buffer+=((end_clu-start_clu+1)*Cluster_Size);
5369   4          start_clu=next_clu;
5370   4          end_clu=next_clu;
5371   4         }
5372   3        } 
5373   2               
5374   2        temp2=Get_Next_Cluster(end_clu);
5375   2        temp1=(len-temp*Cluster_Size); //ÒªĞŞ¸ÄµÄÊ£ÓàµÄ·ÇÕû´ØÊı¾İ
5376   2           
5377   2        if(temp1==0) //ÒÑÎŞÒªĞŞ¸ÄµÄÊı¾İ£¬¼´ÒªĞŞ¸ÄµÄÊı¾İÕıºÃĞ´µ½Õû´Ø
5378   2        {
5379   3         znFAT_Device_Write_nSector(((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)),SOC(start_clu),app_Buf
             -fer);
5380   3      
5381   3         if(!IS_END_CLU(temp2)) //Èç¹ûÒÑµ½ÁË½áÊø´Ø£¬¼´ÎÄ¼şÒÑµ½Ä©Î²£¬¼´¡°å´Ø¡±
5382   3         {
5383   4          (pfi->File_CurClust)=end_clu;
5384   4         }
5385   3         else
5386   3         {
5387   4          (pfi->File_CurClust)=temp2;    
5388   4         }
5389   3      
5390   3         (pfi->File_CurOffset)+=(temp*Cluster_Size);
5391   3         (pfi->File_CurPos)=0;
5392   3         (pfi->File_CurSec)=SOC((pfi->File_CurClust));
5393   3      
5394   3         return temp_len;
5395   3        }
5396   2        else
5397   2        {
5398   3         if((temp2-1)==end_clu) //ÏÂÒ»´ØÈç¹ûÓëÇ°ÃæÕû´Ø×îºóÒ»´ØÈÔÈ»Á¬Ğø
5399   3         {
5400   4          temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust)+(temp1/(pInit_Args->BytesPerSector))); //Á¬Ğ
             -øÉÈÇøÊı
5401   4          znFAT_Device_Write_nSector(temp,SOC(start_clu),app_Buffer);
5402   4      
5403   4          (pfi->File_CurOffset)+=(temp*(pInit_Args->BytesPerSector));
5404   4      
5405   4          app_Buffer+=(temp*(pInit_Args->BytesPerSector));
5406   4          len-=(temp*(pInit_Args->BytesPerSector));
5407   4         }
5408   3         else //ÏÂÒ»´ØÓëÇ°Ãæ´Ø²»ÔÙÁ¬Ğø
5409   3         {
5410   4          temp=((end_clu-start_clu+1)*(pInit_Args->SectorsPerClust));
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 90  

5411   4          znFAT_Device_Write_nSector(temp,SOC(start_clu),app_Buffer);
5412   4          iClu=(temp*(pInit_Args->BytesPerSector)); //½èÓÃÁÙÊ±±äÁ¿£¬¼õÉÙ¼ÆËãÁ¿
5413   4          app_Buffer+=iClu;len-=iClu;
5414   4          (pfi->File_CurOffset)+=iClu;
5415   4      
5416   4          znFAT_Device_Write_nSector((temp1/(pInit_Args->BytesPerSector)),SOC(temp2),app_Buffer);
5417   4          iClu=((temp1/(pInit_Args->BytesPerSector))*(pInit_Args->BytesPerSector)); //½èÓÃÁÙÊ±±äÁ¿£¬¼õÉÙ¼ÆËãÁ¿
5418   4          app_Buffer+=iClu;len-=iClu;
5419   4          (pfi->File_CurOffset)+=iClu;
5420   4         }
5421   3      
5422   3         (pfi->File_CurClust)=temp2;
5423   3         (pfi->File_CurPos)=0;
5424   3         (pfi->File_CurSec)=SOC(temp2)+(temp1/(pInit_Args->BytesPerSector));
5425   3        }
5426   2       }
5427   1       else
5428   1       {
5429   2              temp=len/(pInit_Args->BytesPerSector);
5430   2              znFAT_Device_Write_nSector(temp,(pfi->File_CurSec),app_Buffer);
5431   2              app_Buffer+=(temp*(pInit_Args->BytesPerSector));
5432   2              len-=(temp*(pInit_Args->BytesPerSector));
5433   2              (pfi->File_CurOffset)+=(temp*(pInit_Args->BytesPerSector));
5434   2               
5435   2              (pfi->File_CurSec)+=temp;
5436   2       }
5437   1      
5438   1       if(len==0) //Èç¹ûÒªĞŞ¸ÄµÄÊı¾İÒÑÎŞ£¬¼´Êı¾İÕıºÃĞ´µ½ÁËÉÈÇøÄ©Î²
5439   1       {
5440   2        return temp_len;
5441   2       }
5442   1       else //Èç¹û»¹ÓĞÊı¾İÒªĞŞ¸Ä£¬×îºóµÄ²»×ãÉÈÇø²¿·Ö
5443   1       {
5444   2        //Èç¹ûÆôÓÃÁËEXB»º³å£¬Ôò´Ë²»×ãÉÈÇøµÄÊı¾İ£¬¿ÉÄÜ²¢²»ÔÚÎïÀíÉÈÇøÖĞ£¬¶øÔÚEXB»º³åÖĞ
5445   2        #ifdef USE_EXCHANGE_BUFFER //Èç¹ûÊ¹ÓÃÁËEXB»º³å
                #ifndef USE_ALONE_EXB //Èç¹ûÃ»ÓĞÆôÓÃ¶ÀÁ¢EXB»º³å£¬¼´ÆôÓÃÁË¹²ÏíEXB»º³å
                if((psexb_cur_oc==pfi)&&(sexb_cur_dev==Dev_No)&&(sexb_cur_sec==(pfi->File_CurSec))) //Èç¹û´ËÊ±ÎÄ¼şÕıÕ¼ÓÃ
             -¹²ÏíEXB£¬Í¬Ê±µ±Ç°ÎÄ¼şËùÔÚµÄÉè±¸ÓëÉÈÇøºÍ¹²ÏíEXBÏà·û
                {
                 Memory_Copy(pexb_buf+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚ¹²ÏíEXBÖĞµÄÊı¾İ
                }
                else //·ñÔòÒªĞŞ¸ÄµÄÊı¾İ²»ÔÚEXBÖĞ£¬¶øÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                 Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                 znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
                }
                #else //Èç¹ûÆô¶¯¶ÀÁ¢EXB»º³å
                if((pfi->exb_cursec)==(pfi->File_CurSec)) //Èç¹û´ËÎÄ¼şµÄEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇøÒ»ÖÂ£¬ÔòËµÃ÷ÒªĞŞ¸ÄµÄÊı¾
             -İÔÚ´ËÎÄ¼şµÄEXBÖĞ
                {
                 Memory_Copy((pfi->exb_buf)+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÎÄ¼ş¶ÀÁ¢EXBÖĞµÄÊı¾İ
                }
                else //Èç¹û´ËÎÄ¼şEXB¶ÔÓ¦ÉÈÇøÓëÎÄ¼şµ±Ç°ÉÈÇø²»Ò»ÖÂ£¬ÒªĞŞ¸ÄµÄÊı¾İÔÚÎïÀíÉÈÇøÖĞ
                {
                 znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
                 Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
                 znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ      
                }
                 
                #endif
                #else //Èç¹ûÃ»ÓĞÊ¹ÓÃEXB»º³å£¬ÔòÖ±½ÓĞŞ¸ÄÎïÀíÉÈÇøÊı¾İ
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 91  

5471   2              
5472   2        znFAT_Device_Read_Sector((pfi->File_CurSec),znFAT_Buffer); //½«ÎÄ¼şµ±Ç°ÉÈÇø¶Á³öµ½ÄÚ²¿»º³å£¬ÒÔ±¸ĞŞ¸Ä
5473   2        Memory_Copy(znFAT_Buffer+(pfi->File_CurPos),app_Buffer,len); //ĞŞ¸ÄÔÚÄÚ²¿»º³åÖĞµÄÊı¾İ
5474   2        znFAT_Device_Write_Sector((pfi->File_CurSec),znFAT_Buffer); //½«Êı¾İ»ØĞ´µ½ÉÈÇøÖĞ
5475   2         
5476   2        #endif
5477   2      
5478   2        (pfi->File_CurOffset)+=len;
5479   2        (pfi->File_CurPos)=len;       
5480   2       
5481   2        return temp_len;
5482   2       }
5483   1      }
5484          #endif
5485          
5486          /************************************************************************************
5487           ¹¦ÄÜ£º¹Ø±ÕÎÄ¼ş
5488           ĞÎ²Î£ºpfi:Ö¸ÏòÎÄ¼şĞÅÏ¢¼¯ºÏµÄÖ¸Õë
5489           ·µ»Ø£º0
5490           Ïê½â£º´Ëº¯ÊıÓÃÓÚ¹Ø±ÕÎÄ¼ş£¬¼´¶ÔÎÄ¼şµÄĞÅÏ¢¼¯ºÏ½øĞĞÇå0£¬Ê¹ÎÄ¼şµÄÏà¹ØĞÅÏ¢µÃÒÔÏú»Ù£¬´Ó¶ø
5491                 ÎŞ·¨ÔÙ¶ÔÆä½øĞĞ²Ù×÷£¬³ı·ÇÖØĞÂ´ò¿ª´ËÎÄ¼ş¡£Óë´ËÍ¬Ê±£¬´Ëº¯Êı»¹ÒÀÕÕRT_UPDATE_FILESIZE
5492                 µÄ¶¨Òå¶ÔÎÄ¼ş´óĞ¡½øĞĞ¸üĞÂ¡£Èç¹ûÃ»ÓĞ¿ªÆôÎÄ¼ş´óĞ¡µÄÊµÊ±¸üĞÂ¹¦ÄÜ£¬ÔòÔÚµ÷ÓÃ´Ëº¯ÊıÊ±
5493                 ½«¶ÔÆä½øĞĞ¸üĞÂ¡£Òò´ËÈç¹ûÃ»ÓĞÊ¹ÓÃÊµÊ±ÎÄ¼ş´óĞ¡¸üĞÂ£¬ÄÇÃ´ÔÚÎÄ¼ş²Ù×÷£¬ÓÈÆäÊÇÊı¾İĞ´Èë
5494                 »òĞŞ¸Ä²Ù×÷Ö®ºó£¬Ò»¶¨Òªµ÷ÓÃclose_fileº¯Êı¡£
5495          *************************************************************************************/
5496          #ifdef ZNFAT_CLOSE_FILE
5497          UINT8 znFAT_Close_File(struct FileInfo *pfi)
5498          {
5499   1       #ifndef RT_UPDATE_FILESIZE
               Update_File_Size(pfi); //¸üÎÄ¼şÄ¿Â¼ÏîÖĞµÄÎÄ¼ş´óĞ¡×Ö¶Î
               #endif
5502   1      
5503   1       just_file=pfi;
5504   1      
5505   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               CCCB_To_Alone();
               #endif
               #endif
5510   1      
5511   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifndef USE_ALONE_CCCB
               if(pfi==pcccb_cur_oc) //Èç¹ûÏÖÔÚ²Ù×÷µÄÕâ¸öÎÄ¼şÕıÕ¼ÓÃCCCB£¬ÔòÔÚ¹Ø±ÕÎÄ¼şÒÔÇ°£¬ĞèÒª½«CCCB¸üĞÂµ½FAT
               #endif
                CCCB_Update_FAT();
               #endif
5517   1      
5518   1       #ifndef RT_UPDATE_CLUSTER_CHAIN
               #ifdef USE_ALONE_CCCB
               pcccb_buf=(UINT32 *)0;
               pcccb_curval=(UINT32 *)0;
               pcccb_counter=(UINT8 *)0;
               #endif
               #endif
5525   1      
5526   1       #ifdef USE_EXCHANGE_BUFFER
               #ifndef USE_ALONE_EXB
               if(pfi==psexb_cur_oc && 0!=(sexb_cur_sec)) //Èç¹ûµ±Ç°EXB±»Õ¼ÓÃ£¬¶øÇÒÊÇÏÖÔÚÒª¹Ø±ÕµÄÎÄ¼ş
               {
                znFAT_Device_Write_Sector(sexb_cur_sec,pexb_buf); //EXB»º³åÊı¾İ»ØĞ´
                sexb_cur_sec=0;
                psexb_cur_oc=(struct FileInfo *)0;
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 92  

                sexb_cur_dev=(UINT8)(-1);
               }
               #else
               pexb_buf=pfi->exb_buf;
               if(0!=pfi->exb_cursec) //Èç¹ûÒª¹Ø±ÕÎÄ¼şµÄEXB±»Õ¼ÓÃ
               {
                znFAT_Device_Write_Sector(pfi->File_CurSec,pexb_buf); //EXB»º³åÊı¾İ»ØĞ´
               }
               pexb_buf=(UINT8 *)0;
               #endif
               #endif
5544   1      
5545   1       Memory_Set((UINT8 *)pfi,(UINT32)sizeof(struct FileInfo),0);
5546   1      
5547   1       just_file=(struct FileInfo *)0;
5548   1      
5549   1       return ERR_SUCC;
5550   1      }
5551          #endif
5552          
5553          /************************************************************************************
5554           ¹¦ÄÜ£º»ñÈ¡Ä³Ò»¸öÎÄ¼ş¼ĞÏÂµÄÎÄ¼şµÄ¸öÊı
5555           ĞÎ²Î£ºÎÄ¼şÊıÁ¿£¬ĞèÒª²éÕÒµÄÎÄ¼şµÄÂ·¾¶
5556           ·µ»Ø£º0±íÊ¾³É¹¦£¬ÆäËûÔòÎª´íÎóÂë
5557           Ïê½â£º
5558          *************************************************************************************/
5559          
5560          #ifdef ADDFAT_FIND_FILE_NUM
5561          UINT8 addFAT_Find_File_Num(UINT32* num,INT8 * dirpath)
5562          {
5563   1              UINT8 result;
5564   1              UINT32 Cur_Cluster=0,fn_pos=0,sec_temp=0;
5565   1              UINT32 iSec=0,iFDI=0;
5566   1              struct FDIesInSEC * pitems;
5567   1              struct FDI *pitem;
5568   1              *num=0;
5569   1              result=znFAT_Enter_Dir(dirpath,&Cur_Cluster,&fn_pos);
5570   1              if(result) return result;
5571   1              do
5572   1              {
5573   2                      sec_temp=SOC(Cur_Cluster);
5574   2                      for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
5575   2                      {
5576   3                              //read one cluster file num
5577   3                              znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
5578   3                              pitems=(struct FDIesInSEC *)znFAT_Buffer;
5579   3                              for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++)
5580   3                              {
5581   4                                      pitem=&(pitems->FDIes[iFDI]);
5582   4                                      if((pitem->Name[0]!=0xE5) && (CHK_ATTR_FILE(pitem->Attributes)) && ('.'!=pitem->Name[0]))//ÅĞ¶ÏÊÇ²»ÊÇÎ
             -Ä¼ş±»É¾³ı£¬ÅÅ³ı.ºÍ..Ä¿Â¼
5583   4                                      {
5584   5                                              *num=*num+1;
5585   5                                      }else if(pitem->Name[0]==0x00)
5586   4                                      {
5587   5                                              break;    //Èç¹û¼ì²âµ½ÊÇ¿ÕµÄ¾Í²»ÔÚ²éÁË£¬Ìø³öÀ´£¬²éÑ¯Íê±Ï
5588   5                                      }
5589   4                              }
5590   3                      }
5591   2                      Cur_Cluster=Get_Next_Cluster(Cur_Cluster); 
5592   2              }
5593   1              while(!IS_END_CLU(Cur_Cluster));
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 93  

5594   1              if(fn_pos==0)
5595   1              {
5596   2                      *num=*num-3;//¸ùÄ¿Â¼´ØÓĞ3*32×Ö½ÚÊÇ¹Ì¶¨µÄ
5597   2              }
5598   1              return ERR_SUCC;
5599   1      }
5600          #endif
5601          
5602          #ifdef ZNFAT_MODIFY_NAME
5603          UINT8 znFAT_Modify_Name(struct FileInfo *pfi,INT8 *old_name_path,INT8 *new_name,UINT32 n,UINT8 is_file)
5604          {
5605   1              UINT8 result=0,flag=0;
5606   1              UINT32 sec_temp=0,Cur_Cluster=0,fn_pos=0,item=0;//fn_posÊÇÎÄ¼şÃûËùÔÚfilenameÖĞµÄÎ»ÖÃ
5607   1              UINT32 iSec=0,iFDI=0;
5608   1              INT8 temp_filename[13];
5609   1              INT8 *filename;
5610   1              UINT8 fn_len=0,i=0,j=0,dot_pos=0,have_dot=0,findFile=0;
5611   1              struct FDIesInSEC *pitems;
5612   1              struct FDI * pitem;
5613   1              just_file=pfi;
5614   1              result=znFAT_Enter_Dir(old_name_path,&Cur_Cluster,&fn_pos); //»ñÈ¡Â·¾¶×îºóÒ»¼¶Ä¿Â¼µÄ¿ªÊ¼´Ø
5615   1              if(result) return result;
5616   1              filename=old_name_path+fn_pos;
5617   1              if(Check_Illegal_Char(filename) || Check_Illegal_Char(new_name)) return ERR_ILL_CHAR; //¼ì²éÎÄ¼şÃûÖĞÊÇ·ñÓ
             -Ğ·Ç·¨×Ö·û£¬ÎŞÂÛ³¤Ãû»¹ÊÇ¶ÌÃû£¬»òÊÇÍ¨ÅäÃû 
5618   1              if(!Is_WildFileName(filename)) //Èç¹û²»ÊÇÍ¨ÅäÎÄ¼şÃû£¬¼´È·¶¨Ãû£¬ÔòĞèÒª½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²â
5619   1              {
5620   2                      if(Check_SFN_Illegal_Length(filename)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
5621   2                      if(Check_SFN_Dot(filename)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
5622   2                      if(Check_SFN_Special_Char(filename)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
5623   2                      if(((UINT8)(-1))==Check_SFN_Illegal_Lower(filename)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
5624   2              }
5625   1              if(!Is_WildFileName(new_name)) //Èç¹û²»ÊÇÍ¨ÅäÎÄ¼şÃû£¬¼´È·¶¨Ãû£¬ÔòĞèÒª½øĞĞÎÄ¼şÃûºÏ·¨ĞÔ¼ì²â
5626   1              {
5627   2                      if(Check_SFN_Illegal_Length(new_name)) return ERR_SFN_ILL_LEN; //¼ì²éSFNÊÇ·ñ·ûºÏ8.3³¤¶È
5628   2                      if(Check_SFN_Dot(new_name)) return ERR_SFN_DOT; //¼ì²éSFNÖĞ.ÊÇ·ñºÏ·¨ 
5629   2                      if(Check_SFN_Special_Char(new_name)) return ERR_SFN_SPEC_CHAR; //¼ì²éSFNÖĞÊÇ·ñÓĞÌØÊâ×Ö·û
5630   2                      if(((UINT8)(-1))==Check_SFN_Illegal_Lower(new_name)) return ERR_SFN_ILL_LOWER; //¼ì²éSFNÖĞÊÇ·ñÓĞ·Ç·¨µÄ´ó
             -Ğ¡Ğ´
5631   2              }
5632   1              do
5633   1              {
5634   2                      sec_temp=SOC(Cur_Cluster);
5635   2                      for(iSec=0;iSec<(pInit_Args->SectorsPerClust);iSec++)
5636   2                      {
5637   3                              znFAT_Device_Read_Sector(sec_temp+(UINT32)iSec,znFAT_Buffer);
5638   3                              pitems=(struct FDIesInSEC *)znFAT_Buffer;
5639   3                              for(iFDI=0;iFDI<NFDI_PER_SEC;iFDI++) //·ÃÎÊÉÈÇøÖĞ¸÷ÎÄ¼şÄ¿Â¼Ïî
5640   3                                      {
5641   4                                                      pitem=&(pitems->FDIes[iFDI]); //Ö¸ÏòÒ»¸öÎÄ¼şÄ¿Â¼ÏîÊı¾İ
5642   4                                                      if((is_file?CHK_ATTR_FILE(pitem->Attributes):CHK_ATTR_DIR(pitem->Attributes)) 
5643   4                                                              && (0XE5!=pitem->Name[0]) && ('.'!=pitem->Name[0])) //ÒÀis_file¼ì²éÊôĞÔ£¬ÇÒÃ»ÓĞ±»É¾³ı
5644   4                                                                                                                                                                      //²»ÊÇ.Óë..
5645   4                                              {
5646   5                                                       To_File_Name((INT8 *)(pitem->Name),temp_filename); //½«FDIÖĞµÄÎÄ¼şÃû×Ö¶Î×ªÎª8.3ÎÄ¼şÃû
5647   5                                                        if(!SFN_Match(filename,temp_filename)) //¶ÌÎÄ¼şÃûÍ¨Åä
5648   5                                                        {
5649   6                                                         if(n==item)
5650   6                                                         {
5651   7                                                              Analyse_FDI(pfi,pitem); //½âÎöÆ¥ÅäµÄÎÄ¼şÄ¿Â¼Ïî
5652   7                                                              pfi->FDI_Sec=sec_temp+iSec; //ÎÄ¼şÄ¿Â¼ÏîËùÔÚµÄÉÈÇø
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 94  

5653   7                                                              pfi->nFDI=(UINT8)iFDI; //ÎÄ¼şÄ¿Â¼ÏîÔÚÉÈÇøÖĞµÄË÷Òı
5654   7                                                              //return ERR_SUCC;
5655   7                                                              findFile=1;
5656   7                                                         } 
5657   6                                                         flag=1;
5658   6                                                        }
5659   5                                                       if(flag) {item++;flag=0;} 
5660   5                                                       if(!SFN_Match(new_name,temp_filename)) //Æ¥Åäµ½ÁË
5661   5                                                       {
5662   6                                                              return ERR_FDI_ALREADY_EXISTING;
5663   6                                                       }
5664   5                                              }
5665   4                                      }
5666   3                      }
5667   2               Cur_Cluster=Get_Next_Cluster(Cur_Cluster); //»ñÈ¡ÏÂÒ»´Ø
5668   2              }while(!IS_END_CLU(Cur_Cluster));
5669   1              //ĞŞ¸ÄÔÚÕâÀï¸Ä
5670   1              if(findFile==0) return ERR_NO_FILE;
5671   1              znFAT_Device_Read_Sector((unsigned long)pfi->FDI_Sec,znFAT_Buffer);//¶ÁÈ¡ÉÈÇø
5672   1              pitems=(struct FDIesInSEC*)znFAT_Buffer;
5673   1              pitem=&(pitems->FDIes[pfi->nFDI]);
5674   1              //pitem->Name=;
5675   1              //pitem->Extension=;
5676   1              fn_len=(UINT8)StringLen(new_name);
5677   1              for(i=(UINT8)(fn_len-1);i>0;i--) //·´ÏòÑ°ÕÒ. µÚÒ»¸ö.ÊÇÖ÷ÎÄ¼şÓëÀ©Õ¹ÃûµÄ·Ö½ç
5678   1              {
5679   2                if('.'==new_name[i]) 
5680   2                {
5681   3                 dot_pos=i;
5682   3                 have_dot=1;
5683   3                 break;
5684   3                }
5685   2              }
5686   1               if(have_dot) //Èç¹ûÓĞµã
5687   1               {
5688   2                        //ÌîÈëÖ÷ÎÄ¼şÃû
5689   2                        for(i=0;i<dot_pos;i++)
5690   2                        {
5691   3                         (pitem->Name)[i]=(INT8)Lower2Up(new_name[i]); //×ªÎª´óĞ´
5692   3                        }
5693   2                        for(;i<8;i++)
5694   2                        {
5695   3                         (pitem->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
5696   3                        }
5697   2      
5698   2                        //ÌîÈëÀ©Õ¹Ãû
5699   2                        for(i=(UINT8)(dot_pos+1);i<fn_len;i++)
5700   2                        {
5701   3                         (pitem->Extension)[j]=(UINT8)Lower2Up(new_name[i]); //×ªÎª´óĞ´
5702   3                         j++;
5703   3                        }
5704   2                        for(;j<3;j++)
5705   2                        {
5706   3                         (pitem->Extension)[j]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
5707   3                        }
5708   2               }
5709   1                else //Èç¹ûÃ»ÓĞµã
5710   1               {
5711   2                        //ÌîÈëÖ÷ÎÄ¼şÃû
5712   2                        for(i=0;i<fn_len;i++)
5713   2                        {
5714   3                         (pitem->Name)[i]=(UINT8)Lower2Up(new_name[i]); //×ªÎª´óĞ´
C51 COMPILER V9.54   ZNFAT                                                                 05/29/2018 20:45:21 PAGE 95  

5715   3                        }
5716   2                        for(;i<8;i++)
5717   2                        {
5718   3                         (pitem->Name)[i]=' '; //²»×ã8×Ö½Ú²¿·ÖÌîÈë¿Õ¸ñ
5719   3                        } 
5720   2                        
5721   2                        //ÌîÈëÀ©Õ¹Ãû
5722   2                        for(j=0;j<3;j++)
5723   2                        {
5724   3                         (pitem->Extension)[j]=' '; //À©Õ¹ÃûÌîÈë¿Õ¸ñ
5725   3                        }
5726   2               }
5727   1              znFAT_Device_Write_Sector((unsigned long)pfi->FDI_Sec,znFAT_Buffer);//¶ÁÈ¡ÉÈÇø
5728   1              return ERR_SUCC;
5729   1      }
5730          #endif
5731          
5732          
5733          /************************************************************************************
5734           ¹¦ÄÜ£ºË¢ĞÂÎÄ¼şÏµÍ³
5735           ĞÎ²Î£ºÎŞ
5736           ·µ»Ø£º0
5737           Ïê½â£ºÔÚÎÒÃÇ½øĞĞÁËÎÄ¼ş²Ù×÷Ö®ºó£¬±ÈÈç´´½¨ÎÄ¼ş»òÄ¿Â¼£¬ÏòÎÄ¼şÖĞĞ´ÈëÊı¾İ£¬»òÊÇÉ¾³ı²Ù×÷£¬
5738                 ¶¼»áÓ°Ïìµ½ÎÄ¼şÏµÍ³±¾ÉíµÄÒ»Ğ©²ÎÊı£¬±ÈÈç´ÅÅÌµÄÊ£ÓàÈİÁ¿µÈ¡£znFATÖĞ¿ÉÒÔÍ¨¹ı´ò¿ª
5739                 RT_UPDATE_FSINFOÕâ¸öºêÀ´Æô¶¯ÎÄ¼şÏµÍ³ÊµÊ±¸üĞÂ¹¦ÄÜ£¬ÈÎºÎµÄÔö¼ÓÉ¾¸Ä²Ù×÷znFAT¶¼»á
5740                 Á¢¼´¸üĞÂÎÄ¼şÏµÍ³¡£µ«ÕâÑù»á±»Êı¾İĞ´ÈëµÈ²Ù×÷Ğ§ÂÊ½µµÍ£¬Òò´Ë¿ÉÒÔÆÁ±ÎµôÕâÒ»ÊµÊ±¸üĞÂ
5741                 ¹¦ÄÜ£¬µ«ÊÇ±ØĞëÔÚËùÓĞÎÄ¼ş²Ù×÷½áÊøÖ®ºó£¬µ÷ÓÃ´Ëº¯ÊıÀ´Ë¢ĞÂÎÄ¼şÏµÍ³¡£
5742          *************************************************************************************/
5743          #ifdef ZNFAT_FLUSH_FS
5744          UINT8 znFAT_Flush_FS(void)
5745          {
5746   1       #ifndef RT_UPDATE_FSINFO
               Update_FSINFO(); //¸üĞÂÎÄ¼şÏµÍ³ĞÅÏ¢
               #endif
5749   1      
5750   1       return ERR_SUCC; 
5751   1      }
5752          #endif
5753                                                 


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =  28660    ----
   CONSTANT SIZE    =     11    ----
   XDATA SIZE       =    522     613
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
